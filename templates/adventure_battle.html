{% extends "base.html" %}

{% block title %}ì „íˆ¬ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pokemon_battle.css') }}">
<div class="pokemon-battle-container">
    <!-- ìƒë‹¨: ì  ëª¬ìŠ¤í„° (ì˜¤ë¥¸ìª½), ì  ëŒ€ì‚¬ (ì™¼ìª½) -->
    <div class="battle-arena">
        <!-- ì  ëŒ€ì‚¬ ì¹´ë“œ (ì™¼ìª½) -->
        <div class="enemy-dialogue-card">
            <div class="dialogue-content">
                <p id="enemy-dialogue-text">{{ battle_state.enemy_dialogue }}</p>
            </div>
        </div>

        <!-- ì  ëª¬ìŠ¤í„° (ì˜¤ë¥¸ìª½) -->
        <div class="enemy-position">
            <div class="enemy-card">
                <div class="enemy-header">
                    <div class="monster-name-tag">
                        <span class="name">{{ battle_state.enemy_monster.name }}</span>
                        <span class="rarity-badge" style="background-color: 
                            {% if battle_state.enemy_monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif battle_state.enemy_monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif battle_state.enemy_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ battle_state.enemy_monster.rarity }}
                        </span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-item">âš”ï¸ {{ battle_state.enemy_monster.attack }}</span>
                    </div>
                </div>
                <div class="hp-bar-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar">
                        <div class="hp-fill enemy-hp" style="width: {{ (battle_state.enemy_monster.current_hp / battle_state.enemy_monster.max_hp * 100)|int }}%"></div>
                    </div>
                    <div class="hp-text"><span id="enemy-hp">{{ battle_state.enemy_monster.current_hp }}</span>/{{ battle_state.enemy_monster.max_hp }}</div>
                </div>
                <div class="enemy-image-container">
                    <img src="{{ battle_state.enemy_monster.image }}" alt="{{ battle_state.enemy_monster.name }}" class="enemy-monster-image">
                </div>
            </div>
        </div>

        <!-- ì¤‘ì•™: ì „íˆ¬ ì •ë³´ ë° ë¡œê·¸ -->
        <div class="battle-log-section">
            <div class="progress-info">
                <div class="stage-progress">ìŠ¤í…Œì´ì§€: {{ battle_state.stage_id }} / 200</div>
                <div class="stage-name-small">{{ battle_state.stage_name }}</div>
            </div>
            <div class="log-container" id="battle-log">
                {% for log in battle_state.log %}
                <p class="log-entry">{{ log }}</p>
                {% endfor %}
            </div>
            <div class="turn-indicator">
                <span class="turn-label">í„´: <span id="turn-count">{{ battle_state.turn }}</span></span>
                <span id="turn-badge" class="{% if battle_state.player_turn %}player-turn-badge{% else %}enemy-turn-badge{% endif %}">
                    {% if battle_state.player_turn %}ë‚˜ì˜ í„´!{% else %}ì ì˜ í„´...{% endif %}
                </span>
            </div>
        </div>

        <!-- ë‚´ ëª¬ìŠ¤í„° (ì™¼ìª½) -->
        <div class="player-position">
            <div class="player-card">
                <div class="player-header">
                    <div class="monster-name-tag">
                        <span class="name">{{ battle_state.player_monster.name }}</span>
                        <span class="rarity-badge" style="background-color: 
                            {% if battle_state.player_monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif battle_state.player_monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif battle_state.player_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ battle_state.player_monster.rarity }}
                        </span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-item">âš”ï¸ {{ battle_state.player_monster.attack }}</span>
                    </div>
                </div>
                <div class="hp-bar-container">
                    <div class="hp-label">HP</div>
                    <div class="hp-bar">
                        <div class="hp-fill player-hp" style="width: {{ (battle_state.player_monster.current_hp / battle_state.player_monster.max_hp * 100)|int }}%"></div>
                    </div>
                    <div class="hp-text"><span id="player-hp">{{ battle_state.player_monster.current_hp }}</span>/{{ battle_state.player_monster.max_hp }}</div>
                </div>
                <div class="player-image-container">
                    <img src="{{ battle_state.player_monster.image }}" alt="{{ battle_state.player_monster.name }}" class="player-monster-image">
                </div>
            </div>
        </div>

        <!-- ë‚´ ëŒ€ì‚¬ ì¹´ë“œ (ì˜¤ë¥¸ìª½) -->
        <div class="player-dialogue-card">
            <div class="dialogue-content">
                <p id="player-dialogue-text">{{ battle_state.player_dialogue }}</p>
            </div>
        </div>
    </div>

    <!-- ê¸°ìˆ  ì„ íƒ ì˜ì—­ -->
    <div class="skill-selection-area" id="skill-selection">
        <h6 class="skill-title">ğŸ® ê¸°ìˆ  ì„ íƒ</h6>
        <div class="skills-grid">
            {% for skill in battle_state.player_skills %}
            <button class="skill-button" 
                    data-skill="{{ skill }}"
                    onclick="useSkill('{{ skill }}')"
                    {% if not battle_state.player_turn %}disabled{% endif %}
                    title="{{ skill_descriptions.get(skill, 'ê¸°ìˆ  ì„¤ëª… ì—†ìŒ') }}">
                <div class="skill-emoji">
                    {% if skill == 'ë°•ì¹˜ê¸°' %}âš”ï¸
                    {% elif skill == 'ìŠ¤ë§¤ì‹œ' %}ğŸ’¥
                    {% elif skill == 'ê²€ì€ë¹›' %}ğŸŒ‘
                    {% elif skill == 'ìŠ¤í•€ì–´íƒ' %}ğŸŒªï¸
                    {% elif skill == 'ë¶ˆì˜í­ë°œ' %}ğŸ”¥
                    {% elif skill == 'ë¹™ê²°ì˜ì¹¼' %}â„ï¸
                    {% elif skill == 'ë²ˆê°œì°¸ê²©' %}âš¡
                    {% elif skill == 'ê¶ê·¹ë² ê¸°' %}âš¡
                    {% elif skill == 'ì¤‘ë ¥íŒŒë™' %}ğŸŒ€
                    {% else %}ğŸ’«{% endif %}
                </div>
                <div class="skill-name">{{ skill }}</div>
                <div class="skill-effect">{{ skill_effects.get(skill, '') }}</div>
            </button>
            {% endfor %}
            <!-- ë¹ˆ ì¹¸ (2x2 ê·¸ë¦¬ë“œ ìœ ì§€) -->
            {% set skill_count = battle_state.player_skills|length %}
            {% for i in range(4 - skill_count) %}
            <div class="skill-button-empty"></div>
            {% endfor %}
        </div>
        <div class="action-buttons">
            <form method="POST" action="{{ url_for('adventure_escape') }}" class="d-inline">
                <button type="submit" class="btn-escape">ë„ë§ì¹˜ê¸°</button>
            </form>
        </div>
    </div>
</div>

<!-- ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ -->
<div class="game-over-modal hidden" id="game-over-modal">
    <div class="game-over-content">
        <div class="game-over-badge" id="game-over-badge"></div>
        <p class="game-over-message" id="game-over-message"></p>
        <a href="{{ url_for('adventure') }}" class="btn-return">ëª¨í—˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
</div>

<script>
const initialBattleState = {{ battle_state|tojson }};
let battleState = JSON.parse(JSON.stringify(initialBattleState));

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì ì˜ í„´ì´ë©´ ìë™ ê³µê²©
document.addEventListener('DOMContentLoaded', function() {
    if (!battleState.game_over && !battleState.player_turn) {
        setTimeout(() => {
            executeEnemyTurn();
        }, 1500);
    }
});

function useSkill(skillName) {
    const buttons = document.querySelectorAll('.skill-button');
    buttons.forEach(btn => btn.disabled = true);
    
    fetch('{{ url_for("adventure_use_skill", skill_name="") }}' + skillName, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateBattleUI(data.battle_state);
            
            if (data.game_over) {
                if (data.winner === 'player') {
                    showGameOver('victory', 'ğŸ‰ ìŠ¹ë¦¬!', data.battle_state.player_dialogue);
                } else {
                    showGameOver('defeat', 'ğŸ’€ íŒ¨ë°°', data.battle_state.enemy_dialogue);
                }
            } else if (!data.battle_state.player_turn) {
                // ì ì˜ í„´ìœ¼ë¡œ ì§„í–‰
                setTimeout(() => {
                    executeEnemyTurn();
                }, 1500);
            } else {
                // í”Œë ˆì´ì–´ í„´ì´ë¯€ë¡œ ë²„íŠ¼ í™œì„±í™”
                enableSkillButtons();
            }
        } else {
            alert(data.message);
            enableSkillButtons();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        enableSkillButtons();
    });
}

function executeEnemyTurn() {
    fetch('{{ url_for("adventure_enemy_turn") }}', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateBattleUI(data.battle_state);
            
            if (data.game_over) {
                if (data.winner === 'player') {
                    showGameOver('victory', 'ğŸ‰ ìŠ¹ë¦¬!', data.battle_state.player_dialogue);
                } else {
                    showGameOver('defeat', 'ğŸ’€ íŒ¨ë°°', data.battle_state.enemy_dialogue);
                }
            } else {
                // í”Œë ˆì´ì–´ í„´ì´ë¯€ë¡œ ë²„íŠ¼ í™œì„±í™”
                enableSkillButtons();
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        enableSkillButtons();
    });
}

function updateBattleUI(newBattleState) {
    battleState = newBattleState;
    
    // HP ì—…ë°ì´íŠ¸
    document.getElementById('player-hp').textContent = battleState.player_monster.current_hp;
    document.getElementById('enemy-hp').textContent = battleState.enemy_monster.current_hp;
    
    // HP ë°” ì—…ë°ì´íŠ¸
    const playerHpPercent = (battleState.player_monster.current_hp / battleState.player_monster.max_hp * 100);
    const enemyHpPercent = (battleState.enemy_monster.current_hp / battleState.enemy_monster.max_hp * 100);
    
    document.querySelector('.hp-fill.player-hp').style.width = playerHpPercent + '%';
    document.querySelector('.hp-fill.enemy-hp').style.width = enemyHpPercent + '%';
    
    // í„´ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('turn-count').textContent = battleState.turn;
    const turnBadge = document.getElementById('turn-badge');
    if (battleState.player_turn) {
        turnBadge.textContent = 'ë‚˜ì˜ í„´!';
        turnBadge.className = 'player-turn-badge';
    } else {
        turnBadge.textContent = 'ì ì˜ í„´...';
        turnBadge.className = 'enemy-turn-badge';
    }
    
    // ë¡œê·¸ ì—…ë°ì´íŠ¸
    const logContainer = document.getElementById('battle-log');
    logContainer.innerHTML = '';
    battleState.log.forEach(logEntry => {
        const p = document.createElement('p');
        p.className = 'log-entry';
        p.textContent = logEntry;
        logContainer.appendChild(p);
    });
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // ëŒ€ì‚¬ ì—…ë°ì´íŠ¸
    document.getElementById('player-dialogue-text').textContent = battleState.player_dialogue;
    document.getElementById('enemy-dialogue-text').textContent = battleState.enemy_dialogue;
}

function enableSkillButtons() {
    const buttons = document.querySelectorAll('.skill-button[data-skill]');
    buttons.forEach(btn => {
        btn.disabled = false;
    });
}

function showGameOver(type, title, message) {
    const modal = document.getElementById('game-over-modal');
    const badge = document.getElementById('game-over-badge');
    const messageEl = document.getElementById('game-over-message');
    
    badge.className = 'game-over-badge ' + type;
    badge.textContent = title;
    messageEl.textContent = message;
    
    modal.classList.remove('hidden');
}
</script>
{% endblock %}
