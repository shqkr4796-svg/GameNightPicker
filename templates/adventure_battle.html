{% extends "base.html" %}

{% block title %}ëª¨í—˜ ì „íˆ¬ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<!-- íš¨ê³¼ìŒ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="{{ url_for('static', filename='js/adventure_sound.js') }}"></script>
<div class="container-fluid" style="background-color: #1a1a1a; min-height: 100vh; padding: 15px; color: white;">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- ìŠ¤í…Œì´ì§€ ì •ë³´ (ê°„ì†Œí™”) -->
            <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                <h5 style="font-weight: 700; letter-spacing: 2px; margin-bottom: 3px;">{{ battle_state.stage_name }}</h5>
                <p style="color: #999; font-size: 0.8rem; margin: 0;">{{ battle_state.difficulty }}</p>
            </div>

            <!-- ëª¬ìŠ¤í„° ì „íˆ¬ í™”ë©´ (ìƒë‹¨ ì , í•˜ë‹¨ í”Œë ˆì´ì–´) -->
            <div style="margin-bottom: 15px; position: relative; min-height: 240px;">
                <!-- ì  ëª¬ìŠ¤í„° (ì˜¤ë¥¸ìª½ ìƒë‹¨) -->
                <div style="position: absolute; top: 0; right: 0; width: 80%; transform: scale(0.75); transform-origin: top right;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">ìƒëŒ€</div>
                        <div style="background-color: #2a2a2a; border-radius: 6px; padding: 12px 15px; border: 2px solid #444; display: flex; gap: 12px; flex-direction: row-reverse; position: relative;">
                            <!-- ë‚¨ì€ ì  ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ (ë™ê·¸ë¼ë¯¸ ê°œìˆ˜) -->
                            <div style="position: absolute; top: -12px; left: 0; display: flex; gap: 3px; flex-wrap: wrap;">
                                {% for i in range(battle_state.enemy_count - battle_state.defeated_monsters) %}
                                    <img src="{{ url_for('static', filename='images/health_circle.png') }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">
                                {% endfor %}
                            </div>
                            <!-- ì  ëª¬ìŠ¤í„° ì´ë¯¸ì§€ -->
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #333 0%, #1a1a1a 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                {% if battle_state.enemy_monster.image %}
                                    <img id="enemyMonsterImg" src="{{ battle_state.enemy_monster.image }}" alt="{{ battle_state.enemy_monster.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <div id="enemyMonsterImg" style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                        {% set rarity_emoji = {'ë ˆì–´': 'ğŸ”´', 'ì—í”½': 'ğŸŸ ', 'ìœ ë‹ˆí¬': 'ğŸŸ£', 'ë ˆì „ë“œë¦¬': 'ğŸ’œ', 'ì‹ í™”ê¸‰': 'â­'} %}
                                        {{ rarity_emoji.get(battle_state.enemy_monster.rarity, '') }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- ì  ëª¬ìŠ¤í„° ì •ë³´ -->
                            <div style="flex: 1; text-align: left;">
                                <h6 style="font-weight: 700; margin-bottom: 3px; font-size: 0.9rem;">{{ battle_state.enemy_monster.name }}</h6>
                                <p style="color: #999; font-size: 0.65rem; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">{{ battle_state.enemy_monster.rarity }}</p>
                                
                                <!-- HP ë°” -->
                                <div style="margin-bottom: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                        <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">HP</span>
                                        <span style="color: white; font-weight: 700; font-size: 0.65rem;">{{ battle_state.enemy_monster.current_hp }} / {{ battle_state.enemy_monster.max_hp }}</span>
                                    </div>
                                    <div style="width: 100%; height: 4px; background-color: #333; border-radius: 3px; overflow: hidden; border: 1px solid #444;">
                                        <div id="enemyHpBar" style="height: 100%; width: {{ (battle_state.enemy_monster.current_hp / battle_state.enemy_monster.max_hp * 100) }}%; background: linear-gradient(90deg, #FF6B6B, #ee5a52); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                
                                <!-- ê³µê²©ë ¥ -->
                                <div style="background-color: #333; padding: 4px 8px; border-radius: 4px; border: 1px solid #444;">
                                    <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">ATK</span>
                                    <span style="color: #FF6B6B; font-weight: 700; margin-left: 8px; font-size: 0.7rem;">{{ battle_state.enemy_monster.attack }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° (ì™¼ìª½ í•˜ë‹¨) -->
                <div style="position: absolute; bottom: 0; left: 0; width: 80%; transform: scale(0.75); transform-origin: bottom left;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">í”Œë ˆì´ì–´</div>
                        <div style="background-color: #2a2a2a; border-radius: 6px; padding: 12px 15px; border: 2px solid #444; display: flex; gap: 12px; position: relative;">
                            <!-- ë‚¨ì€ í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ (ë™ê·¸ë¼ë¯¸ ê°œìˆ˜) -->
                            <div style="position: absolute; top: -12px; left: 0; display: flex; gap: 3px; flex-wrap: wrap;">
                                {% for i in range(battle_state.player_team|length - battle_state.current_team_index) %}
                                    <img src="{{ url_for('static', filename='images/health_circle.png') }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">
                                {% endfor %}
                            </div>
                            <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì´ë¯¸ì§€ -->
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #333 0%, #1a1a1a 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                {% if battle_state.player_monster.image %}
                                    <img id="playerMonsterImg" src="{{ battle_state.player_monster.image }}" alt="{{ battle_state.player_monster.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <div id="playerMonsterImg" style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                        {% set rarity_emoji = {'ë ˆì–´': 'ğŸ”´', 'ì—í”½': 'ğŸŸ ', 'ìœ ë‹ˆí¬': 'ğŸŸ£', 'ë ˆì „ë“œë¦¬': 'ğŸ’œ', 'ì‹ í™”ê¸‰': 'â­'} %}
                                        {{ rarity_emoji.get(battle_state.player_monster.rarity, '') }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì •ë³´ -->
                            <div style="flex: 1; text-align: left;">
                                <h6 style="font-weight: 700; margin-bottom: 3px; font-size: 0.9rem;">{{ battle_state.player_monster.name }}</h6>
                                <p style="color: #999; font-size: 0.65rem; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">{{ battle_state.player_monster.rarity }}</p>
                                
                                <!-- HP ë°” -->
                                <div style="margin-bottom: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                        <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">HP</span>
                                        <span style="color: white; font-weight: 700; font-size: 0.65rem;">{{ battle_state.player_monster.current_hp }} / {{ battle_state.player_monster.max_hp }}</span>
                                    </div>
                                    <div style="width: 100%; height: 4px; background-color: #333; border-radius: 3px; overflow: hidden; border: 1px solid #444;">
                                        <div id="playerHpBar" style="height: 100%; width: {{ (battle_state.player_monster.current_hp / battle_state.player_monster.max_hp * 100) }}%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                
                                <!-- ê³µê²©ë ¥ -->
                                <div style="background-color: #333; padding: 4px 8px; border-radius: 4px; border: 1px solid #444;">
                                    <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">ATK</span>
                                    <span style="color: #4CAF50; font-weight: 700; margin-left: 8px; font-size: 0.7rem;">{{ battle_state.player_monster.attack }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì „íˆ¬ ë¡œê·¸ (ì¤„ì„) -->
            <div style="background-color: #2a2a2a; border-radius: 6px; padding: 10px; margin-bottom: 15px; border: 1px solid #444; max-height: 90px; overflow-y: auto;">
                <div style="font-size: 0.7rem; color: #999; line-height: 1.4;">
                    {% for log_line in battle_state.log[-10:] %}
                        <div style="margin-bottom: 2px; color: {% if 'í”Œë ˆì´ì–´' in log_line %}#4CAF50{% elif 'ì ' in log_line %}#FF6B6B{% else %}#bbb{% endif %};">
                            > {{ log_line }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ê¸°ìˆ  ì„ íƒ (ê²Œì„ ì§„í–‰ ì¤‘) -->
            {% if not battle_state.game_over %}
                <div id="actionContainer">
                    {% if battle_state.player_turn %}
                        <div style="text-align: center; margin-bottom: 15px;">
                            <p style="color: #999; font-size: 0.85rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 0 auto;">
                                <!-- ìŠ¬ë¡¯ 1 -->
                                <div>
                                    {% if battle_state.player_skills|length > 0 %}
                                        {% set skill_name = battle_state.player_skills[0] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-0" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                                <!-- ìŠ¬ë¡¯ 2 -->
                                <div>
                                    {% if battle_state.player_skills|length > 1 %}
                                        {% set skill_name = battle_state.player_skills[1] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-1" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                                <!-- ìŠ¬ë¡¯ 3 -->
                                <div>
                                    {% if battle_state.player_skills|length > 2 %}
                                        {% set skill_name = battle_state.player_skills[2] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-2" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                                <!-- ìŠ¬ë¡¯ 4 -->
                                <div>
                                    {% if battle_state.player_skills|length > 3 %}
                                        {% set skill_name = battle_state.player_skills[3] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-3" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                            </div>
                            <p style="color: #999; font-size: 0.7rem; margin-top: 8px;">í´ë¦­ìœ¼ë¡œ ì •ë³´ ë³´ê¸°, ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‚¬ìš©</p>
                        </div>
                    {% else %}
                        <div style="text-align: center; padding: 15px; background-color: #2a2a2a; border-radius: 6px; color: #999; border: 1px solid #444;">
                            <p style="font-size: 0.85rem; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">ì ì˜ í„´ì…ë‹ˆë‹¤...</p>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <!-- ì „íˆ¬ ì¢…ë£Œ -->
                <div style="text-align: center;">
                    {% if battle_state.winner == 'player' %}
                        <div style="background-color: #1a3a1a; border: 2px solid #4CAF50; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #4CAF50; font-weight: 700; margin-bottom: 12px; font-size: 1.3rem; text-transform: uppercase; letter-spacing: 2px;">ìŠ¹ë¦¬!</h4>
                            <p style="color: #bbb; margin-bottom: 15px; font-size: 0.9rem;">ìŠ¤í…Œì´ì§€ {{ battle_state.stage_id }}ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</p>
                            <a href="{{ url_for('adventure') }}" class="btn" style="background-color: #4CAF50; color: white; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; transition: background-color 0.3s; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#45a049'" onmouseout="this.style.backgroundColor='#4CAF50'">
                                ê³„ì†í•˜ê¸°
                            </a>
                        </div>
                    {% else %}
                        <div style="background-color: #3a1a1a; border: 2px solid #FF6B6B; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #FF6B6B; font-weight: 700; margin-bottom: 12px; font-size: 1.3rem; text-transform: uppercase; letter-spacing: 2px;">íŒ¨ë°°</h4>
                            <p style="color: #bbb; margin-bottom: 15px; font-size: 0.9rem;">ìŠ¤í…Œì´ì§€ {{ battle_state.stage_id }}ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤.</p>
                            <a href="{{ url_for('adventure') }}" class="btn" style="background-color: #FF6B6B; color: white; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; transition: background-color 0.3s; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#ee5a52'" onmouseout="this.style.backgroundColor='#FF6B6B'">
                                ë‹¤ì‹œ ì‹œë„
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ê¸°ìˆ  ì •ë³´ ëª¨ë‹¬ -->
<div id="skillModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; padding: 20px;">
    <div style="background-color: #2a2a2a; border-radius: 8px; padding: 20px; max-width: 400px; margin: auto; margin-top: 50px; border: 2px solid #555; color: white;">
        <h5 id="modalSkillName" style="color: #bbb; font-weight: 700; margin-bottom: 15px; font-size: 1.1rem; text-transform: uppercase;"></h5>
        
        <div style="background-color: #333; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <p id="modalSkillDesc" style="font-size: 0.85rem; color: #ccc; margin: 0; line-height: 1.5;"></p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="background-color: #333; padding: 10px; border-radius: 6px; text-align: center;">
                <p style="color: #999; font-size: 0.7rem; margin-bottom: 5px;">ë“±ê¸‰</p>
                <p id="modalSkillRarity" style="color: #bbb; font-weight: 700; margin: 0;"></p>
            </div>
            <div style="background-color: #333; padding: 10px; border-radius: 6px; text-align: center;">
                <p style="color: #999; font-size: 0.7rem; margin-bottom: 5px;">ë°ë¯¸ì§€</p>
                <p id="modalSkillDamage" style="color: #bbb; font-weight: 700; margin: 0;"></p>
            </div>
        </div>
        
        <div id="skillUseContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="closeSkillModal(); useSkill(currentSkill)" class="btn w-100" style="background-color: #4CAF50; color: white; border: none; border-radius: 6px; padding: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#45a049'" onmouseout="this.style.backgroundColor='#4CAF50'">
                ì‚¬ìš©
            </button>
            <button onclick="closeSkillModal(); deleteSkill(currentSkill)" id="deleteSkillBtn" class="btn w-100" style="background-color: #FF6B6B; color: white; border: none; border-radius: 6px; padding: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#ee5a52'" onmouseout="this.style.backgroundColor='#FF6B6B'">
                ì‚­ì œ
            </button>
        </div>
        
        <button onclick="closeSkillModal()" class="btn w-100" style="background-color: #333; color: #999; border: 1px solid #555; border-radius: 6px; padding: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem; margin-top: 10px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<script>
let currentSkill = '';
const skillsInfo = {{ skills_info | tojson }};
const playerSkills = {{ battle_state.player_skills | tojson }};
const skillUsage = {{ skill_usage | tojson }};
const skillMaxUses = {{ skill_max_uses | tojson }};
const currentPlayerRarity = '{{ battle_state.player_monster.rarity }}';
let skillButtonClickCount = { 0: 0, 1: 0, 2: 0, 3: 0 };

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ê²½ìŒì•… ì‹œì‘ ë° ì „íˆ¬ ì‹œì‘ ìŒí–¥
window.addEventListener('load', function() {
    setTimeout(() => {
        adventureSound.playBattleStartSound();
        adventureSound.playBackgroundMusic();
    }, 300);
});

function showSkillInfo(skillName) {
    currentSkill = skillName;
    const skill = skillsInfo[skillName];
    
    if (skill) {
        // ê¸°ìˆ  ì„ íƒ ì‹œ íš¨ê³¼ìŒ (ìŠ¬ë¡¯ë³„ë¡œ ë‹¤ë¥´ê²Œ)
        const slotIndex = playerSkills.indexOf(skillName);
        if (slotIndex !== -1) {
            adventureSound.playSkillSelectSound(slotIndex);
        }
        
        document.getElementById('modalSkillName').textContent = skill['í•œê¸€'] || skillName;
        document.getElementById('modalSkillDesc').textContent = skill['ì„¤ëª…'] + '\n' + skill['íš¨ê³¼'];
        document.getElementById('modalSkillRarity').textContent = skill['ë“±ê¸‰'];
        
        // ë²”ìœ„ í‘œì‹œ
        const minDmg = (skill['ê³µê²©ë ¥_ë³´ì •_min'] * 100).toFixed(0);
        const maxDmg = (skill['ê³µê²©ë ¥_ë³´ì •_max'] * 100).toFixed(0);
        document.getElementById('modalSkillDamage').textContent = minDmg + '%~' + maxDmg + '%';
        
        // 4ê°œ ì´ˆê³¼ì‹œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        const deleteBtn = document.getElementById('deleteSkillBtn');
        if (playerSkills.length > 4) {
            deleteBtn.style.display = 'block';
        } else {
            deleteBtn.style.display = 'none';
        }
        
        document.getElementById('skillModal').style.display = 'block';
    }
}

function closeSkillModal() {
    document.getElementById('skillModal').style.display = 'none';
}

function deleteSkill(skillName) {
    if (playerSkills.length <= 4) {
        alert('4ê°œ ì´í•˜ì˜ ê¸°ìˆ ë§Œ ë³´ìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const form = new FormData();
    form.append('skill_name', skillName);
    
    fetch("{{ url_for('delete_skill') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function flashMonsterImage(elementId) {
    const img = document.getElementById(elementId);
    if (!img) return;
    
    img.style.filter = 'brightness(2) hue-rotate(0deg) saturate(2) drop-shadow(0 0 10px #ff0000)';
    setTimeout(() => {
        img.style.filter = '';
    }, 300);
}

function updateBattleUI(battleState) {
    // HP ë°” ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
    const playerHpPercent = (battleState.player_monster.current_hp / battleState.player_monster.max_hp * 100);
    const enemyHpPercent = (battleState.enemy_monster.current_hp / battleState.enemy_monster.max_hp * 100);
    
    document.getElementById('playerHpBar').style.width = playerHpPercent + '%';
    document.getElementById('enemyHpBar').style.width = enemyHpPercent + '%';
    
    // === ì  ëª¬ìŠ¤í„° ì •ë³´ ì¹´ë“œ ì—…ë°ì´íŠ¸ ===
    // ì  ëª¬ìŠ¤í„° ì´ë¦„
    const enemyNameElements = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] h6');
    if (enemyNameElements.length > 0) {
        enemyNameElements[0].textContent = battleState.enemy_monster.name;
    }
    
    // ì  ëª¬ìŠ¤í„° ë“±ê¸‰
    const enemyRarityElements = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] p[style*="color: #999; font-size: 0.65rem"]');
    if (enemyRarityElements.length > 0) {
        enemyRarityElements[0].textContent = battleState.enemy_monster.rarity;
    }
    
    // ì  ëª¬ìŠ¤í„° HP í…ìŠ¤íŠ¸
    const enemyHpTexts = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] span[style*="font-weight: 700; font-size: 0.65rem"]');
    if (enemyHpTexts.length > 0) {
        enemyHpTexts[0].textContent = battleState.enemy_monster.current_hp + ' / ' + battleState.enemy_monster.max_hp;
    }
    
    // ì  ëª¬ìŠ¤í„° ATK
    const enemyAtkElements = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] span[style*="color: #FF6B6B"]');
    if (enemyAtkElements.length > 0) {
        enemyAtkElements[0].textContent = battleState.enemy_monster.attack;
    }
    
    // ì  ëª¬ìŠ¤í„° ì´ë¯¸ì§€
    const enemyMonsterImg = document.getElementById('enemyMonsterImg');
    if (enemyMonsterImg && battleState.enemy_monster.image) {
        if (enemyMonsterImg.tagName === 'IMG') {
            enemyMonsterImg.src = battleState.enemy_monster.image;
        }
    }
    
    // ë‚¨ì€ ì  ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸ (ìƒë‹¨ ìš°ì¸¡)
    const enemyCardContainer = document.querySelector('div[style*="position: absolute; top: 0; right: 0"]');
    if (enemyCardContainer) {
        const enemyBadge = enemyCardContainer.querySelector('div[style*="position: absolute; top: -12px"]');
        if (enemyBadge) {
            const remainingEnemyCount = battleState.enemy_count - battleState.defeated_monsters;
            let badgeHtml = '';
            for (let i = 0; i < remainingEnemyCount; i++) {
                badgeHtml += '<img src="{{ url_for("static", filename="images/health_circle.png") }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">';
            }
            enemyBadge.innerHTML = badgeHtml;
        }
    }
    
    // === í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì •ë³´ ì¹´ë“œ ì—…ë°ì´íŠ¸ ===
    // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì´ë¦„
    const playerNameElements = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] h6');
    if (playerNameElements.length > 0) {
        playerNameElements[0].textContent = battleState.player_monster.name;
    }
    
    // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ë“±ê¸‰
    const playerRarityElements = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] p[style*="color: #999; font-size: 0.65rem"]');
    if (playerRarityElements.length > 0) {
        playerRarityElements[0].textContent = battleState.player_monster.rarity;
    }
    
    // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° HP í…ìŠ¤íŠ¸
    const playerHpTexts = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] span[style*="font-weight: 700; font-size: 0.65rem"]');
    if (playerHpTexts.length > 0) {
        playerHpTexts[0].textContent = battleState.player_monster.current_hp + ' / ' + battleState.player_monster.max_hp;
    }
    
    // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ATK
    const playerAtkElements = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] span[style*="color: #4CAF50"]');
    if (playerAtkElements.length > 0) {
        playerAtkElements[0].textContent = battleState.player_monster.attack;
    }
    
    // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì´ë¯¸ì§€
    const playerMonsterImg = document.getElementById('playerMonsterImg');
    if (playerMonsterImg && battleState.player_monster.image) {
        if (playerMonsterImg.tagName === 'IMG') {
            playerMonsterImg.src = battleState.player_monster.image;
        }
    }
    
    // ë‚¨ì€ í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸ (ì¢Œì¸¡ í•˜ë‹¨)
    const playerCardContainer = document.querySelector('div[style*="position: absolute; bottom: 0; left: 0"]');
    if (playerCardContainer) {
        const playerBadge = playerCardContainer.querySelector('div[style*="position: absolute; top: -12px"]');
        if (playerBadge) {
            const remainingPlayerCount = (battleState.player_team_length || 3) - (battleState.current_team_index || 0);
            let badgeHtml = '';
            for (let i = 0; i < remainingPlayerCount; i++) {
                badgeHtml += '<img src="{{ url_for("static", filename="images/health_circle.png") }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">';
            }
            playerBadge.innerHTML = badgeHtml;
        }
    }
    
    // ì „íˆ¬ ë¡œê·¸ ì—…ë°ì´íŠ¸
    const logContainers = document.querySelectorAll('div[style*="max-height: 90px"]');
    if (logContainers.length > 0 && battleState.log) {
        const logContainer = logContainers[0];
        let logHtml = '';
        const logs = battleState.log.slice(-10);
        for (let log_line of logs) {
            let color = '#bbb';
            if (log_line.includes('í”Œë ˆì´ì–´')) color = '#4CAF50';
            else if (log_line.includes('ì ')) color = '#FF6B6B';
            logHtml += `<div style="margin-bottom: 2px; color: ${color};">> ${log_line}</div>`;
        }
        logContainer.innerHTML = logHtml;
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // ì  ëª¬ìŠ¤í„°ì— í”¼í•´ë¥¼ ì…ì—ˆìœ¼ë©´ ì  ì´ë¯¸ì§€ í”Œë˜ì‹œ + í”¼í•´ ìŒí–¥
    if (battleState.enemy_monster.current_hp < battleState.enemy_monster.max_hp) {
        flashMonsterImage('enemyMonsterImg');
        const damage = battleState.enemy_monster.max_hp - battleState.enemy_monster.current_hp;
        adventureSound.playDamageSound(damage);
    }
    
    // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„°ì— í”¼í•´ë¥¼ ì…ì—ˆìœ¼ë©´ í”Œë ˆì´ì–´ ì´ë¯¸ì§€ í”Œë˜ì‹œ + í”¼í•´ ìŒí–¥
    if (battleState.player_monster.current_hp < battleState.player_monster.max_hp) {
        flashMonsterImage('playerMonsterImg');
    }
}

function updateSkillUsageUI(skillUsage) {
    // ê¸°ìˆ  ì‚¬ìš© íšŸìˆ˜ ì—…ë°ì´íŠ¸
    for (let skillName in skillUsage) {
        const slotIndex = playerSkills.indexOf(skillName);
        if (slotIndex !== -1) {
            const btn = document.getElementById('skill-btn-' + slotIndex);
            if (btn) {
                const usage = skillUsage[skillName];
                const maxUses = skillMaxUses[skillName] || 10;
                const usageSpan = btn.querySelector('span');
                if (usageSpan) {
                    usageSpan.textContent = usage + '/' + maxUses;
                }
            }
        }
    }
}

function handleEnemyTurn(battleState) {
    // ì ì˜ í„´ì„ ì²˜ë¦¬í•˜ê³  í”Œë ˆì´ì–´ í„´ìœ¼ë¡œ ì „í™˜ (ì™„ì „ AJAX ë°©ì‹)
    const actionContainer = document.getElementById('actionContainer');
    
    // ì ì˜ í„´ í‘œì‹œ
    actionContainer.innerHTML = `
        <div style="text-align: center; padding: 15px; background-color: #2a2a2a; border-radius: 6px; color: #999; border: 1px solid #444;">
            <p style="font-size: 0.85rem; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">ì ì˜ í„´ì…ë‹ˆë‹¤...</p>
        </div>
    `;
    
    // 1.5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì ì˜ í„´ ì§„í–‰ (AJAX ìš”ì²­)
    setTimeout(() => {
        const form = new FormData();
        form.append('action_type', 'enemy_turn');
        
        fetch("{{ url_for('adventure_action') }}", {
            method: 'POST',
            body: form
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newBattleState = data.battle_state;
                updateBattleUI(newBattleState);
                updateSkillUsageUI(data.skill_usage || {});
                
                // ê²Œì„ ì˜¤ë²„ í™•ì¸
                if (data.game_over) {
                    setTimeout(() => {
                        if (data.winner === 'player') {
                            // ìŠ¹ë¦¬ ìŒí–¥
                            adventureSound.playVictorySound();
                            adventureSound.stopBackgroundMusic();
                            setTimeout(() => {
                                alert('ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ ' + newBattleState.stage_id + 'ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!');
                                window.location.href = "{{ url_for('adventure') }}";
                            }, 500);
                        } else {
                            // íŒ¨ë°° ìŒí–¥
                            adventureSound.playDefeatSound();
                            adventureSound.stopBackgroundMusic();
                            setTimeout(() => {
                                alert('íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                                window.location.href = "{{ url_for('adventure') }}";
                            }, 500);
                        }
                    }, 250);
                } else if (newBattleState.player_turn) {
                    // í”Œë ˆì´ì–´ í„´ìœ¼ë¡œ ì „í™˜ (ë¶€ë“œëŸ¬ìš´ UI ì—…ë°ì´íŠ¸)
                    setTimeout(() => {
                        // ê¸°ìˆ  ë²„íŠ¼ ì˜ì—­ ë‹¤ì‹œ ìƒì„±
                        let skillButtonsHtml = `
                            <div style="text-align: center; margin-bottom: 15px;">
                                <p style="color: #999; font-size: 0.85rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 0 auto;">`;
                        
                        for (let i = 0; i < playerSkills.length; i++) {
                            const skillName = playerSkills[i];
                            const usage = skillUsage[skillName] || 0;
                            const maxUses = skillMaxUses[skillName] || 10;
                            const isUsed = usage >= maxUses;
                            
                            skillButtonsHtml += `
                                <div>
                                    <button onclick="showSkillInfo('${skillName}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-${i}" 
                                    style="background-color: ${isUsed ? '#555' : '#333'}; color: ${isUsed ? '#888' : 'white'}; border: 2px solid ${isUsed ? '#777' : '#555'}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: ${isUsed ? 'not-allowed' : 'pointer'}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" 
                                    onmouseover="${isUsed ? '' : "this.style.backgroundColor='#444'; this.style.borderColor='#666';"}"
                                    onmouseout="${isUsed ? '' : "this.style.backgroundColor='#333'; this.style.borderColor='#555';"}"
                                    ondblclick="${isUsed ? '' : "useSkill('" + skillName + "')"}"
                                    ${isUsed ? 'disabled' : ''}>
                                        ${skillName}<br><span style="font-size: 0.6rem;">${usage}/${maxUses}</span>
                                    </button>
                                </div>
                            `;
                        }
                        
                        skillButtonsHtml += `
                                </div>
                                <p style="color: #999; font-size: 0.7rem; margin-top: 8px;">í´ë¦­ìœ¼ë¡œ ì •ë³´ ë³´ê¸°, ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‚¬ìš©</p>
                            </div>
                        `;
                        
                        actionContainer.innerHTML = skillButtonsHtml;
                        
                        // ìŠ¤í‚¬ ì‚¬ìš© íšŸìˆ˜ ì—…ë°ì´íŠ¸
                        Object.assign(skillUsage, data.skill_usage || {});
                    }, 200);
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }, 1500);
}

function useSkill(skillName) {
    // ê¸°ìˆ  ì‚¬ìš© ì‹œ íš¨ê³¼ìŒ (ë“±ê¸‰ë³„ + ê¸°ìˆ ë³„)
    adventureSound.playSkillCastSound(skillName, currentPlayerRarity);
    
    const form = new FormData();
    form.append('action_type', 'skill');
    form.append('skill_name', skillName);
    
    fetch("{{ url_for('adventure_action') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const battleState = data.battle_state;
            
            // ì „íˆ¬ UI ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
            updateBattleUI(battleState);
            updateSkillUsageUI(data.skill_usage || {});
            
            // ê²Œì„ ì˜¤ë²„ ìƒíƒœ í™•ì¸
            if (data.game_over) {
                setTimeout(() => {
                    if (data.winner === 'player') {
                        // ìŠ¹ë¦¬ ìŒí–¥
                        adventureSound.playVictorySound();
                        adventureSound.stopBackgroundMusic();
                        setTimeout(() => {
                            alert('ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ ' + battleState.stage_id + 'ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!');
                            window.location.href = "{{ url_for('adventure') }}";
                        }, 500);
                    } else {
                        // íŒ¨ë°° ìŒí–¥
                        adventureSound.playDefeatSound();
                        adventureSound.stopBackgroundMusic();
                        setTimeout(() => {
                            alert('íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                            window.location.href = "{{ url_for('adventure') }}";
                        }, 500);
                    }
                }, 250);
            } else if (!battleState.player_turn) {
                // ì ì˜ í„´ì´ë©´ ìë™ ì§„í–‰ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´!)
                handleEnemyTurn(battleState);
            }
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
document.getElementById('skillModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSkillModal();
    }
});
</script>
{% endblock %}
