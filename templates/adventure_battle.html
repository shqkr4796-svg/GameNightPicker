{% extends "base.html" %}

{% block title %}ì „íˆ¬ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">
<div class="adventure-battle-container">
    <!-- ì „íˆ¬ ì •ë³´ í—¤ë” -->
    <div class="battle-header mb-3">
        <div class="row text-center">
            <div class="col-md-4">
                <h5>{{ battle_state.stage_name }}</h5>
            </div>
            <div class="col-md-4">
                <h5>í„´: {{ battle_state.turn }}</h5>
            </div>
            <div class="col-md-4">
                <h5 class="badge bg-secondary">{{ battle_state.difficulty }}</h5>
            </div>
        </div>
    </div>

    <!-- ì „íˆ¬ í™”ë©´ -->
    <div class="battle-arena mb-4">
        <!-- ì  ëª¬ìŠ¤í„° (ì˜¤ë¥¸ìª½ ìƒë‹¨) -->
        <div class="enemy-section">
            <div class="enemy-container">
                <img src="{{ battle_state.enemy_monster.image }}" alt="{{ battle_state.enemy_monster.name }}" 
                     class="enemy-image">
                <div class="speech-bubble enemy-speech">
                    {{ battle_state.enemy_dialogue }}
                </div>
            </div>
            <div class="enemy-info mt-2">
                <h6>{{ battle_state.enemy_monster.name }} 
                    <span class="badge" style="background-color: 
                        {% if battle_state.enemy_monster.rarity == 'ë ˆì–´' %}#4169E1
                        {% elif battle_state.enemy_monster.rarity == 'ì—í”½' %}#9932CC
                        {% elif battle_state.enemy_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                        {% else %}#FF1493{% endif %}">
                        {{ battle_state.enemy_monster.rarity }}
                    </span>
                </h6>
                <div class="hp-bar">
                    <div class="hp-fill" style="width: {{ (battle_state.enemy_monster.current_hp / battle_state.enemy_monster.max_hp * 100)|int }}%"></div>
                </div>
                <p class="text-center" style="font-size: 0.85rem;">
                    {{ battle_state.enemy_monster.current_hp }} / {{ battle_state.enemy_monster.max_hp }}
                </p>
            </div>
        </div>

        <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° (ì™¼ìª½ ì•„ë˜) -->
        <div class="player-section">
            <div class="player-container">
                <img src="{{ battle_state.player_monster.image }}" alt="{{ battle_state.player_monster.name }}" 
                     class="player-image">
                <div class="speech-bubble player-speech">
                    {{ battle_state.player_dialogue }}
                </div>
            </div>
            <div class="player-info mt-2">
                <h6>{{ battle_state.player_monster.name }}
                    <span class="badge" style="background-color: 
                        {% if battle_state.player_monster.rarity == 'ë ˆì–´' %}#4169E1
                        {% elif battle_state.player_monster.rarity == 'ì—í”½' %}#9932CC
                        {% elif battle_state.player_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                        {% else %}#FF1493{% endif %}">
                        {{ battle_state.player_monster.rarity }}
                    </span>
                </h6>
                <div class="hp-bar">
                    <div class="hp-fill player-hp" style="width: {{ (battle_state.player_monster.current_hp / battle_state.player_monster.max_hp * 100)|int }}%"></div>
                </div>
                <p class="text-center" style="font-size: 0.85rem;">
                    {{ battle_state.player_monster.current_hp }} / {{ battle_state.player_monster.max_hp }}
                </p>
            </div>
        </div>
    </div>

    <!-- ì „íˆ¬ ë¡œê·¸ -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">âš”ï¸ ì „íˆ¬ ë¡œê·¸</h6>
        </div>
        <div class="card-body" style="height: 150px; overflow-y: auto; background-color: #f8f9fa; font-size: 0.85rem;">
            {% for log in battle_state.log %}
            <p class="mb-1">{{ log }}</p>
            {% endfor %}
        </div>
    </div>

    <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
    {% if battle_state.game_over %}
    <div class="alert {% if battle_state.winner == 'player' %}alert-success{% else %}alert-danger{% endif %} text-center">
        <h4>
            {% if battle_state.winner == 'player' %}
            ğŸ‰ ìŠ¹ë¦¬!
            {% else %}
            ğŸ’€ íŒ¨ë°°
            {% endif %}
        </h4>
        <p class="mb-0">{{ battle_state.player_dialogue if battle_state.winner == 'player' else battle_state.enemy_dialogue }}</p>
    </div>
    <div class="d-grid gap-2">
        <a href="{{ url_for('adventure') }}" class="btn btn-primary btn-lg">ëª¨í—˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
    {% else %}
    <!-- ê¸°ìˆ  ì¹´ë“œ ì„ íƒ -->
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0">ğŸ® ê¸°ìˆ  ì„ íƒ {% if not battle_state.player_turn %}<span class="badge bg-warning">ì ì˜ í„´...</span>{% endif %}</h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% for skill in battle_state.player_skills %}
                {% set skill_info = game_logic.SKILL_INFO.get(skill, {}) if skill else {} %}
                <div class="col-lg-6 mb-3">
                    <button class="skill-card btn w-100 
                        {% if skill == 'ë°•ì¹˜ê¸°' %}btn-primary{% elif skill == 'ìŠ¤ë§¤ì‹œ' or skill == 'ê²€ì€ë¹›' %}btn-secondary{% elif skill == 'ìŠ¤í•€ì–´íƒ' or skill == 'ë¶ˆì˜í­ë°œ' or skill == 'ë¹™ê²°ì˜ì¹¼' %}btn-warning{% else %}btn-danger{% endif %}"
                        {% if not battle_state.player_turn %}disabled{% endif %}
                        onclick="useSkill('{{ skill }}')">
                        <div style="font-size: 1.2rem; margin-bottom: 8px;">
                            {% if skill == 'ë°•ì¹˜ê¸°' %}âš”ï¸
                            {% elif skill == 'ìŠ¤ë§¤ì‹œ' %}ğŸ’¥
                            {% elif skill == 'ê²€ì€ë¹›' %}ğŸŒ‘
                            {% elif skill == 'ìŠ¤í•€ì–´íƒ' %}ğŸŒªï¸
                            {% elif skill == 'ë¶ˆì˜í­ë°œ' %}ğŸ”¥
                            {% elif skill == 'ë¹™ê²°ì˜ì¹¼' %}â„ï¸
                            {% elif skill == 'ë²ˆê°œì°¸ê²©' %}âš¡
                            {% elif skill == 'ê¶ê·¹ë² ê¸°' %}âš¡
                            {% elif skill == 'ì¤‘ë ¥íŒŒë™' %}ğŸŒ€
                            {% endif %}
                        </div>
                        <div style="font-weight: bold;">{{ skill }}</div>
                        <small style="display: block; margin-top: 4px;">ë°°ìˆ˜ 1.0ë°°</small>
                    </button>
                </div>
                {% endfor %}
            </div>
            <div class="d-grid gap-2 mt-3">
                <form method="POST" action="{{ url_for('adventure_escape') }}" class="d-inline">
                    <button type="submit" class="btn btn-warning w-100">ë„ë§ì¹˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
const battleState = {{ battle_state|tojson }};

function useSkill(skillName) {
    // AJAXë¡œ ê¸°ìˆ  ì‚¬ìš© ìš”ì²­
    fetch('{{ url_for("adventure_use_skill", skill_name="") }}' + skillName, {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    }).catch(error => console.error('Error:', error));
}

// ê¸°ìˆ  ì •ë³´ í‘œì‹œ (hover)
document.querySelectorAll('.skill-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        const skillName = this.textContent.trim().split('\n')[1];
        console.log('Skill:', skillName);
    });
});
</script>
{% endblock %}
