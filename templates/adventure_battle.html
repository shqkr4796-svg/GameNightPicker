{% extends "base.html" %}

{% block title %}ì „íˆ¬ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pokemon_battle.css') }}">
<div class="pokemon-battle-container">
    <!-- ìƒë‹¨: ìƒëŒ€ ëª¬ìŠ¤í„° -->
    <div class="battle-arena">
        <div class="enemy-position">
            <div class="enemy-card">
                <div class="enemy-info-top">
                    <div class="monster-name-tag">
                        <span class="name">{{ battle_state.enemy_monster.name }}</span>
                        <span class="rarity-badge" style="background-color: 
                            {% if battle_state.enemy_monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif battle_state.enemy_monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif battle_state.enemy_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ battle_state.enemy_monster.rarity }}
                        </span>
                    </div>
                    <div class="hp-bar-container">
                        <div class="hp-label">HP</div>
                        <div class="hp-bar">
                            <div class="hp-fill enemy-hp" style="width: {{ (battle_state.enemy_monster.current_hp / battle_state.enemy_monster.max_hp * 100)|int }}%"></div>
                        </div>
                        <div class="hp-text">{{ battle_state.enemy_monster.current_hp }}/{{ battle_state.enemy_monster.max_hp }}</div>
                    </div>
                </div>
                <div class="enemy-image-container">
                    <img src="{{ battle_state.enemy_monster.image }}" alt="{{ battle_state.enemy_monster.name }}" class="enemy-monster-image">
                </div>
                <div class="speech-bubble enemy-dialogue">{{ battle_state.enemy_dialogue }}</div>
            </div>
        </div>

        <!-- ì¤‘ì•™: ì „íˆ¬ ë¡œê·¸ -->
        <div class="battle-log-section">
            <div class="log-container">
                {% for log in battle_state.log %}
                <p class="log-entry">{{ log }}</p>
                {% endfor %}
            </div>
            <div class="turn-indicator">
                <span class="turn-label">í„´: {{ battle_state.turn }}</span>
                {% if not battle_state.player_turn %}
                <span class="enemy-turn-badge">ì ì˜ í„´...</span>
                {% endif %}
            </div>
        </div>

        <!-- í•˜ë‹¨: ë‚´ ëª¬ìŠ¤í„° -->
        <div class="player-position">
            <div class="player-card">
                <div class="speech-bubble player-dialogue">{{ battle_state.player_dialogue }}</div>
                <div class="player-image-container">
                    <img src="{{ battle_state.player_monster.image }}" alt="{{ battle_state.player_monster.name }}" class="player-monster-image">
                </div>
                <div class="player-info-bottom">
                    <div class="monster-name-tag">
                        <span class="name">{{ battle_state.player_monster.name }}</span>
                        <span class="rarity-badge" style="background-color: 
                            {% if battle_state.player_monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif battle_state.player_monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif battle_state.player_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ battle_state.player_monster.rarity }}
                        </span>
                    </div>
                    <div class="hp-bar-container">
                        <div class="hp-label">HP</div>
                        <div class="hp-bar">
                            <div class="hp-fill player-hp" style="width: {{ (battle_state.player_monster.current_hp / battle_state.player_monster.max_hp * 100)|int }}%"></div>
                        </div>
                        <div class="hp-text">{{ battle_state.player_monster.current_hp }}/{{ battle_state.player_monster.max_hp }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ -->
    {% if battle_state.game_over %}
    <div class="game-over-modal">
        <div class="game-over-content">
            <div class="game-over-badge {% if battle_state.winner == 'player' %}victory{% else %}defeat{% endif %}">
                {% if battle_state.winner == 'player' %}
                ğŸ‰ ìŠ¹ë¦¬!
                {% else %}
                ğŸ’€ íŒ¨ë°°
                {% endif %}
            </div>
            <p class="game-over-message">{{ battle_state.player_dialogue if battle_state.winner == 'player' else battle_state.enemy_dialogue }}</p>
            <a href="{{ url_for('adventure') }}" class="btn-return">ëª¨í—˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>
    {% else %}
    <!-- ê¸°ìˆ  ì„ íƒ ì˜ì—­ -->
    <div class="skill-selection-area">
        <h6 class="skill-title">ğŸ® ê¸°ìˆ  ì„ íƒ</h6>
        <div class="skills-grid">
            {% for skill in battle_state.player_skills %}
            <button class="skill-button {% if not battle_state.player_turn %}disabled{% endif %}" 
                    onclick="useSkill('{{ skill }}')"
                    {% if not battle_state.player_turn %}disabled{% endif %}>
                <div class="skill-emoji">
                    {% if skill == 'ë°•ì¹˜ê¸°' %}âš”ï¸
                    {% elif skill == 'ìŠ¤ë§¤ì‹œ' %}ğŸ’¥
                    {% elif skill == 'ê²€ì€ë¹›' %}ğŸŒ‘
                    {% elif skill == 'ìŠ¤í•€ì–´íƒ' %}ğŸŒªï¸
                    {% elif skill == 'ë¶ˆì˜í­ë°œ' %}ğŸ”¥
                    {% elif skill == 'ë¹™ê²°ì˜ì¹¼' %}â„ï¸
                    {% elif skill == 'ë²ˆê°œì°¸ê²©' %}âš¡
                    {% elif skill == 'ê¶ê·¹ë² ê¸°' %}âš¡
                    {% elif skill == 'ì¤‘ë ¥íŒŒë™' %}ğŸŒ€
                    {% else %}ğŸ’«{% endif %}
                </div>
                <div class="skill-name">{{ skill }}</div>
            </button>
            {% endfor %}
            <!-- ë¹ˆ ì¹¸ (2x2 ê·¸ë¦¬ë“œ ìœ ì§€) -->
            {% set skill_count = battle_state.player_skills|length %}
            {% for i in range(4 - skill_count) %}
            <div class="skill-button-empty"></div>
            {% endfor %}
        </div>
        <div class="action-buttons">
            <form method="POST" action="{{ url_for('adventure_escape') }}" class="d-inline">
                <button type="submit" class="btn-escape">ë„ë§ì¹˜ê¸°</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
const battleState = {{ battle_state|tojson }};

function useSkill(skillName) {
    fetch('{{ url_for("adventure_use_skill", skill_name="") }}' + skillName, {
        method: 'POST'
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    }).catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
