{% extends "base.html" %}

{% block title %}ì „íˆ¬ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pokemon_battle.css') }}">

<div class="battle-screen">
    <!-- ìƒë‹¨: ìŠ¤í…Œì´ì§€ ì •ë³´ -->
    <div class="battle-header">
        <div class="header-left">
            <span class="stage-label">ìŠ¤í…Œì´ì§€ {{ battle_state.stage_id }} / 200</span>
            <span class="stage-name">{{ battle_state.stage_name }}</span>
        </div>
        <div class="header-right">
            <span class="turn-info">í„´: <strong id="turn-count">{{ battle_state.turn }}</strong></span>
        </div>
    </div>

    <!-- ì¤‘ì•™: ì „íˆ¬ ì˜ì—­ -->
    <div class="battle-field">
        <!-- ìƒë‹¨: ì  ëª¬ìŠ¤í„° -->
        <div class="enemy-area">
            <div class="monster-panel">
                <div class="panel-header">
                    <div class="mon-info">
                        <div class="mon-name">{{ battle_state.enemy_monster.name }}</div>
                        <div class="mon-rarity" style="background:
                            {% if battle_state.enemy_monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif battle_state.enemy_monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif battle_state.enemy_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ battle_state.enemy_monster.rarity }}
                        </div>
                    </div>
                    <div class="hp-display">
                        <span class="hp-label">HP</span>
                        <span class="hp-value"><span id="enemy-hp">{{ battle_state.enemy_monster.current_hp }}</span> / {{ battle_state.enemy_monster.max_hp }}</span>
                    </div>
                </div>
                <div class="hp-bar-wrapper">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: {{ (battle_state.enemy_monster.current_hp / battle_state.enemy_monster.max_hp * 100)|int }}%"></div>
                    </div>
                </div>
            </div>
            <div class="monster-image-area">
                <img src="{{ battle_state.enemy_monster.image }}" alt="{{ battle_state.enemy_monster.name }}" class="monster-img">
            </div>
        </div>

        <!-- ì¤‘ì•™: ì „íˆ¬ ë¡œê·¸ -->
        <div class="battle-log-area">
            <div class="log-box" id="battle-log">
                {% for log in battle_state.log %}
                <p class="log-entry">{{ log }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- í•˜ë‹¨: ì•„êµ° ëª¬ìŠ¤í„° -->
        <div class="player-area">
            <div class="monster-image-area">
                <img src="{{ battle_state.player_monster.image }}" alt="{{ battle_state.player_monster.name }}" class="monster-img">
            </div>
            <div class="monster-panel">
                <div class="panel-header">
                    <div class="mon-info">
                        <div class="mon-name">{{ battle_state.player_monster.name }}</div>
                        <div class="mon-rarity" style="background:
                            {% if battle_state.player_monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif battle_state.player_monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif battle_state.player_monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ battle_state.player_monster.rarity }}
                        </div>
                    </div>
                    <div class="hp-display">
                        <span class="hp-label">HP</span>
                        <span class="hp-value"><span id="player-hp">{{ battle_state.player_monster.current_hp }}</span> / {{ battle_state.player_monster.max_hp }}</span>
                    </div>
                </div>
                <div class="hp-bar-wrapper">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: {{ (battle_state.player_monster.current_hp / battle_state.player_monster.max_hp * 100)|int }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨: ê¸°ìˆ  ì„ íƒ -->
    <div class="action-area">
        <div class="skills-section">
            <div class="section-title">ê¸°ìˆ  ì„ íƒ</div>
            <div class="skills-grid">
                {% for skill in battle_state.player_skills %}
                <button class="skill-btn" 
                        data-skill="{{ skill }}"
                        onclick="useSkill('{{ skill }}')"
                        {% if not battle_state.player_turn %}disabled{% endif %}
                        title="{{ skill_descriptions.get(skill, 'ê¸°ìˆ  ì„¤ëª… ì—†ìŒ') }}">
                    <div class="skill-icon">
                        {% if skill == 'ë°•ì¹˜ê¸°' %}âš”ï¸
                        {% elif skill == 'ìŠ¤ë§¤ì‹œ' %}ğŸ’¥
                        {% elif skill == 'ê²€ì€ë¹›' %}ğŸŒ‘
                        {% elif skill == 'ìŠ¤í•€ì–´íƒ' %}ğŸŒªï¸
                        {% elif skill == 'ë¶ˆì˜í­ë°œ' %}ğŸ”¥
                        {% elif skill == 'ë¹™ê²°ì˜ì¹¼' %}â„ï¸
                        {% elif skill == 'ë²ˆê°œì°¸ê²©' %}âš¡
                        {% elif skill == 'ê¶ê·¹ë² ê¸°' %}âš¡
                        {% elif skill == 'ì¤‘ë ¥íŒŒë™' %}ğŸŒ€
                        {% else %}ğŸ’«{% endif %}
                    </div>
                    <div class="skill-name">{{ skill }}</div>
                </button>
                {% endfor %}
                {% set skill_count = battle_state.player_skills|length %}
                {% for i in range(4 - skill_count) %}
                <div class="skill-btn empty"></div>
                {% endfor %}
            </div>
        </div>

        <div class="escape-section">
            <form method="POST" action="{{ url_for('adventure_escape') }}">
                <button type="submit" class="escape-btn">ë„ë§ì¹˜ê¸°</button>
            </form>
        </div>
    </div>
</div>

<!-- ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ -->
<div class="game-over-modal hidden" id="game-over-modal">
    <div class="modal-content">
        <div class="modal-badge" id="game-over-badge"></div>
        <p class="modal-message" id="game-over-message"></p>
        <a href="{{ url_for('adventure') }}" class="modal-btn">ëª¨í—˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
</div>

<script>
const initialBattleState = {{ battle_state|tojson }};
let battleState = JSON.parse(JSON.stringify(initialBattleState));

document.addEventListener('DOMContentLoaded', function() {
    if (!battleState.game_over && !battleState.player_turn) {
        setTimeout(() => {
            executeEnemyTurn();
        }, 1500);
    }
});

function useSkill(skillName) {
    const buttons = document.querySelectorAll('.skill-btn');
    buttons.forEach(btn => btn.disabled = true);

    fetch("{{ url_for('adventure_attack') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ skill: skillName })
    })
    .then(response => response.json())
    .then(data => {
        updateBattle(data);
        if (!data.game_over && !data.player_turn) {
            setTimeout(() => executeEnemyTurn(), 1500);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        buttons.forEach(btn => btn.disabled = false);
    });
}

function executeEnemyTurn() {
    fetch("{{ url_for('adventure_enemy_turn') }}", { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            updateBattle(data);
            if (!data.game_over && data.player_turn) {
                enableSkillButtons();
            }
        });
}

function updateBattle(data) {
    battleState = data;
    
    document.getElementById('enemy-hp').textContent = data.enemy_monster.current_hp;
    document.getElementById('player-hp').textContent = data.player_monster.current_hp;
    document.getElementById('turn-count').textContent = data.turn;
    
    const logBox = document.getElementById('battle-log');
    logBox.innerHTML = data.log.map(log => `<p class="log-entry">${log}</p>`).join('');
    logBox.scrollTop = logBox.scrollHeight;
    
    const enemyHpPercent = (data.enemy_monster.current_hp / data.enemy_monster.max_hp * 100);
    const playerHpPercent = (data.player_monster.current_hp / data.player_monster.max_hp * 100);
    
    document.querySelectorAll('.enemy-area .hp-fill')[0].style.width = enemyHpPercent + '%';
    document.querySelectorAll('.player-area .hp-fill')[0].style.width = playerHpPercent + '%';
    
    if (data.game_over) {
        setTimeout(() => showGameOver(data.game_over_reason), 1000);
    }
}

function enableSkillButtons() {
    document.querySelectorAll('.skill-btn').forEach((btn, idx) => {
        if (idx < battleState.player_skills.length) btn.disabled = false;
    });
}

function showGameOver(reason) {
    const modal = document.getElementById('game-over-modal');
    const badge = document.getElementById('game-over-badge');
    const message = document.getElementById('game-over-message');
    
    if (reason === 'victory') {
        badge.textContent = 'ğŸ‰ ìŠ¹ë¦¬!';
        message.textContent = 'ì „íˆ¬ì—ì„œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!';
        badge.style.color = '#4CAF50';
    } else {
        badge.textContent = 'ğŸ˜¢ íŒ¨ë°°!';
        message.textContent = 'ì „íˆ¬ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...';
        badge.style.color = '#F44336';
    }
    
    modal.classList.remove('hidden');
}
</script>
{% endblock %}
