{% extends "base.html" %}

{% block title %}ëª¨í—˜ ì „íˆ¬ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<!-- íš¨ê³¼ìŒ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="{{ url_for('static', filename='js/adventure_sound.js') }}"></script>

<!-- ë°°ê²½ìŒì•… ìƒíƒœ ë³µêµ¬ -->
<script>
// ìŒì•… ì¬ìƒ (adventureSound ë¡œë“œ í›„)
setTimeout(function() {
    if (typeof adventureSound !== 'undefined') {
        const savedMusicState = localStorage.getItem('adventureMusicEnabled');
        const shouldPlayMusic = savedMusicState !== 'false'; // ê¸°ë³¸ê°’ì€ true
        
        // ë¨¼ì € ëª¨ë“  ìŒì•…ì„ í™•ì‹¤íˆ ì •ì§€
        adventureSound.isMusicPlaying = false;
        adventureSound.masterGain.gain.setValueAtTime(0, adventureSound.audioContext.currentTime);
        
        if (adventureSound.musicLoopTimeout) {
            clearTimeout(adventureSound.musicLoopTimeout);
            adventureSound.musicLoopTimeout = null;
        }
        
        // ì €ì¥ëœ ìƒíƒœì— ë”°ë¼ ë°°ê²½ìŒì•… ì‹œì‘
        if (shouldPlayMusic) {
            adventureSound.soundEnabled = true;
            adventureSound.playBackgroundMusic();
        } else {
            adventureSound.soundEnabled = false;
        }
    }
}, 50);
</script>

<div class="container-fluid" style="background-color: #1a1a1a; min-height: 100vh; padding: 15px; color: white;">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- ìŠ¤í…Œì´ì§€ ì •ë³´ (ê°„ì†Œí™”) -->
            <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #333;">
                <h5 style="font-weight: 700; letter-spacing: 2px; margin-bottom: 3px;">{{ battle_state.stage_name }}</h5>
                <p style="color: #999; font-size: 0.8rem; margin: 0;">{{ battle_state.difficulty }}</p>
            </div>

            <!-- ëª¬ìŠ¤í„° ì „íˆ¬ í™”ë©´ (ìƒë‹¨ ì , í•˜ë‹¨ í”Œë ˆì´ì–´) -->
            <div style="margin-bottom: 15px; position: relative; min-height: 240px;">
                <!-- ì  ëª¬ìŠ¤í„° (ì˜¤ë¥¸ìª½ ìƒë‹¨) -->
                <div style="position: absolute; top: 0; right: 0; width: 80%; transform: scale(0.75); transform-origin: top right;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">ìƒëŒ€</div>
                        <div style="background-color: #2a2a2a; border-radius: 6px; padding: 12px 15px; border: 2px solid #444; display: flex; gap: 12px; flex-direction: row-reverse; position: relative;">
                            <!-- ë‚¨ì€ ì  ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ (ë™ê·¸ë¼ë¯¸ ê°œìˆ˜) -->
                            <div style="position: absolute; top: -12px; left: 0; display: flex; gap: 3px; flex-wrap: wrap;">
                                {% for i in range(battle_state.enemy_count - battle_state.defeated_monsters) %}
                                    <img src="{{ url_for('static', filename='images/health_circle.png') }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">
                                {% endfor %}
                            </div>
                            <!-- ì  ëª¬ìŠ¤í„° ì´ë¯¸ì§€ -->
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #333 0%, #1a1a1a 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                {% if battle_state.enemy_monster.image %}
                                    <img id="enemyMonsterImg" src="{{ battle_state.enemy_monster.image }}" alt="{{ battle_state.enemy_monster.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <div id="enemyMonsterImg" style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                        {% set rarity_emoji = {'ë ˆì–´': 'ğŸ”´', 'ì—í”½': 'ğŸŸ ', 'ìœ ë‹ˆí¬': 'ğŸŸ£', 'ë ˆì „ë“œë¦¬': 'ğŸ’œ', 'ì‹ í™”ê¸‰': 'â­'} %}
                                        {{ rarity_emoji.get(battle_state.enemy_monster.rarity, '') }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- ì  ëª¬ìŠ¤í„° ì •ë³´ -->
                            <div style="flex: 1; text-align: left;">
                                <h6 style="font-weight: 700; margin-bottom: 3px; font-size: 0.9rem;">{{ battle_state.enemy_monster.name }}</h6>
                                <p style="color: #999; font-size: 0.65rem; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">{{ battle_state.enemy_monster.rarity }}</p>
                                
                                <!-- HP ë°” -->
                                <div style="margin-bottom: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                        <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">HP</span>
                                        <span style="color: white; font-weight: 700; font-size: 0.65rem;">{{ battle_state.enemy_monster.current_hp }} / {{ battle_state.enemy_monster.max_hp }}</span>
                                    </div>
                                    <div style="width: 100%; height: 4px; background-color: #333; border-radius: 3px; overflow: hidden; border: 1px solid #444;">
                                        <div id="enemyHpBar" style="height: 100%; width: {{ (battle_state.enemy_monster.current_hp / battle_state.enemy_monster.max_hp * 100) }}%; background: linear-gradient(90deg, #FF6B6B, #ee5a52); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                
                                <!-- ê³µê²©ë ¥ -->
                                <div style="background-color: #333; padding: 4px 8px; border-radius: 4px; border: 1px solid #444;">
                                    <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">ATK</span>
                                    <span style="color: #FF6B6B; font-weight: 700; margin-left: 8px; font-size: 0.7rem;">{{ battle_state.enemy_monster.attack }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° (ì™¼ìª½ í•˜ë‹¨) -->
                <div style="position: absolute; bottom: 0; left: 0; width: 80%; transform: scale(0.75); transform-origin: bottom left;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">í”Œë ˆì´ì–´</div>
                        <div style="background-color: #2a2a2a; border-radius: 6px; padding: 12px 15px; border: 2px solid #444; display: flex; gap: 12px; position: relative;">
                            <!-- ë‚¨ì€ í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ (ë™ê·¸ë¼ë¯¸ ê°œìˆ˜) -->
                            <div style="position: absolute; top: -12px; left: 0; display: flex; gap: 3px; flex-wrap: wrap;">
                                {% for i in range(battle_state.player_team|length - battle_state.current_team_index) %}
                                    <img src="{{ url_for('static', filename='images/health_circle.png') }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">
                                {% endfor %}
                            </div>
                            <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì´ë¯¸ì§€ -->
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #333 0%, #1a1a1a 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                {% if battle_state.player_monster.image %}
                                    <img id="playerMonsterImg" src="{{ battle_state.player_monster.image }}" alt="{{ battle_state.player_monster.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <div id="playerMonsterImg" style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                        {% set rarity_emoji = {'ë ˆì–´': 'ğŸ”´', 'ì—í”½': 'ğŸŸ ', 'ìœ ë‹ˆí¬': 'ğŸŸ£', 'ë ˆì „ë“œë¦¬': 'ğŸ’œ', 'ì‹ í™”ê¸‰': 'â­'} %}
                                        {{ rarity_emoji.get(battle_state.player_monster.rarity, '') }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì •ë³´ -->
                            <div style="flex: 1; text-align: left;">
                                <h6 style="font-weight: 700; margin-bottom: 3px; font-size: 0.9rem;">{{ battle_state.player_monster.name }}</h6>
                                <p style="color: #999; font-size: 0.65rem; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">{{ battle_state.player_monster.rarity }}</p>
                                
                                <!-- HP ë°” -->
                                <div style="margin-bottom: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                        <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">HP</span>
                                        <span style="color: white; font-weight: 700; font-size: 0.65rem;">{{ battle_state.player_monster.current_hp }} / {{ battle_state.player_monster.max_hp }}</span>
                                    </div>
                                    <div style="width: 100%; height: 4px; background-color: #333; border-radius: 3px; overflow: hidden; border: 1px solid #444;">
                                        <div id="playerHpBar" style="height: 100%; width: {{ (battle_state.player_monster.current_hp / battle_state.player_monster.max_hp * 100) }}%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                
                                <!-- ê³µê²©ë ¥ -->
                                <div style="background-color: #333; padding: 4px 8px; border-radius: 4px; border: 1px solid #444;">
                                    <span style="color: #999; font-size: 0.6rem; text-transform: uppercase;">ATK</span>
                                    <span style="color: #4CAF50; font-weight: 700; margin-left: 8px; font-size: 0.7rem;">{{ battle_state.player_monster.attack }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì „íˆ¬ ë¡œê·¸ (ì¤„ì„) -->
            <div style="background-color: #2a2a2a; border-radius: 6px; padding: 10px; margin-bottom: 15px; border: 1px solid #444; max-height: 90px; overflow-y: auto;">
                <div style="font-size: 0.7rem; color: #999; line-height: 1.4;">
                    {% for log_line in battle_state.log[-10:] %}
                        <div style="margin-bottom: 2px; color: {% if 'í”Œë ˆì´ì–´' in log_line %}#4CAF50{% elif 'ì ' in log_line %}#FF6B6B{% else %}#bbb{% endif %};">
                            > {{ log_line }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ê¸°ìˆ  ì„ íƒ (ê²Œì„ ì§„í–‰ ì¤‘) -->
            {% if not battle_state.game_over %}
                <div id="actionContainer">
                    {% if battle_state.player_turn %}
                        <div style="text-align: center; margin-bottom: 15px;">
                            <p style="color: #999; font-size: 0.85rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 0 auto;">
                                <!-- ìŠ¬ë¡¯ 1 -->
                                <div>
                                    {% if battle_state.player_skills|length > 0 %}
                                        {% set skill_name = battle_state.player_skills[0] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-0" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                                <!-- ìŠ¬ë¡¯ 2 -->
                                <div>
                                    {% if battle_state.player_skills|length > 1 %}
                                        {% set skill_name = battle_state.player_skills[1] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-1" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                                <!-- ìŠ¬ë¡¯ 3 -->
                                <div>
                                    {% if battle_state.player_skills|length > 2 %}
                                        {% set skill_name = battle_state.player_skills[2] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-2" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                                <!-- ìŠ¬ë¡¯ 4 -->
                                <div>
                                    {% if battle_state.player_skills|length > 3 %}
                                        {% set skill_name = battle_state.player_skills[3] %}
                                        {% set usage = skill_usage.get(skill_name, 0) %}
                                        <div style="position: relative;">
                                            {% set max_uses = skill_max_uses.get(skill_name, 10) %}
                                            <button onclick="showSkillInfo('{{ skill_name }}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-3" style="background-color: {% if usage >= max_uses %}#555{% else %}#333{% endif %}; color: {% if usage >= max_uses %}#888{% else %}white{% endif %}; border: 2px solid {% if usage >= max_uses %}#777{% else %}#555{% endif %}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: {% if usage >= max_uses %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" onmouseover="{% if usage < max_uses %}this.style.backgroundColor='#444'; this.style.borderColor='#666';{% endif %}" onmouseout="{% if usage < max_uses %}this.style.backgroundColor='#333'; this.style.borderColor='#555';{% endif %}" ondblclick="{% if usage < max_uses %}useSkill('{{ skill_name }}'){% endif %}" {% if usage >= max_uses %}disabled{% endif %}>
                                                {{ skill_name }}<br><span style="font-size: 0.6rem;">{{ usage }}/{{ max_uses }}</span>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div style="height: 56px; background-color: transparent; border: 2px dashed #555; border-radius: 6px;"></div>
                                    {% endif %}
                                </div>
                            </div>
                            <p style="color: #999; font-size: 0.7rem; margin-top: 8px;">í´ë¦­ìœ¼ë¡œ ì •ë³´ ë³´ê¸°, ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‚¬ìš©</p>
                            
                            <!-- ì•„ì´í…œ ì‚¬ìš© ì„¹ì…˜ -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                                <p style="color: #999; font-size: 0.85rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">ì•„ì´í…œ</p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 0 auto;">
                                    <!-- ê¸°ìˆ  ì¶©ì „ì œ -->
                                    <button id="skillRecoveryBtn" onclick="showSkillRecoveryModal()" style="background-color: #2d5a2d; color: #4CAF50; border: 2px solid #4CAF50; border-radius: 6px; padding: 10px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.backgroundColor='#3d7a3d'" onmouseout="this.style.backgroundColor='#2d5a2d'">
                                        ê¸°ìˆ ì¶©ì „ì œ<br><span id="recoveryCount" style="font-size: 0.6rem;">0ê°œ</span>
                                    </button>
                                    <!-- ê¸°ìˆ  ì´ˆê¸°í™”ì œ -->
                                    <button id="skillResetBtn" onclick="useSkillReset()" style="background-color: #1a3a52; color: #2196F3; border: 2px solid #2196F3; border-radius: 6px; padding: 10px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.backgroundColor='#2a5a82'" onmouseout="this.style.backgroundColor='#1a3a52'">
                                        ê¸°ìˆ ì´ˆê¸°í™”ì œ<br><span id="resetCount" style="font-size: 0.6rem;">0ê°œ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div style="text-align: center; padding: 15px; background-color: #2a2a2a; border-radius: 6px; color: #999; border: 1px solid #444;">
                            <p style="font-size: 0.85rem; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">ì ì˜ í„´ì…ë‹ˆë‹¤...</p>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <!-- ì „íˆ¬ ì¢…ë£Œ -->
                <div style="text-align: center;">
                    {% if battle_state.winner == 'player' %}
                        <div style="background-color: #1a3a1a; border: 2px solid #4CAF50; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #4CAF50; font-weight: 700; margin-bottom: 12px; font-size: 1.3rem; text-transform: uppercase; letter-spacing: 2px;">ìŠ¹ë¦¬!</h4>
                            <p style="color: #bbb; margin-bottom: 15px; font-size: 0.9rem;">ìŠ¤í…Œì´ì§€ {{ battle_state.stage_id }}ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</p>
                            <a href="{{ url_for('adventure') }}" class="btn" style="background-color: #4CAF50; color: white; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; transition: background-color 0.3s; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#45a049'" onmouseout="this.style.backgroundColor='#4CAF50'">
                                ê³„ì†í•˜ê¸°
                            </a>
                        </div>
                    {% else %}
                        <div style="background-color: #3a1a1a; border: 2px solid #FF6B6B; border-radius: 8px; padding: 20px;">
                            <h4 style="color: #FF6B6B; font-weight: 700; margin-bottom: 12px; font-size: 1.3rem; text-transform: uppercase; letter-spacing: 2px;">íŒ¨ë°°</h4>
                            <p style="color: #bbb; margin-bottom: 15px; font-size: 0.9rem;">ìŠ¤í…Œì´ì§€ {{ battle_state.stage_id }}ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤.</p>
                            <a href="{{ url_for('adventure') }}" class="btn" style="background-color: #FF6B6B; color: white; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; transition: background-color 0.3s; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#ee5a52'" onmouseout="this.style.backgroundColor='#FF6B6B'">
                                ë‹¤ì‹œ ì‹œë„
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ê¸°ìˆ  ì •ë³´ ëª¨ë‹¬ -->
<div id="skillModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; padding: 20px;">
    <div style="background-color: #2a2a2a; border-radius: 8px; padding: 20px; max-width: 400px; margin: auto; margin-top: 50px; border: 2px solid #555; color: white;">
        <h5 id="modalSkillName" style="color: #bbb; font-weight: 700; margin-bottom: 15px; font-size: 1.1rem; text-transform: uppercase;"></h5>
        
        <div style="background-color: #333; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <p id="modalSkillDesc" style="font-size: 0.85rem; color: #ccc; margin: 0; line-height: 1.5;"></p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="background-color: #333; padding: 10px; border-radius: 6px; text-align: center;">
                <p style="color: #999; font-size: 0.7rem; margin-bottom: 5px;">ë“±ê¸‰</p>
                <p id="modalSkillRarity" style="color: #bbb; font-weight: 700; margin: 0;"></p>
            </div>
            <div style="background-color: #333; padding: 10px; border-radius: 6px; text-align: center;">
                <p style="color: #999; font-size: 0.7rem; margin-bottom: 5px;">ë°ë¯¸ì§€</p>
                <p id="modalSkillDamage" style="color: #bbb; font-weight: 700; margin: 0;"></p>
            </div>
        </div>
        
        <div id="skillUseContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="closeSkillModal(); useSkill(currentSkill)" class="btn w-100" style="background-color: #4CAF50; color: white; border: none; border-radius: 6px; padding: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#45a049'" onmouseout="this.style.backgroundColor='#4CAF50'">
                ì‚¬ìš©
            </button>
            <button onclick="closeSkillModal(); deleteSkill(currentSkill)" id="deleteSkillBtn" class="btn w-100" style="background-color: #FF6B6B; color: white; border: none; border-radius: 6px; padding: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem;" onmouseover="this.style.backgroundColor='#ee5a52'" onmouseout="this.style.backgroundColor='#FF6B6B'">
                ì‚­ì œ
            </button>
        </div>
        
        <button onclick="closeSkillModal()" class="btn w-100" style="background-color: #333; color: #999; border: 1px solid #555; border-radius: 6px; padding: 10px; font-weight: 600; cursor: pointer; font-size: 0.85rem; margin-top: 10px;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<script>
let currentSkill = '';
const skillsInfo = {{ skills_info | tojson }};
const playerSkills = {{ battle_state.player_skills | tojson }};
const skillUsage = {{ skill_usage | tojson }};
const skillMaxUses = {{ skill_max_uses | tojson }};
const currentPlayerRarity = '{{ battle_state.player_monster.rarity }}';
let skillButtonClickCount = { 0: 0, 1: 0, 2: 0, 3: 0 };

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°°ê²½ìŒì•… ì‹œì‘ ë° ì „íˆ¬ ì‹œì‘ ìŒí–¥
window.addEventListener('load', function() {
    setTimeout(() => {
        adventureSound.playBattleStartSound();
        adventureSound.playBackgroundMusic();
    }, 300);
});

function showSkillInfo(skillName) {
    currentSkill = skillName;
    const skill = skillsInfo[skillName];
    
    if (skill) {
        // ê¸°ìˆ  ì„ íƒ ì‹œ íš¨ê³¼ìŒ (ìŠ¬ë¡¯ë³„ë¡œ ë‹¤ë¥´ê²Œ)
        const slotIndex = playerSkills.indexOf(skillName);
        if (slotIndex !== -1) {
            adventureSound.playSkillSelectSound(slotIndex);
        }
        
        document.getElementById('modalSkillName').textContent = skill['í•œê¸€'] || skillName;
        document.getElementById('modalSkillDesc').textContent = skill['ì„¤ëª…'] + '\n' + skill['íš¨ê³¼'];
        document.getElementById('modalSkillRarity').textContent = skill['ë“±ê¸‰'];
        
        // ë²”ìœ„ í‘œì‹œ
        const minDmg = (skill['ê³µê²©ë ¥_ë³´ì •_min'] * 100).toFixed(0);
        const maxDmg = (skill['ê³µê²©ë ¥_ë³´ì •_max'] * 100).toFixed(0);
        document.getElementById('modalSkillDamage').textContent = minDmg + '%~' + maxDmg + '%';
        
        // 4ê°œ ì´ˆê³¼ì‹œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        const deleteBtn = document.getElementById('deleteSkillBtn');
        if (playerSkills.length > 4) {
            deleteBtn.style.display = 'block';
        } else {
            deleteBtn.style.display = 'none';
        }
        
        document.getElementById('skillModal').style.display = 'block';
    }
}

function closeSkillModal() {
    document.getElementById('skillModal').style.display = 'none';
}

function deleteSkill(skillName) {
    if (playerSkills.length <= 4) {
        alert('4ê°œ ì´í•˜ì˜ ê¸°ìˆ ë§Œ ë³´ìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const form = new FormData();
    form.append('skill_name', skillName);
    
    fetch("{{ url_for('delete_skill') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function flashMonsterImage(elementId) {
    const img = document.getElementById(elementId);
    if (!img) return;
    
    img.style.filter = 'brightness(2) hue-rotate(0deg) saturate(2) drop-shadow(0 0 10px #ff0000)';
    setTimeout(() => {
        img.style.filter = '';
    }, 300);
}

function updateBattleUI(battleState, enableFlash = true, updateMode = 'both') {
    // updateMode: 'both' = ì–‘ìª½ ì—…ë°ì´íŠ¸, 'enemy' = ìƒëŒ€ë§Œ, 'player' = ë‚´ê²ƒë§Œ
    
    // HP ë°” ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
    if (updateMode === 'both' || updateMode === 'enemy') {
        const enemyHpPercent = (battleState.enemy_monster.current_hp / battleState.enemy_monster.max_hp * 100);
        document.getElementById('enemyHpBar').style.width = enemyHpPercent + '%';
    }
    
    if (updateMode === 'both' || updateMode === 'player') {
        const playerHpPercent = (battleState.player_monster.current_hp / battleState.player_monster.max_hp * 100);
        document.getElementById('playerHpBar').style.width = playerHpPercent + '%';
    }
    
    // === ì  ëª¬ìŠ¤í„° ì •ë³´ ì¹´ë“œ ì—…ë°ì´íŠ¸ ===
    if (updateMode === 'both' || updateMode === 'enemy') {
        // ì  ëª¬ìŠ¤í„° ì´ë¦„
        const enemyNameElements = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] h6');
        if (enemyNameElements.length > 0) {
            enemyNameElements[0].textContent = battleState.enemy_monster.name;
        }
        
        // ì  ëª¬ìŠ¤í„° ë“±ê¸‰
        const enemyRarityElements = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] p[style*="color: #999; font-size: 0.65rem"]');
        if (enemyRarityElements.length > 0) {
            enemyRarityElements[0].textContent = battleState.enemy_monster.rarity;
        }
        
        // ì  ëª¬ìŠ¤í„° HP í…ìŠ¤íŠ¸
        const enemyHpTexts = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] span[style*="font-weight: 700; font-size: 0.65rem"]');
        if (enemyHpTexts.length > 0) {
            enemyHpTexts[0].textContent = battleState.enemy_monster.current_hp + ' / ' + battleState.enemy_monster.max_hp;
        }
        
        // ì  ëª¬ìŠ¤í„° ATK
        const enemyAtkElements = document.querySelectorAll('div[style*="position: absolute; top: 0; right: 0"] span[style*="color: #FF6B6B"]');
        if (enemyAtkElements.length > 0) {
            enemyAtkElements[0].textContent = battleState.enemy_monster.attack;
        }
        
        // ì  ëª¬ìŠ¤í„° ì´ë¯¸ì§€
        const enemyMonsterImg = document.getElementById('enemyMonsterImg');
        if (enemyMonsterImg && battleState.enemy_monster.image) {
            if (enemyMonsterImg.tagName === 'IMG') {
                enemyMonsterImg.src = battleState.enemy_monster.image;
            }
        }
        
        // ë‚¨ì€ ì  ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸ (ìƒë‹¨ ìš°ì¸¡) - ê¹œë¹¡ê±°ë¦¼ ì—†ì´ ì²˜ë¦¬
        const enemyCardContainer = document.querySelector('div[style*="position: absolute; top: 0; right: 0"]');
        if (enemyCardContainer) {
            const enemyBadge = enemyCardContainer.querySelector('div[style*="position: absolute; top: -12px"]');
            if (enemyBadge) {
                const remainingEnemyCount = battleState.enemy_count - battleState.defeated_monsters;
                const currentImgs = enemyBadge.querySelectorAll('img');
                
                // ì´ë¯¸ì§€ ê°œìˆ˜ê°€ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
                if (currentImgs.length !== remainingEnemyCount) {
                    let badgeHtml = '';
                    for (let i = 0; i < remainingEnemyCount; i++) {
                        badgeHtml += '<img src="{{ url_for("static", filename="images/health_circle.png") }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">';
                    }
                    enemyBadge.innerHTML = badgeHtml;
                }
            }
        }
    }
    
    // === í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì •ë³´ ì¹´ë“œ ì—…ë°ì´íŠ¸ ===
    if (updateMode === 'both' || updateMode === 'player') {
        // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì´ë¦„
        const playerNameElements = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] h6');
        if (playerNameElements.length > 0) {
            playerNameElements[0].textContent = battleState.player_monster.name;
        }
        
        // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ë“±ê¸‰
        const playerRarityElements = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] p[style*="color: #999; font-size: 0.65rem"]');
        if (playerRarityElements.length > 0) {
            playerRarityElements[0].textContent = battleState.player_monster.rarity;
        }
        
        // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° HP í…ìŠ¤íŠ¸
        const playerHpTexts = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] span[style*="font-weight: 700; font-size: 0.65rem"]');
        if (playerHpTexts.length > 0) {
            playerHpTexts[0].textContent = battleState.player_monster.current_hp + ' / ' + battleState.player_monster.max_hp;
        }
        
        // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ATK
        const playerAtkElements = document.querySelectorAll('div[style*="position: absolute; bottom: 0; left: 0"] span[style*="color: #4CAF50"]');
        if (playerAtkElements.length > 0) {
            playerAtkElements[0].textContent = battleState.player_monster.attack;
        }
        
        // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ì´ë¯¸ì§€
        const playerMonsterImg = document.getElementById('playerMonsterImg');
        if (playerMonsterImg && battleState.player_monster.image) {
            if (playerMonsterImg.tagName === 'IMG') {
                playerMonsterImg.src = battleState.player_monster.image;
            }
        }
        
        // ë‚¨ì€ í”Œë ˆì´ì–´ ëª¬ìŠ¤í„° ìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸ (ì¢Œì¸¡ í•˜ë‹¨) - ê¹œë¹¡ê±°ë¦¼ ì—†ì´ ì²˜ë¦¬
        const playerCardContainer = document.querySelector('div[style*="position: absolute; bottom: 0; left: 0"]');
        if (playerCardContainer) {
            const playerBadge = playerCardContainer.querySelector('div[style*="position: absolute; top: -12px"]');
            if (playerBadge) {
                // ë‚¨ì€ ëª¬ìŠ¤í„° ìˆ˜ ê³„ì‚°: player_team ë°°ì—´ì—ì„œ í˜„ì¬ ì¸ë±ìŠ¤ ì´í›„ì˜ ëª¬ìŠ¤í„°ë“¤
                const currentTeamIndex = battleState.current_team_index || 0;
                const playerTeamLength = battleState.player_team ? battleState.player_team.length : 3;
                const remainingPlayerCount = playerTeamLength - currentTeamIndex;
                const currentImgs = playerBadge.querySelectorAll('img');
                
                // ì´ë¯¸ì§€ ê°œìˆ˜ê°€ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
                if (currentImgs.length !== remainingPlayerCount) {
                    let badgeHtml = '';
                    for (let i = 0; i < remainingPlayerCount; i++) {
                        badgeHtml += '<img src="{{ url_for("static", filename="images/health_circle.png") }}" alt="ë‚¨ì€ ëª¬ìŠ¤í„°" style="width: 8px; height: 8px;">';
                    }
                    playerBadge.innerHTML = badgeHtml;
                }
            }
        }
    }
    
    // ì „íˆ¬ ë¡œê·¸ ì—…ë°ì´íŠ¸
    const logContainers = document.querySelectorAll('div[style*="max-height: 90px"]');
    if (logContainers.length > 0 && battleState.log) {
        const logContainer = logContainers[0];
        let logHtml = '';
        const logs = battleState.log.slice(-10);
        
        for (let log_line of logs) {
            let color = '#bbb';
            if (log_line.includes('í”Œë ˆì´ì–´')) color = '#4CAF50';
            else if (log_line.includes('ì ')) color = '#FF6B6B';
            logHtml += `<div style="margin-bottom: 2px; color: ${color}; font-size: 0.7rem; line-height: 1.4;">> ${log_line}</div>`;
        }
        logContainer.innerHTML = logHtml;
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // ë°˜ì§ì„ íš¨ê³¼
    if (enableFlash) {
        // ì  ëª¬ìŠ¤í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²½ìš°: ì  ëª¬ìŠ¤í„°ë§Œ ë°˜ì§ê±°ë¦¼
        if (updateMode === 'enemy') {
            if (battleState.enemy_monster.current_hp < battleState.enemy_monster.max_hp) {
                flashMonsterImage('enemyMonsterImg');
                const damage = battleState.enemy_monster.max_hp - battleState.enemy_monster.current_hp;
                adventureSound.playDamageSound(damage);
            }
        }
        // í”Œë ˆì´ì–´ ëª¬ìŠ¤í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²½ìš°: í”Œë ˆì´ì–´ ëª¬ìŠ¤í„°ë§Œ ë°˜ì§ê±°ë¦¼
        else if (updateMode === 'player') {
            if (battleState.player_monster.current_hp < battleState.player_monster.max_hp) {
                flashMonsterImage('playerMonsterImg');
            }
        }
        // ì–‘ìª½ ëª¨ë‘ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²½ìš°: ì–‘ìª½ ë‹¤ ë°˜ì§ê±°ë¦¼
        else if (updateMode === 'both') {
            if (battleState.enemy_monster.current_hp < battleState.enemy_monster.max_hp) {
                flashMonsterImage('enemyMonsterImg');
                const damage = battleState.enemy_monster.max_hp - battleState.enemy_monster.current_hp;
                adventureSound.playDamageSound(damage);
            }
            if (battleState.player_monster.current_hp < battleState.player_monster.max_hp) {
                flashMonsterImage('playerMonsterImg');
            }
        }
    }
}

function updateSkillUsageUI(skillUsage) {
    // ê¸°ìˆ  ì‚¬ìš© íšŸìˆ˜ ì—…ë°ì´íŠ¸ + ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    for (let skillName in skillUsage) {
        const slotIndex = playerSkills.indexOf(skillName);
        if (slotIndex !== -1) {
            const btn = document.getElementById('skill-btn-' + slotIndex);
            if (btn) {
                const usage = skillUsage[skillName];
                const maxUses = skillMaxUses[skillName] || 10;
                const isUsed = usage >= maxUses;
                
                // ì‚¬ìš© íšŸìˆ˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                const usageSpan = btn.querySelector('span');
                if (usageSpan) {
                    usageSpan.textContent = usage + '/' + maxUses;
                }
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ìƒ‰ìƒ, ì»¤ì„œ, í™œì„±/ë¹„í™œì„±)
                if (isUsed) {
                    btn.style.backgroundColor = '#555';
                    btn.style.color = '#888';
                    btn.style.borderColor = '#777';
                    btn.style.cursor = 'not-allowed';
                    btn.disabled = true;
                    // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                    btn.ondblclick = null;
                } else {
                    btn.style.backgroundColor = '#333';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#555';
                    btn.style.cursor = 'pointer';
                    btn.disabled = false;
                    // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ë³µì›
                    btn.ondblclick = function() { useSkill(skillName); };
                }
            }
        }
    }
}

function handleEnemyTurn(battleState) {
    // ì ì˜ í„´ì„ ì²˜ë¦¬í•˜ê³  í”Œë ˆì´ì–´ í„´ìœ¼ë¡œ ì „í™˜ (ì™„ì „ AJAX ë°©ì‹)
    const actionContainer = document.getElementById('actionContainer');
    
    // ì ì˜ í„´ í‘œì‹œ
    actionContainer.innerHTML = `
        <div style="text-align: center; padding: 15px; background-color: #2a2a2a; border-radius: 6px; color: #999; border: 1px solid #444;">
            <p style="font-size: 0.85rem; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">ì ì˜ í„´ì…ë‹ˆë‹¤...</p>
        </div>
    `;
    
    // 1.5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì ì˜ í„´ ì§„í–‰ (AJAX ìš”ì²­)
    setTimeout(() => {
        const form = new FormData();
        form.append('action_type', 'enemy_turn');
        
        fetch("{{ url_for('adventure_action') }}", {
            method: 'POST',
            body: form
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newBattleState = data.battle_state;
                // ìƒëŒ€ ê³µê²© í‘œì‹œ ì „ 0.5ì´ˆ ë”œë ˆì´
                setTimeout(() => {
                    updateBattleUI(newBattleState);
                    updateSkillUsageUI(data.skill_usage || {});
                    
                    // ê²Œì„ ì˜¤ë²„ í™•ì¸
                    if (data.game_over) {
                        setTimeout(() => {
                            if (data.winner === 'player') {
                                // ìŠ¹ë¦¬ ìŒí–¥
                                adventureSound.playVictorySound();
                                adventureSound.stopBackgroundMusic();
                                setTimeout(() => {
                                    alert('ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ ' + newBattleState.stage_id + 'ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!');
                                    window.location.href = "{{ url_for('adventure') }}";
                                }, 500);
                            } else {
                                // íŒ¨ë°° ìŒí–¥
                                adventureSound.playDefeatSound();
                                adventureSound.stopBackgroundMusic();
                                setTimeout(() => {
                                    alert('íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                                    window.location.href = "{{ url_for('adventure') }}";
                                }, 500);
                            }
                        }, 250);
                    } else if (newBattleState.player_turn) {
                        // í”Œë ˆì´ì–´ í„´ìœ¼ë¡œ ì „í™˜ (ë¶€ë“œëŸ¬ìš´ UI ì—…ë°ì´íŠ¸)
                        setTimeout(() => {
                            // ê¸°ìˆ  ë²„íŠ¼ ì˜ì—­ ë‹¤ì‹œ ìƒì„±
                            let skillButtonsHtml = `
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <p style="color: #999; font-size: 0.85rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 0 auto;">`;
                            
                            for (let i = 0; i < playerSkills.length; i++) {
                                const skillName = playerSkills[i];
                                const usage = skillUsage[skillName] || 0;
                                const maxUses = skillMaxUses[skillName] || 10;
                                const isUsed = usage >= maxUses;
                                
                                skillButtonsHtml += `
                                    <div>
                                        <button onclick="showSkillInfo('${skillName}')" title="ê¸°ìˆ  ì •ë³´ ë³´ê¸°" class="btn w-100" id="skill-btn-${i}" 
                                        style="background-color: ${isUsed ? '#555' : '#333'}; color: ${isUsed ? '#888' : 'white'}; border: 2px solid ${isUsed ? '#777' : '#555'}; border-radius: 6px; padding: 12px; font-size: 0.75rem; font-weight: 600; cursor: ${isUsed ? 'not-allowed' : 'pointer'}; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; word-break: break-word;" 
                                        onmouseover="${isUsed ? '' : "this.style.backgroundColor='#444'; this.style.borderColor='#666';"}"
                                        onmouseout="${isUsed ? '' : "this.style.backgroundColor='#333'; this.style.borderColor='#555';"}"
                                        ondblclick="${isUsed ? '' : "useSkill('" + skillName + "')"}"
                                        ${isUsed ? 'disabled' : ''}>
                                            ${skillName}<br><span style="font-size: 0.6rem;">${usage}/${maxUses}</span>
                                        </button>
                                    </div>
                                `;
                            }
                            
                            skillButtonsHtml += `
                                    </div>
                                    <p style="color: #999; font-size: 0.7rem; margin-top: 8px;">í´ë¦­ìœ¼ë¡œ ì •ë³´ ë³´ê¸°, ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‚¬ìš©</p>
                                </div>
                            `;
                            
                            actionContainer.innerHTML = skillButtonsHtml;
                            
                            // ìŠ¤í‚¬ ì‚¬ìš© íšŸìˆ˜ ì—…ë°ì´íŠ¸
                            Object.assign(skillUsage, data.skill_usage || {});
                        }, 200);
                    }
                }, 500);
            }
        })
        .catch(error => console.error('Error:', error));
    }, 1500);
}

function useSkill(skillName) {
    // ê¸°ìˆ  ì‚¬ìš© ì‹œ íš¨ê³¼ìŒ (ë“±ê¸‰ë³„ + ê¸°ìˆ ë³„)
    adventureSound.playSkillCastSound(skillName, currentPlayerRarity);
    
    const form = new FormData();
    form.append('action_type', 'skill');
    form.append('skill_name', skillName);
    
    fetch("{{ url_for('adventure_action') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const battleState = data.battle_state;
            
            // ì²« ë²ˆì§¸: ë‚´ ê³µê²© HPì™€ ë°˜ì§ì„ë§Œ í‘œì‹œ (HP ì°¨ì´ë¡œ ìƒëŒ€ ê³µê²© í‘œì‹œ, ë¡œê·¸ëŠ” ê·¸ëŒ€ë¡œ)
            const battleStateBeforeEnemyAttack = JSON.parse(JSON.stringify(battleState));
            
            // HP ì—­ê³„ì‚° (ìƒëŒ€ ê³µê²© ì „ ìƒíƒœë¡œ ë³µì›)
            let playerDamageTaken = 0;
            if (battleState.log && battleState.log.length > 0) {
                for (let i = battleState.log.length - 1; i >= 0; i--) {
                    const logLine = battleState.log[i];
                    if (logLine.includes('í”Œë ˆì´ì–´ ëª¬ìŠ¤í„°ì—ê²Œ') && logLine.includes('í”¼í•´')) {
                        const damageMatch = logLine.match(/(\d+)\s*í”¼í•´/);
                        if (damageMatch) {
                            playerDamageTaken += parseInt(damageMatch[1]);
                        }
                    }
                }
            }
            
            battleStateBeforeEnemyAttack.player_monster.current_hp = 
                battleStateBeforeEnemyAttack.player_monster.current_hp + playerDamageTaken;
            
            // ì²« ë²ˆì§¸ ì—…ë°ì´íŠ¸: í”Œë ˆì´ì–´ ê¸°ìˆ  ì‚¬ìš© ë¡œê·¸ë§Œ í‘œì‹œ
            const firstUpdateLog = battleStateBeforeEnemyAttack.log.filter(log => log.includes('í”Œë ˆì´ì–´'));
            battleStateBeforeEnemyAttack.log = firstUpdateLog;
            
            updateBattleUI(battleStateBeforeEnemyAttack, true, 'enemy');
            updateSkillUsageUI(data.skill_usage || {});
            
            // 0.5ì´ˆ í›„: ì™„ì „í•œ ì›ë³¸ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                const completeBattleState = JSON.parse(JSON.stringify(data.battle_state));
                updateBattleUI(completeBattleState, true, 'player');
                updateSkillUsageUI(data.skill_usage || {});
                
                // ê²Œì„ ì˜¤ë²„ ìƒíƒœ í™•ì¸
                if (data.game_over) {
                    setTimeout(() => {
                        if (data.winner === 'player') {
                            adventureSound.playVictorySound();
                            adventureSound.stopBackgroundMusic();
                            
                            // ì•„ì´í…œ íšë“ íŒì—… ì²˜ë¦¬
                            if (data.rewards && data.rewards.items) {
                                for (let item of data.rewards.items) {
                                    if (item === 'ê¸°ìˆ ì¶©ì „ì œ' || item === 'ê¸°ìˆ ì´ˆê¸°í™”ì œ') {
                                        showItemAcquireModal(item);
                                    }
                                }
                            }
                            
                            // ê¸°ìˆ  íšë“/êµì²´ íŒì—… ì²˜ë¦¬
                            if (data.rewards) {
                                if (data.rewards.skill_added) {
                                    // 4ê°œ ë¯¸ë§Œ: ê¸°ìˆ  íšë“ íŒì—…
                                    showSkillAcquireModal(data.rewards.skills[0]);
                                    setTimeout(() => {
                                        alert('ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ ' + battleState.stage_id + 'ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!');
                                        window.location.href = "{{ url_for('adventure') }}";
                                    }, 2000);
                                } else if (data.rewards.new_skill) {
                                    // 4ê°œ ì´ìƒ: ê¸°ìˆ  êµì²´ íŒì—…
                                    window.pendingNewSkill = data.rewards.new_skill;
                                    showSkillReplaceModal(data.rewards.new_skill, data.rewards.current_skills);
                                } else {
                                    // ê¸°ìˆ  ë¯¸íšë“
                                    alert('ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ ' + battleState.stage_id + 'ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!');
                                    window.location.href = "{{ url_for('adventure') }}";
                                }
                            } else {
                                alert('ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ ' + battleState.stage_id + 'ì„(ë¥¼) í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!');
                                window.location.href = "{{ url_for('adventure') }}";
                            }
                        } else {
                            adventureSound.playDefeatSound();
                            adventureSound.stopBackgroundMusic();
                            setTimeout(() => {
                                alert('íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                                window.location.href = "{{ url_for('adventure') }}";
                            }, 500);
                        }
                    }, 250);
                } else if (!battleState.player_turn) {
                    handleEnemyTurn(battleState);
                }
            }, 500);
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê¸°ìˆ  íšë“ íŒì—… ëª¨ë‹¬
const skillAcquireModal = document.createElement('div');
skillAcquireModal.id = 'skillAcquireModal';
skillAcquireModal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;';
skillAcquireModal.innerHTML = `
    <div style="background-color: #2a2a2a; border: 2px solid #4CAF50; border-radius: 8px; padding: 30px; max-width: 400px; text-align: center; color: white;">
        <h4 style="color: #4CAF50; font-weight: 700; margin-bottom: 15px;">ê¸°ìˆ  íšë“!</h4>
        <p id="acquireSkillName" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; color: #fff;"></p>
        <p id="acquireSkillDesc" style="color: #bbb; font-size: 0.85rem; line-height: 1.6; margin-bottom: 20px;"></p>
        <button onclick="closeSkillAcquireModal()" class="btn w-100" style="background-color: #4CAF50; color: white; border: none; border-radius: 6px; padding: 12px; font-weight: 600; cursor: pointer;">
            í™•ì¸
        </button>
    </div>
`;
document.body.appendChild(skillAcquireModal);

// ê¸°ìˆ  êµì²´ íŒì—… ëª¨ë‹¬
const skillReplaceModal = document.createElement('div');
skillReplaceModal.id = 'skillReplaceModal';
skillReplaceModal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto;';
skillReplaceModal.innerHTML = `
    <div style="background-color: #2a2a2a; border: 2px solid #FF9800; border-radius: 8px; padding: 30px; max-width: 500px; text-align: center; color: white; margin: 20px auto;">
        <h4 style="color: #FF9800; font-weight: 700; margin-bottom: 10px;">ê¸°ìˆ ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!</h4>
        <p style="color: #bbb; font-size: 0.85rem; margin-bottom: 20px;">ê¸°ìˆ  4ê°œì˜ í•œê³„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ìƒˆ ê¸°ìˆ ê³¼ ê¸°ì¡´ ê¸°ìˆ  ì¤‘ í•˜ë‚˜ë¥¼ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div style="background-color: #1a1a1a; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
            <p style="color: #999; font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase;">ìƒˆ ê¸°ìˆ </p>
            <p id="newSkillName" style="font-size: 1.1rem; font-weight: 600; color: #FF9800; margin: 0;"></p>
            <p id="newSkillDesc" style="color: #bbb; font-size: 0.8rem; margin-top: 5px;"></p>
        </div>
        
        <p style="color: #999; font-size: 0.75rem; margin-bottom: 12px;">ê¸°ì¡´ ê¸°ìˆ  ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
        <div id="existingSkillsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px;"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="closeSkillReplaceModal()" class="btn w-100" style="background-color: #333; color: #999; border: 1px solid #555; border-radius: 6px; padding: 12px; font-weight: 600; cursor: pointer;">
                ì·¨ì†Œ
            </button>
            <button onclick="confirmSkillReplace()" id="confirmReplaceBtn" class="btn w-100" style="background-color: #4CAF50; color: white; border: none; border-radius: 6px; padding: 12px; font-weight: 600; cursor: pointer; display: none;">
                êµì²´ í™•ì¸
            </button>
        </div>
    </div>
`;
document.body.appendChild(skillReplaceModal);

let selectedOldSkill = null;

function showSkillAcquireModal(newSkill) {
    document.getElementById('acquireSkillName').textContent = skillsInfo[newSkill]?.['í•œê¸€'] || newSkill;
    document.getElementById('acquireSkillDesc').textContent = (skillsInfo[newSkill]?.['ì„¤ëª…'] || '') + '\n' + (skillsInfo[newSkill]?.['íš¨ê³¼'] || '');
    document.getElementById('skillAcquireModal').style.display = 'flex';
}

function closeSkillAcquireModal() {
    document.getElementById('skillAcquireModal').style.display = 'none';
}

function showSkillReplaceModal(newSkill, currentSkills) {
    const newSkillInfo = skillsInfo[newSkill];
    document.getElementById('newSkillName').textContent = newSkillInfo?.['í•œê¸€'] || newSkill;
    document.getElementById('newSkillDesc').textContent = newSkillInfo?.['ì„¤ëª…'] || '';
    
    let existingHtml = '';
    for (let skill of currentSkills) {
        const skillInfo = skillsInfo[skill];
        existingHtml += `
            <button onclick="selectOldSkill('${skill}')" style="background-color: #333; color: white; border: 2px solid #555; border-radius: 6px; padding: 10px; font-size: 0.75rem; cursor: pointer; word-break: break-word;" class="existing-skill-btn" data-skill="${skill}">
                ${skillInfo?.['í•œê¸€'] || skill}
            </button>
        `;
    }
    document.getElementById('existingSkillsContainer').innerHTML = existingHtml;
    selectedOldSkill = null;
    document.getElementById('confirmReplaceBtn').style.display = 'none';
    document.getElementById('skillReplaceModal').style.display = 'flex';
}

function closeSkillReplaceModal() {
    document.getElementById('skillReplaceModal').style.display = 'none';
    selectedOldSkill = null;
}

function selectOldSkill(skill) {
    selectedOldSkill = skill;
    document.querySelectorAll('.existing-skill-btn').forEach(btn => {
        if (btn.getAttribute('data-skill') === skill) {
            btn.style.backgroundColor = '#FF9800';
            btn.style.borderColor = '#FFB84D';
        } else {
            btn.style.backgroundColor = '#333';
            btn.style.borderColor = '#555';
        }
    });
    document.getElementById('confirmReplaceBtn').style.display = 'block';
}

function confirmSkillReplace() {
    if (!selectedOldSkill) {
        alert('êµì²´í•  ê¸°ìˆ ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const form = new FormData();
    form.append('new_skill', window.pendingNewSkill);
    form.append('old_skill', selectedOldSkill);
    
    fetch("{{ url_for('replace_skill') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSkillReplaceModal();
            alert(data.message);
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
document.getElementById('skillModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSkillModal();
    }
});

// ì•„ì´í…œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
function updateItemCounts() {
    const adventureItems = {{ adventure_items | tojson }};
    document.getElementById('recoveryCount').textContent = (adventureItems['ê¸°ìˆ ì¶©ì „ì œ'] || 0) + 'ê°œ';
    document.getElementById('resetCount').textContent = (adventureItems['ê¸°ìˆ ì´ˆê¸°í™”ì œ'] || 0) + 'ê°œ';
}

// ì•„ì´í…œ íšë“ íŒì—… í‘œì‹œ
function showItemAcquireModal(itemType) {
    const itemNames = {'ê¸°ìˆ ì¶©ì „ì œ': 'ê¸°ìˆ  ì¶©ì „ì œ', 'ê¸°ìˆ ì´ˆê¸°í™”ì œ': 'ê¸°ìˆ  ì´ˆê¸°í™”ì œ'};
    const itemDescs = {'ê¸°ìˆ ì¶©ì „ì œ': 'ê¸°ìˆ  íšŸìˆ˜ë¥¼ 1/2 íšŒë³µí•©ë‹ˆë‹¤', 'ê¸°ìˆ ì´ˆê¸°í™”ì œ': 'ê¸°ìˆ  ì‚¬ìš© íšŸìˆ˜ë¥¼ ëª¨ë‘ ë¦¬ì…‹í•©ë‹ˆë‹¤'};
    const itemColors = {'ê¸°ìˆ ì¶©ì „ì œ': '#4CAF50', 'ê¸°ìˆ ì´ˆê¸°í™”ì œ': '#2196F3'};
    
    const modal = document.createElement('div');
    modal.style.cssText = 'display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;';
    
    modal.innerHTML = `
        <div style="background-color: #2a2a2a; border-radius: 12px; padding: 30px; max-width: 450px; border: 3px solid ${itemColors[itemType]}; color: white; text-align: center;">
            <h3 style="color: ${itemColors[itemType]}; font-weight: 700; margin-bottom: 15px; font-size: 1.3rem; text-transform: uppercase;">â­ ì•„ì´í…œ íšë“!</h3>
            <div style="background-color: ${itemColors[itemType]}22; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid ${itemColors[itemType]};">
                <p style="color: ${itemColors[itemType]}; font-size: 1.2rem; font-weight: 700; margin-bottom: 8px;">${itemNames[itemType]}</p>
                <p style="color: #ccc; font-size: 0.9rem; margin: 0;">${itemDescs[itemType]}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background-color: ${itemColors[itemType]}; color: white; border: none; border-radius: 6px; padding: 12px 30px; font-weight: 600; cursor: pointer; font-size: 0.95rem; width: 100%;">í™•ì¸</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.onclick = function(e) { if (e.target === this) this.remove(); };
}

// ê¸°ìˆ  ì¶©ì „ì œ ì„ íƒ íŒì—…
function showSkillRecoveryModal() {
    const adventureItems = {{ adventure_items | tojson }};
    if ((adventureItems['ê¸°ìˆ ì¶©ì „ì œ'] || 0) <= 0) {
        alert('ê¸°ìˆ ì¶©ì „ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const skills = playerSkills;
    let skillButtons = skills.map(skill => `
        <button onclick="useSkillRecovery('${skill}')" style="background-color: #333; color: white; border: 2px solid #4CAF50; border-radius: 6px; padding: 12px; font-size: 0.75rem; cursor: pointer; word-break: break-word; width: 100%; margin-bottom: 8px;">
            ${skill}
        </button>
    `).join('');
    
    const modal = document.createElement('div');
    modal.style.cssText = 'display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;';
    
    modal.innerHTML = `
        <div style="background-color: #2a2a2a; border-radius: 12px; padding: 25px; max-width: 400px; border: 2px solid #4CAF50; color: white;">
            <h4 style="color: #4CAF50; margin-bottom: 15px; text-align: center;">íšŒë³µí•  ê¸°ìˆ  ì„ íƒ</h4>
            <div style="max-height: 300px; overflow-y: auto;">${skillButtons}</div>
            <button onclick="this.closest('div').parentElement.remove()" style="background-color: #333; color: #999; border: 1px solid #555; border-radius: 6px; padding: 10px; cursor: pointer; width: 100%; margin-top: 10px;">ì·¨ì†Œ</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.onclick = function(e) { if (e.target === this) this.remove(); };
}

// ê¸°ìˆ  ì¶©ì „ì œ ì‚¬ìš©
function useSkillRecovery(skillName) {
    document.querySelectorAll('div[style*="position:fixed"]').forEach(el => el.remove());
    
    const form = new FormData();
    form.append('action_type', 'skill_item');
    form.append('item_type', 'ê¸°ìˆ ì¶©ì „ì œ');
    form.append('skill_name', skillName);
    
    fetch("{{ url_for('adventure_action') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ“ ' + skillName + ' ê¸°ìˆ ì´ ' + data.recovery_amount + 'íšŒ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!');
            updateItemCounts();
            handleEnemyTurn(data.battle_state);
        } else {
            alert('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê¸°ìˆ  ì´ˆê¸°í™”ì œ ì‚¬ìš©
function useSkillReset() {
    const adventureItems = {{ adventure_items | tojson }};
    if ((adventureItems['ê¸°ìˆ ì´ˆê¸°í™”ì œ'] || 0) <= 0) {
        alert('ê¸°ìˆ ì´ˆê¸°í™”ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('ëª¨ë“  ê¸°ìˆ ì˜ ì‚¬ìš© íšŸìˆ˜ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const form = new FormData();
    form.append('action_type', 'skill_item');
    form.append('item_type', 'ê¸°ìˆ ì´ˆê¸°í™”ì œ');
    
    fetch("{{ url_for('adventure_action') }}", {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ“ ëª¨ë“  ê¸°ìˆ ì˜ ì‚¬ìš© íšŸìˆ˜ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!');
            updateItemCounts();
            handleEnemyTurn(data.battle_state);
        } else {
            alert('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì•„ì´í…œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
window.addEventListener('load', updateItemCounts);
</script>
{% endblock %}
