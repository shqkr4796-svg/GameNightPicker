{% extends "base.html" %}

{% block title %}단어 퀴즈 - 라이프 시뮬레이션{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- 퀴즈 섹션 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>단어 퀴즈
                </h5>
            </div>
            <div class="card-body">
                <!-- 카테고리 및 언어 선택 -->
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">퀴즈 카테고리 선택</label>
                            <select class="form-select" onchange="changeQuizCategory(this.value)">
                                <option value="all" {{ 'selected' if selected_category == 'all' }}>전체 단어</option>
                                {% for category in categories %}
                                <option value="{{ category }}" {{ 'selected' if selected_category == category }}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">퀴즈 언어 선택</label>
                            <select class="form-select" onchange="changeQuizLanguage(this.value)">
                                <option value="random" {{ 'selected' if selected_language == 'random' }}>랜덤 (영어↔한글)</option>
                                <option value="english" {{ 'selected' if selected_language == 'english' }}>영어 문제만</option>
                                <option value="korean" {{ 'selected' if selected_language == 'korean' }}>한글 문제만</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="text-muted small">
                                현재 카테고리: <strong>{{ selected_category if selected_category != 'all' else '전체' }}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-muted small">
                                현재 언어: <strong>
                                    {% if selected_language == 'english' %}영어 문제만
                                    {% elif selected_language == 'korean' %}한글 문제만
                                    {% else %}랜덤{% endif %}
                                </strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 퀴즈 진행률 표시 -->
                {% if total_words > 0 %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">퀴즈 진행률</span>
                        <span class="badge bg-primary">{{ completed_words }}/{{ total_words }}</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" style="width: {{ (completed_words / total_words * 100) if total_words > 0 else 0 }}%"></div>
                    </div>
                    {% if completed_words == total_words %}
                    <div class="text-center mt-3">
                        <div class="alert alert-success">
                            <i class="fas fa-trophy me-2"></i>모든 단어를 완료했습니다! 
                            <form method="POST" action="{{ url_for('reset_quiz_session') }}" class="d-inline">
                                <input type="hidden" name="selected_category" value="{{ selected_category }}">
                                <input type="hidden" name="selected_language" value="{{ selected_language }}">
                                <button type="submit" class="btn btn-sm btn-outline-success ms-2">
                                    <i class="fas fa-redo me-1"></i>새 세션 시작
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 틀린 문제 재도전 버튼 -->
                {% if has_wrong_questions %}
                <div class="mb-4">
                    <div class="alert alert-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>{{ wrong_questions|length }}개의 틀린 문제가 있습니다</strong>
                                <br><small class="text-muted">틀린 문제들만 다시 풀어보세요!</small>
                            </div>
                            <div>
                                <a href="{{ url_for('retry_wrong_quiz', category=selected_category, language=selected_language) }}" 
                                   class="btn btn-warning">
                                    <i class="fas fa-redo me-1"></i>틀린 문제 재도전
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                {% if word_bank|length > 0 %}
                    {% set quiz_word = word_bank|random %}
                    {% if selected_language == 'english' %}
                        {% set question_type = '단어맞히기' %}
                    {% elif selected_language == 'korean' %}
                        {% set question_type = '뜻맞히기' %}
                    {% else %}
                        {% set question_type = ['뜻맞히기', '단어맞히기']|random %}
                    {% endif %}
                    
                    <div class="text-center mb-4">
                        {% if question_type == '뜻맞히기' %}
                            <h4 class="text-primary">단어 뜻 맞히기</h4>
                            <div class="word-card mb-4">
                                <div class="word">{{ quiz_word['뜻'] }}</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                            onclick="speakWord('{{ quiz_word['단어'] }}', this)" title="정답 단어 발음 듣기">
                                        <i class="fas fa-volume-up me-1"></i>정답 발음 듣기
                                    </button>
                                </div>
                            </div>
                            <p>위 뜻에 해당하는 영어 단어를 입력하세요.</p>
                        {% else %}
                            <h4 class="text-primary">단어를 보고 뜻 맞히기</h4>
                            <div class="word-card mb-4">
                                <div class="word">{{ quiz_word['단어'] }}</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="speakWord('{{ quiz_word['단어'] }}', this)" title="단어 발음 듣기">
                                        <i class="fas fa-volume-up me-1"></i>발음 듣기
                                    </button>
                                </div>
                            </div>
                            <p>위 단어의 뜻을 한글로 입력하세요.</p>
                        {% endif %}
                    </div>

                    <form id="quiz-form" onsubmit="submitQuizAnswer(event)">
                        <input type="hidden" name="question_type" value="{{ question_type }}">
                        <input type="hidden" name="correct_answer" 
                               value="{{ quiz_word['단어'] if question_type == '뜻맞히기' else quiz_word['뜻'] }}">
                        <input type="hidden" name="quiz_word" value="{{ quiz_word['단어'] }}">
                        <input type="hidden" name="selected_category" value="{{ selected_category }}">
                        <input type="hidden" name="selected_language" value="{{ selected_language }}">
                        
                        <div class="mb-3">
                            <input type="text" name="answer" id="answer-input" class="form-control form-control-lg text-center" 
                                   placeholder="답을 입력하세요" required autofocus>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="fas fa-check me-2"></i>정답 제출
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg ms-2" 
                                    onclick="resetQuizSession('{{ selected_category }}', this)">
                                <i class="fas fa-redo me-2"></i>새 세션
                            </button>
                            <button type="button" class="btn btn-warning btn-lg ms-2"
                                    id="retry-wrong-btn"
                                    style="display: {% if has_wrong_questions %}inline-block{% else %}none{% endif %};"
                                    onclick="retryWrongQuestions('{{ selected_category }}', this)">
                                <i class="fas fa-exclamation-triangle me-2"></i>틀린 문제 재도전 (<span id="wrong-count">{{ wrong_questions|length }}</span>)
                            </button>
                        </div>
                    </form>
                    
                    <!-- 결과 표시 영역 -->
                    <div id="quiz-result" class="mt-3"></div>
                    
                    <div class="mt-4 text-center">
                        <small class="text-muted">
                            퀴즈를 풀면 경험치를 획득합니다.
                        </small>
                    </div>
                {% elif total_words > 0 %}
                    <!-- 모든 단어를 맞혔을 때 -->
                    <div class="text-center py-5">
                        <i class="fas fa-trophy text-warning mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-success mb-3">모든 단어를 완료했습니다!</h4>
                        <p class="text-muted mb-4">
                            이 세션에서 {{ completed_words }}개의 단어를 모두 맞혔습니다.<br>
                            새로운 퀴즈 세션을 시작하여 다시 도전해보세요.
                        </p>
                        <form method="POST" action="{{ url_for('reset_quiz_session') }}">
                            <input type="hidden" name="selected_category" value="{{ selected_category }}">
                            <input type="hidden" name="selected_language" value="{{ selected_language }}">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-redo me-2"></i>새 세션 시작
                            </button>
                        </form>
                        {% if has_wrong_questions %}
                        <div class="mt-3">
                            <button type="button" class="btn btn-warning btn-lg"
                                    onclick="retryWrongQuestions('{{ selected_category }}', this)">
                                <i class="fas fa-exclamation-triangle me-2"></i>틀린 문제 재도전 ({{ wrong_questions|length }})
                            </button>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- 단어장이 비어있을 때 -->
                    <div class="text-center py-5">
                        <i class="fas fa-book text-muted mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mb-3">단어장이 비어있습니다</h4>
                        <p class="text-muted mb-4">
                            퀴즈를 시작하려면 먼저 단어를 추가해주세요.<br>
                            아래 단어 추가 섹션을 이용해 학습할 단어들을 등록하세요.
                        </p>
                        <a href="#add-word-section" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>단어 추가하기
                        </a>
                    </div>
                {% endif %}
                
                <!-- 틀린 문제 재도전 섹션 -->
                {% if has_wrong_questions %}
                <div class="mt-4">
                    <div class="card border-warning">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="text-warning mb-1">
                                        <i class="fas fa-exclamation-triangle me-2"></i>틀린 문제가 있습니다
                                    </h6>
                                    <small class="text-muted">{{ wrong_questions|length }}개의 틀린 문제를 다시 풀어보세요</small>
                                </div>
                                <a href="{{ url_for('retry_wrong_quiz', category=selected_category, language=selected_language) }}" class="btn btn-warning">
                                    <i class="fas fa-redo me-2"></i>틀린 문제 재도전
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 단어장 관리 -->
        <div class="card" id="add-word-section">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>단어 추가
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_word') }}">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">영어 단어 (여러개는 줄바꿈으로 구분)</label>
                                <textarea name="words" class="form-control" rows="5" placeholder="예:&#10;apple&#10;book&#10;cat" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">한글 뜻 (단어와 같은 순서로)</label>
                                <textarea name="meanings" class="form-control" rows="5" placeholder="예:&#10;사과&#10;책&#10;고양이" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">카테고리</label>
                                <select id="category-select" name="category" class="form-select" onchange="toggleCustomCategory()">
                                    {% if categories %}
                                        {% for category in categories %}
                                        <option value="{{ category }}">{{ category }}</option>
                                        {% endfor %}
                                        <option value="custom">새 카테고리 입력</option>
                                    {% else %}
                                        <option value="custom" selected>새 카테고리 입력</option>
                                    {% endif %}
                                </select>
                                <input type="text" id="custom-category" name="custom_category" class="form-control mt-2{% if categories %} d-none{% endif %}" placeholder="카테고리 이름을 입력하세요"{% if not categories %} required{% endif %}>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus me-1"></i>추가
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <script>
        function toggleCustomCategory() {
            const select = document.getElementById('category-select');
            const customInput = document.getElementById('custom-category');
            
            if (select.value === 'custom') {
                customInput.classList.remove('d-none');
                customInput.required = true;
                customInput.focus(); // 입력 칸에 포커스
            } else {
                customInput.classList.add('d-none');
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', function() {
            toggleCustomCategory();
        });
        
        // 퀴즈 언어 변경
        function changeQuizLanguage(language) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('language', language);
            window.location.search = urlParams.toString();
        }
        
        // 단어 저장 모달 표시
        function showSaveWordModal(word, meaning) {
            document.getElementById('save-word').value = word;
            document.getElementById('save-meaning').value = meaning;
            
            const modal = new bootstrap.Modal(document.getElementById('saveWordModal'));
            modal.show();
        }
        
        // 단어 저장
        function saveWordToBank() {
            const word = document.getElementById('save-word').value;
            const meaning = document.getElementById('save-meaning').value;
            const category = document.getElementById('save-category').value;
            const customCategory = document.getElementById('save-custom-category').value;
            
            const finalCategory = category === 'custom' ? customCategory : category;
            
            if (!finalCategory) {
                alert('카테고리를 선택하거나 입력해주세요.');
                return;
            }
            
            // AJAX로 단어 저장
            fetch('/save_word_from_quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    word: word,
                    meaning: meaning,
                    category: finalCategory
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 메시지 표시
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; width: 300px;';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // 3초 후 자동으로 제거
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 3000);
                    
                    // 모달 닫기
                    const modal = bootstrap.Modal.getInstance(document.getElementById('saveWordModal'));
                    modal.hide();
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('단어 저장 중 오류가 발생했습니다.');
            });
        }
        
        // 카테고리 선택 변경
        function toggleSaveCategory() {
            const select = document.getElementById('save-category');
            const customInput = document.getElementById('save-custom-category');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // 단어 발음 재생 함수
        function speakWord(word, button) {
            if ('speechSynthesis' in window) {
                // 기존 발화 중지
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // 버튼 상태 변경
                if (button) {
                    button.disabled = true;
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>재생 중...';
                    
                    utterance.onend = function() {
                        button.disabled = false;
                        button.innerHTML = originalHTML;
                    };
                }
                
                speechSynthesis.speak(utterance);
            } else {
                alert('이 브라우저는 음성 재생을 지원하지 않습니다.');
            }
        }
        </script>
    </div>

    <!-- 단어 저장 모달 -->
    <div class="modal fade" id="saveWordModal" tabindex="-1" aria-labelledby="saveWordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveWordModalLabel">
                        <i class="fas fa-bookmark me-2"></i>단어 저장하기
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saveWordForm">
                        <div class="mb-3">
                            <label for="save-word" class="form-label">단어</label>
                            <input type="text" class="form-control" id="save-word" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="save-meaning" class="form-label">뜻</label>
                            <input type="text" class="form-control" id="save-meaning" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="save-category" class="form-label">카테고리</label>
                            <select class="form-select" id="save-category" onchange="toggleSaveCategory()">
                                {% if categories %}
                                    {% for category in categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                    {% endfor %}
                                    <option value="custom">새 카테고리 입력</option>
                                {% else %}
                                    <option value="custom" selected>새 카테고리 입력</option>
                                {% endif %}
                            </select>
                            <input type="text" id="save-custom-category" class="form-control mt-2" 
                                   placeholder="새 카테고리 이름" style="display: none;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="saveWordToBank()">
                        <i class="fas fa-save me-1"></i>저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- 퀴즈 통계 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>퀴즈 통계
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-6">
                        <div class="border-end">
                            <h3 class="text-primary">{{ player['총_퀴즈'] }}</h3>
                            <small class="text-muted">총 문제 수</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h3 class="text-success">{{ player['정답_퀴즈'] }}</h3>
                        <small class="text-muted">정답 수</small>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    {% set accuracy = (player['정답_퀴즈'] / player['총_퀴즈'] * 100) if player['총_퀴즈'] > 0 else 0 %}
                    <h4 class="text-warning">{{ "%.1f"|format(accuracy) }}%</h4>
                    <small class="text-muted">정답률</small>
                </div>
            </div>
        </div>

        <!-- 단어장 현황 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>단어장 현황
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h3 class="text-info">{{ full_word_bank|length }}</h3>
                    <small class="text-muted">등록된 단어 수</small>
                </div>
                
                <h6 class="mb-2">카테고리별</h6>
                {% for category in categories %}
                    {% set category_count = full_word_bank|selectattr('카테고리', 'equalto', category)|list|length %}
                    <div class="d-flex justify-content-between mb-1">
                        <small>{{ category }}</small>
                        <small class="text-muted">{{ category_count }}개</small>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- 학습 팁 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>학습 팁
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <small>꾸준히 퀴즈를 풀어 경험치를 모으세요.</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <small>새로운 단어를 추가해서 학습량을 늘리세요.</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <small>기력이 없으면 잠을 자서 회복하세요.</small>
                    </li>
                    <li>
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <small>카테고리별로 단어를 정리하면 효율적입니다.</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
