{% extends "base.html" %}

{% block title %}몬스터 합성{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 타이틀 섹션 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-wand-magic-sparkles me-2"></i>몬스터 합성</h2>
                <a href="{{ url_for('compendium') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>도감으로 돌아가기
                </a>
            </div>
            <small class="text-muted">같은 등급의 몬스터 3마리를 선택하여 더 강한 몬스터로 합성할 수 있습니다! (등급에 따라 확률이 다릅니다)</small>
        </div>
    </div>

    {% if player.get('도감') %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0 text-dark"><i class="fas fa-info-circle me-2"></i>합성 규칙</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>같은 등급 3마리</strong>를 선택해야 합성 가능합니다</li>
                        <li>등급별 상위 등급 획득 확률:
                            <ul class="mt-2">
                                <li><strong>레어</strong>: 30% 확률로 에픽 획득, 70% 확률로 레어 획득</li>
                                <li><strong>에픽</strong>: 20% 확률로 유니크 획득, 80% 확률로 에픽 획득</li>
                                <li><strong>유니크</strong>: 10% 확률로 레전드리 획득, 90% 확률로 유니크 획득</li>
                            </ul>
                        </li>
                        <li><strong>레전드리 3마리</strong> 합성 시 30% 확률로 <strong>신화급</strong> 몬스터, 70% 확률로 레전드리 몬스터 획득 (신화급은 포획 불가능한 특별한 몬스터!)</li>
                        <li>합성한 몬스터는 기존 3마리를 대신하여 도감에 추가됩니다</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 합성 효과음 (Web Audio API로 생성) -->

    <!-- 등급별 몬스터 선택 -->
    <form method="POST" action="{{ url_for('perform_fusion') }}" id="fusion-form">
        {% for rarity in ['레어', '에픽', '유니크', '레전드리'] %}
            {% if monsters_by_rarity.get(rarity) %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-{% if rarity == '레어' %}success{% elif rarity == '에픽' %}primary{% elif rarity == '유니크' %}warning{% else %}danger{% endif %} shadow-sm">
                        <div class="card-header bg-{% if rarity == '레어' %}success{% elif rarity == '에픽' %}primary{% elif rarity == '유니크' %}warning{% else %}danger{% endif %}">
                            <h5 class="mb-0 text-white"><i class="fas fa-star me-2"></i>{{ rarity }} ({{ monsters_by_rarity[rarity]|length }}마리)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for monster in monsters_by_rarity[rarity] %}
                                <div class="col-4">
                                    <div class="card h-100 monster-selection-card">
                                        <div class="card-body text-center">
                                            {% if compendium[monster.id].get('이미지') %}
                                            <img src="{{ compendium[monster.id]['이미지'] }}" alt="{{ monster.name }}" 
                                                 style="width: 150px; height: 150px; object-fit: contain; margin-bottom: 15px;">
                                            {% else %}
                                            <div style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 3rem; color: #ccc;">
                                                <i class="fas fa-dragon"></i>
                                            </div>
                                            {% endif %}
                                            
                                            <h6 class="mb-3">{{ monster.name }}</h6>
                                            <div class="mb-3">
                                                <small class="text-muted d-block">공격력: {{ compendium[monster.id].get('공격력', 0) }}</small>
                                                <small class="text-muted d-block">체력: {{ compendium[monster.id].get('체력', 0) }}</small>
                                            </div>
                                            
                                            <div class="form-check">
                                                <input class="form-check-input rarity-checkbox" type="checkbox" 
                                                       name="selected_monsters" value="{{ monster.id }}" 
                                                       data-rarity="{{ rarity }}"
                                                       id="monster_{{ monster.id }}">
                                                <label class="form-check-label" for="monster_{{ monster.id }}">
                                                    선택
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <!-- 선택 상태 및 합성 버튼 -->
        <div class="row sticky-bottom bg-light border-top p-3">
            <div class="col-12 text-center">
                <div class="mb-3">
                    <span class="badge bg-info" id="selection-count">선택: 0/3</span>
                    <span class="badge bg-warning" id="selection-rarity" style="display:none;"></span>
                </div>
                <button type="submit" class="btn btn-warning btn-lg" id="fusion-btn" disabled>
                    <i class="fas fa-wand-magic-sparkles me-2"></i>몬스터 합성
                </button>
            </div>
        </div>
    </form>

    {% else %}
    <!-- 빈 도감 메시지 -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm text-center py-5">
                <div class="card-body">
                    <i class="fas fa-book-open text-muted mb-3" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3">도감이 비어있습니다</h4>
                    <p class="text-muted mb-4">던전에서 몬스터를 처치하여 도감을 채워보세요!</p>
                    <a href="{{ url_for('dungeons') }}" class="btn btn-primary">
                        <i class="fas fa-dungeon me-1"></i>던전으로 가기
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- 합성 결과 상태 플래그 -->
    <div id="fusion-status" data-upgraded="{{ fusion_upgraded|lower }}" data-mythic="{{ fusion_mythic|lower }}" style="display:none;"></div>
</div>

<style>
.monster-selection-card {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.monster-selection-card:hover {
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.monster-selection-card .form-check-input:checked ~ .form-check-label {
    color: #0d6efd;
}

.monster-selection-card .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.rarity-checkbox:checked {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
}

.sticky-bottom {
    position: sticky;
    bottom: 0;
    z-index: 10;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.rarity-checkbox');
    const selectionCount = document.getElementById('selection-count');
    const selectionRarity = document.getElementById('selection-rarity');
    const fusionBtn = document.getElementById('fusion-btn');
    const fusionForm = document.getElementById('fusion-form');
    const fusionSound = document.getElementById('fusion-sound');

    function updateSelection() {
        const selectedCheckboxes = document.querySelectorAll('.rarity-checkbox:checked');
        const count = selectedCheckboxes.length;
        
        selectionCount.textContent = `선택: ${count}/3`;
        
        if (count > 0) {
            const rarities = new Set();
            selectedCheckboxes.forEach(cb => {
                rarities.add(cb.dataset.rarity);
            });
            
            if (rarities.size === 1) {
                const rarity = Array.from(rarities)[0];
                selectionRarity.textContent = `등급: ${rarity}`;
                selectionRarity.style.display = 'inline-block';
                
                if (count === 3) {
                    fusionBtn.disabled = false;
                } else {
                    fusionBtn.disabled = true;
                }
            } else {
                selectionRarity.textContent = '등급이 다릅니다!';
                selectionRarity.style.display = 'inline-block';
                selectionRarity.classList.add('bg-danger');
                selectionRarity.classList.remove('bg-warning');
                fusionBtn.disabled = true;
            }
        } else {
            selectionRarity.style.display = 'none';
            fusionBtn.disabled = true;
        }
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelection);
    });

    // 빨려들어가는 합성 효과음 생성 (Web Audio API)
    function playSuctionSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioContext.currentTime;
            
            // Oscillator (주파수 감소: 2000Hz -> 200Hz)
            const osc = audioContext.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(2000, now);
            osc.frequency.exponentialRampToValueAtTime(200, now + 0.4);
            
            // Gain (음량 감소)
            const gain = audioContext.createGain();
            gain.gain.setValueAtTime(0.4, now);  // 높은 음량
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            // 필터 (고주파 강화)
            const filter = audioContext.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(500, now);
            filter.frequency.exponentialRampToValueAtTime(100, now + 0.4);
            
            // 연결
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);
            
            // 재생
            osc.start(now);
            osc.stop(now + 0.4);
        } catch (e) {
            console.log('효과음 생성 실패:', e);
        }
    }

    // 합성 버튼 클릭 시 효과음 재생
    fusionBtn.addEventListener('click', function(e) {
        playSuctionSound();
    });

    // 용의 울음소리 + 진화 음성 생성 (더 높은 등급 또는 신화급 획득 시)
    function playVictorySound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioContext.currentTime;
            
            // 1단계: 터지는 용의 울음 (낮은 음 + 노이즈)
            // 저음 기본음
            const dragonOsc = audioContext.createOscillator();
            dragonOsc.type = 'sawtooth';
            dragonOsc.frequency.setValueAtTime(80, now);
            dragonOsc.frequency.exponentialRampToValueAtTime(200, now + 0.3);
            
            const dragonGain = audioContext.createGain();
            dragonGain.gain.setValueAtTime(0.6, now);
            dragonGain.gain.exponentialRampToValueAtTime(0.1, now + 0.3);
            
            // 저음 필터
            const lowFilter = audioContext.createBiquadFilter();
            lowFilter.type = 'lowpass';
            lowFilter.frequency.setValueAtTime(300, now);
            lowFilter.frequency.exponentialRampToValueAtTime(150, now + 0.3);
            
            dragonOsc.connect(lowFilter);
            lowFilter.connect(dragonGain);
            dragonGain.connect(audioContext.destination);
            dragonOsc.start(now);
            dragonOsc.stop(now + 0.3);
            
            // 2단계: 폭발음 (고주파 버스트)
            const burstOsc = audioContext.createOscillator();
            burstOsc.type = 'square';
            burstOsc.frequency.setValueAtTime(800, now + 0.2);
            burstOsc.frequency.exponentialRampToValueAtTime(1600, now + 0.35);
            
            const burstGain = audioContext.createGain();
            burstGain.gain.setValueAtTime(0.4, now + 0.2);
            burstGain.gain.exponentialRampToValueAtTime(0.05, now + 0.35);
            
            burstOsc.connect(burstGain);
            burstGain.connect(audioContext.destination);
            burstOsc.start(now + 0.2);
            burstOsc.stop(now + 0.35);
            
            // 3단계: 진화 음성 (상승하는 밝은 톤)
            const evolveOsc = audioContext.createOscillator();
            evolveOsc.type = 'sine';
            // 상승하는 음정: 600Hz -> 1200Hz -> 1800Hz
            evolveOsc.frequency.setValueAtTime(600, now + 0.35);
            evolveOsc.frequency.exponentialRampToValueAtTime(1200, now + 0.7);
            evolveOsc.frequency.exponentialRampToValueAtTime(1800, now + 1.0);
            
            const evolveGain = audioContext.createGain();
            evolveGain.gain.setValueAtTime(0, now + 0.35);
            evolveGain.gain.linearRampToValueAtTime(0.5, now + 0.4);
            evolveGain.gain.exponentialRampToValueAtTime(0.01, now + 1.0);
            
            evolveOsc.connect(evolveGain);
            evolveGain.connect(audioContext.destination);
            evolveOsc.start(now + 0.35);
            evolveOsc.stop(now + 1.0);
            
            // 4단계: 진화 완료 반짝임 (고음 피크)
            const sparkOsc = audioContext.createOscillator();
            sparkOsc.type = 'sine';
            sparkOsc.frequency.setValueAtTime(2000, now + 0.95);
            
            const sparkGain = audioContext.createGain();
            sparkGain.gain.setValueAtTime(0, now + 0.95);
            sparkGain.gain.linearRampToValueAtTime(0.3, now + 0.98);
            sparkGain.gain.exponentialRampToValueAtTime(0.01, now + 1.3);
            
            sparkOsc.connect(sparkGain);
            sparkGain.connect(audioContext.destination);
            sparkOsc.start(now + 0.95);
            sparkOsc.stop(now + 1.3);
            
        } catch (e) {
            console.log('진화 음성 생성 실패:', e);
        }
    }

    // 페이지 로드 시 합성 결과 확인
    const fusionStatus = document.getElementById('fusion-status');
    if (fusionStatus) {
        const upgraded = fusionStatus.getAttribute('data-upgraded') === 'true';
        const mythic = fusionStatus.getAttribute('data-mythic') === 'true';
        
        if (upgraded || mythic) {
            // 페이지 로드 후 빠르게 음성 재생 (100ms)
            setTimeout(function() {
                playVictorySound();
            }, 100);
        }
    }
});
</script>
{% endblock %}
