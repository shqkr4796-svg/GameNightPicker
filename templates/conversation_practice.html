{% extends "base.html" %}

{% block title %}ëŒ€í™” ì—°ìŠµ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<style>
    .conversation-container {
        max-width: 850px;
        margin: 0 auto;
    }
    
    .progress-bar-custom {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s;
    }
    
    .speaker-message {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }
    
    .user-prompt {
        background: #fff8e7;
        border-left: 4px solid #ff9900;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }
    
    .response-text {
        font-size: 1.1rem;
        font-weight: bold;
        color: #0066cc;
        margin: 10px 0;
        word-break: break-word;
    }
    
    .meaning-text {
        font-size: 0.9rem;
        color: #666;
        margin-top: 8px;
        font-style: italic;
    }
    
    .user-prompt .response-text {
        color: #ff6600;
    }
    
    .status-box {
        background: #f0f8ff;
        border: 2px dashed #0066cc;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
        text-align: center;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .status-success {
        background: #d4edda;
        border: 1px solid #28a745;
        color: #155724;
    }
    
    .status-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .conversation-history {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
    }
    
    .history-item {
        margin-bottom: 12px;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.95rem;
    }
    
    .history-ai {
        background: #e7f3ff;
        border-left: 3px solid #0066cc;
    }
    
    .history-user {
        background: #fff8e7;
        border-left: 3px solid #ff9900;
        margin-left: 20px;
    }
</style>

<div class="row">
    <div class="col-12 col-lg-8 offset-lg-2 conversation-container">
        <!-- í—¤ë” -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-microphone me-2"></i>ë“œë¼ë§ˆ/ì• ë‹ˆ íšŒí™” ì—°ìŠµ
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>ğŸ“ ì¥ë©´:</strong> {{ scenario }}</p>
                <p class="mb-3"><strong>ğŸ—£ï¸ ê°•ì‚¬:</strong> {{ speaker.name }}</p>
                
                <!-- ì§„í–‰ë„ í‘œì‹œ -->
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <small class="text-muted">í„´ ì§„í–‰ ìƒí™©</small>
                    <small class="text-muted"><span id="turnNumber">{{ turn_number }}</span> / <span id="totalTurns">{{ total_turns }}</span></small>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressBar" style="width: {{ (turn_number / total_turns * 100)|int }}%"></div>
                </div>
            </div>
        </div>

        <!-- ëŒ€í™” ì´ë ¥ -->
        <div id="conversationHistory" class="conversation-history" style="display: none;">
            <small class="text-muted d-block mb-3">ğŸ“œ ëŒ€í™” ì´ë ¥</small>
            <div id="historyContent"></div>
        </div>

        <!-- í˜„ì¬ í„´ ëŒ€í™” -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- ìƒëŒ€ë°©(AI) ëŒ€ì‚¬ -->
                <div class="row mb-4">
                    <div class="col-12 col-sm-3 text-center mb-3 mb-sm-0">
                        <img src="{{ url_for('static', filename='images/' + speaker.image) }}" alt="{{ speaker.name }}" style="width: 100%; max-width: 120px; border-radius: 10px;">
                        <p class="text-muted mt-2 mb-0"><strong>{{ speaker.name }}</strong></p>
                    </div>
                    <div class="col-12 col-sm-9">
                        <div class="speaker-message">
                            <small class="text-muted">ìƒëŒ€ë°© ëŒ€ì‚¬:</small>
                            <div class="response-text" id="aiPromptText">{{ current_turn.ai_prompt }}</div>
                            <div class="meaning-text" id="aiMeaningText">{{ current_turn.ai_meaning }}</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="playAudio()" data-voice="{{ speaker.voice }}">
                            <i class="fas fa-play me-1"></i>ì¬ìƒ
                        </button>
                        <small id="playingStatus" class="text-muted ms-2" style="display: none;">ğŸ”Š ì¬ìƒ ì¤‘...</small>
                    </div>
                </div>

                <hr class="my-4">

                <!-- ì‚¬ìš©ìê°€ ë§í•´ì•¼ í•  ë¬¸ì¥ -->
                <div class="user-prompt">
                    <small class="text-muted">ë‹¹ì‹ ì´ ë§í•´ì•¼ í•  ëŒ€ì‚¬:</small>
                    <div class="response-text" id="userResponseText">{{ current_turn.user_response }}</div>
                    <div class="meaning-text" id="userMeaningText">{{ current_turn.user_meaning }}</div>
                </div>

                <!-- ìŒì„± ì¸ì‹ ì„¹ì…˜ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label"><strong>ğŸ¤ ìŒì„± ì¸ì‹:</strong></label>
                            <button type="button" id="micBtn" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-microphone me-2"></i>ìŒì„± ì¸ì‹ ì‹œì‘
                            </button>
                            <button type="button" id="stopBtn" class="btn btn-danger w-100 mb-2" style="display: none;">
                                <i class="fas fa-stop me-2"></i>ìŒì„± ì¸ì‹ ì¤‘ì§€
                            </button>
                            <div id="recognizedText" class="alert alert-info" style="display: none; min-height: 70px;">
                                <p class="text-muted small mb-1">ì¸ì‹ëœ ë‚´ìš©:</p>
                                <p id="textContent" class="mb-0"></p>
                            </div>
                            <div id="statusMessage" class="alert alert-secondary" style="display: none;">
                                <small id="statusText"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê²°ê³¼ í”¼ë“œë°± -->
                <div id="resultFeedback" style="display: none;" class="mb-4">
                    <div id="resultMessage" class="alert"></div>
                </div>

                <!-- ë‹¤ìŒ í„´ ë²„íŠ¼ (ì •ë‹µ í›„ ë‚˜íƒ€ë‚¨) -->
                <div id="nextTurnContainer" style="display: none;" class="button-group">
                    <button type="button" id="nextTurnBtn" class="btn btn-success flex-grow-1">
                        <i class="fas fa-arrow-right me-2"></i><span id="nextBtnText">ë‹¤ìŒ ëŒ€ì‚¬ë¡œ</span>
                    </button>
                </div>

                <!-- ì™„ë£Œ ë²„íŠ¼ (ë§ˆì§€ë§‰ í„´ í›„ ë‚˜íƒ€ë‚¨) -->
                <div id="completionContainer" style="display: none;" class="button-group">
                    <a href="{{ url_for('index') }}" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-home me-2"></i>í™ˆìœ¼ë¡œ
                    </a>
                    <a href="{{ url_for('conversation_practice') }}" class="btn btn-success flex-grow-1">
                        <i class="fas fa-redo me-2"></i>ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤
                    </a>
                </div>
            </div>
        </div>

        <!-- í•™ìŠµ íŒ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ’¡ í•™ìŠµ íŒ</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>ìƒëŒ€ë°©ì˜ ëŒ€ì‚¬ë¥¼ ì½ê³  ì˜ë¯¸ë¥¼ ì´í•´í•˜ì„¸ìš”</li>
                    <li>ë‹¹ì‹ ì´ ë§í•´ì•¼ í•  ëŒ€ì‚¬ë¥¼ ì½ê³  ìŒì„±ìœ¼ë¡œ ë§í•´ë³´ì„¸ìš”</li>
                    <li>ìŒì„± ì¸ì‹ ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ì •í™•í•˜ê²Œ ëŒ€ì‚¬ë¥¼ ë§í•˜ì„¸ìš”</li>
                    <li>ì •ë‹µí•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ í„´ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤</li>
                    <li>ê° í„´ë§ˆë‹¤ ì •ë‹µ ì‹œ ê²½í—˜ì¹˜ +10ì„ íšë“í•©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// ê¸€ë¡œë²Œ ë³€ìˆ˜
let cachedVoices = {
    'female1': null, 'female2': null, 'female3': null, 'female4': null, 'female5': null, 'female6': null,
    'male1': null, 'male2': null, 'male3': null, 'male4': null, 'male5': null
};
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let isListening = false;

// ìŒì„± ë¡œë“œ
function loadAllVoices() {
    if ('speechSynthesis' in window) {
        const voices = window.speechSynthesis.getVoices();
        const enVoices = voices.filter(v => v.lang === 'en-US');
        
        // ì—¬ì„± ìŒì„±ë“¤
        const femaleNames = ['Zira', 'Samantha', 'Victoria', 'Moira', 'Fiona', 'Karen'];
        const maleNames = ['David', 'Mark', 'Daniel', 'Tom', 'George'];
        
        let femaleIdx = 0, maleIdx = 0;
        
        for (let voice of enVoices) {
            if (voice.name.includes('Female') || femaleNames.some(n => voice.name.includes(n))) {
                if (femaleIdx < 6) cachedVoices[`female${femaleIdx + 1}`] = voice;
                femaleIdx++;
            } else if (voice.name.includes('Male') || maleNames.some(n => voice.name.includes(n))) {
                if (maleIdx < 5) cachedVoices[`male${maleIdx + 1}`] = voice;
                maleIdx++;
            }
        }
        
        // í´ë°±: ì¼ë°˜ ìŒì„±ìœ¼ë¡œ ì±„ìš°ê¸°
        for (let i = 1; i <= 6; i++) {
            if (!cachedVoices[`female${i}`] && enVoices.length > 0) cachedVoices[`female${i}`] = enVoices[0];
        }
        for (let i = 1; i <= 5; i++) {
            if (!cachedVoices[`male${i}`] && enVoices.length > 0) cachedVoices[`male${i}`] = enVoices[0];
        }
    }
}

if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = loadAllVoices;
    loadAllVoices();
}

// ìŒì„± ì¬ìƒ (ìºë¦­í„°ë³„ ìŒì„± ì§€ì›)
function playAudio(textOrElement) {
    let text = textOrElement;
    
    // ì¸ìê°€ ì—†ê±°ë‚˜ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°, í˜„ì¬ AI ëŒ€ì‚¬ ì‚¬ìš©
    if (!textOrElement || typeof textOrElement !== 'string') {
        text = document.getElementById('aiPromptText').textContent;
    }
    
    // ì¬ìƒ ë²„íŠ¼ì˜ voice ì†ì„± ê°€ì ¸ì˜¤ê¸°
    const playBtn = event?.target?.closest('button') || document.querySelector('[data-voice]');
    const voiceType = playBtn?.getAttribute('data-voice') || 'female1';
    
    if (text && 'speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        
        // ì¬ìƒ ìƒíƒœ í‘œì‹œ
        const playingStatus = document.getElementById('playingStatus');
        playingStatus.style.display = 'inline';
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        if (cachedVoices[voiceType]) utterance.voice = cachedVoices[voiceType];
        
        // ì¬ìƒ ëë‚˜ë©´ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¹€
        utterance.onend = function() {
            playingStatus.style.display = 'none';
        };
        
        window.speechSynthesis.speak(utterance);
    }
}

// ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = true;
}

document.addEventListener('DOMContentLoaded', function() {
    const micBtn = document.getElementById('micBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recognizedText = document.getElementById('recognizedText');
    const textContent = document.getElementById('textContent');
    const statusMessage = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    const resultFeedback = document.getElementById('resultFeedback');
    const resultMessage = document.getElementById('resultMessage');
    const nextTurnContainer = document.getElementById('nextTurnContainer');
    const nextTurnBtn = document.getElementById('nextTurnBtn');
    const completionContainer = document.getElementById('completionContainer');
    
    // í˜„ì¬ í„´ì˜ ì •ë‹µ (ì „ì—­ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°)
    let targetResponse = document.getElementById('userResponseText').textContent.toLowerCase().trim();
    
    if (!recognition) {
        micBtn.disabled = true;
        statusMessage.style.display = 'block';
        statusText.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        return;
    }
    
    // ìŒì„± ì¸ì‹ ì‹œì‘
    micBtn.addEventListener('click', function() {
        if (!isListening) {
            isListening = true;
            micBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            recognizedText.style.display = 'block';
            resultFeedback.style.display = 'none';
            nextTurnContainer.style.display = 'none';
            textContent.textContent = 'ìŒì„± ì¸ì‹ ì¤‘...';
            recognition.start();
        }
    });
    
    // ìŒì„± ì¸ì‹ ì¤‘ì§€
    stopBtn.addEventListener('click', function() {
        isListening = false;
        micBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        recognition.stop();
    });
    
    // ìŒì„± ì¸ì‹ ê²°ê³¼
    recognition.addEventListener('result', function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
            } else {
                interimTranscript += transcript;
            }
        }
        
        const currentText = finalTranscript || interimTranscript;
        textContent.textContent = currentText;
        
        if (finalTranscript) {
            checkAnswer(finalTranscript.toLowerCase().trim());
        }
    });
    
    // ì •ë‹µ í™•ì¸
    function checkAnswer(userInput) {
        resultFeedback.style.display = 'block';
        resultMessage.className = 'alert';
        
        const targetWords = targetResponse.split(/\s+/);
        const userWords = userInput.split(/\s+/);
        const matchedWords = targetWords.filter(w => userWords.some(uw => uw.includes(w) || w.includes(uw)));
        const matchPercentage = matchedWords.length / targetWords.length;
        
        if (matchPercentage >= 0.7 || userInput.includes(targetResponse) || targetResponse.includes(userInput)) {
            resultMessage.className = 'alert status-success';
            resultMessage.innerHTML = '<strong>âœ… ì •ë‹µì…ë‹ˆë‹¤!</strong> ì˜ í•˜ì…¨ì–´ìš”! ê²½í—˜ì¹˜ +10';
            nextTurnContainer.style.display = 'block';
            
            // ë‹¤ìŒ í„´ ë²„íŠ¼ í´ë¦­ ì‹œ
            nextTurnBtn.onclick = function() {
                loadNextTurn();
            };
        } else {
            resultMessage.className = 'alert status-error';
            resultMessage.innerHTML = `<strong>âŒ í‹€ë ¸ìŠµë‹ˆë‹¤</strong><br>ì •ë‹µ: <strong>${targetResponse}</strong>`;
        }
    }
    
    // ë‹¤ìŒ í„´ ë¡œë“œ
    function loadNextTurn() {
        fetch('{{ url_for("next_turn") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (data.is_final && data.turn_number === undefined) {
                    // ëª¨ë“  í„´ ì™„ë£Œ
                    resultFeedback.style.display = 'block';
                    resultMessage.className = 'alert alert-success';
                    resultMessage.innerHTML = '<strong>ğŸ‰ ëŒ€í™” ì—°ìŠµ ì™„ë£Œ!</strong><br>ëª¨ë“  í„´ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
                    nextTurnContainer.style.display = 'none';
                    completionContainer.style.display = 'flex';
                } else {
                    // ë‹¤ìŒ í„´ í‘œì‹œ
                    const turn = data.next_turn;
                    document.getElementById('aiPromptText').textContent = turn.ai_prompt;
                    document.getElementById('aiMeaningText').textContent = turn.ai_meaning;
                    document.getElementById('userResponseText').textContent = turn.user_response;
                    document.getElementById('userMeaningText').textContent = turn.user_meaning;
                    
                    document.getElementById('turnNumber').textContent = data.turn_number;
                    document.getElementById('totalTurns').textContent = data.total_turns;
                    const progress = (data.turn_number / data.total_turns * 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    
                    // UI ë¦¬ì…‹
                    recognizedText.style.display = 'none';
                    textContent.textContent = '';
                    resultFeedback.style.display = 'none';
                    resultMessage.innerHTML = '';
                    nextTurnContainer.style.display = 'none';
                    statusMessage.style.display = 'none';
                    
                    // ìŒì„±ì¸ì‹ ìƒíƒœ ë¦¬ì…‹
                    if (recognition) {
                        recognition.stop();
                    }
                    isListening = false;
                    micBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                    
                    // ìƒˆë¡œìš´ í„´ ì •ë‹µìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    targetResponse = turn.user_response.toLowerCase().trim();
                }
            }
        });
    }
    
    // ìŒì„± ì¸ì‹ ì—ëŸ¬
    recognition.addEventListener('error', function(event) {
        if (event.error !== 'aborted') {
            statusMessage.style.display = 'block';
            const errorMessages = {
                'no-speech': 'ìŒì„±ì„ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                'audio-capture': 'ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                'network': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                'permission-denied': 'ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'
            };
            statusText.textContent = errorMessages[event.error] || 'ì˜¤ë¥˜: ' + event.error;
        }
        isListening = false;
        micBtn.style.display = 'block';
        stopBtn.style.display = 'none';
    });
    
    recognition.addEventListener('end', function() {
        isListening = false;
        micBtn.style.display = 'block';
        stopBtn.style.display = 'none';
    });
});
</script>
{% endblock %}
