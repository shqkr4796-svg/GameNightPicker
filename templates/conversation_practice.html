{% extends "base.html" %}

{% block title %}ëŒ€í™” ì—°ìŠµ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<style>
    .conversation-container {
        max-width: 850px;
        margin: 0 auto;
    }
    
    .progress-bar-custom {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s;
    }
    
    .speaker-message {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        position: relative;
    }
    
    .user-prompt {
        background: #fff8e7;
        border-left: 4px solid #ff9900;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        position: relative;
    }
    
    .response-text {
        font-size: 1.1rem;
        font-weight: bold;
        color: #0066cc;
        margin: 10px 0;
        word-break: break-word;
    }
    
    .meaning-text {
        font-size: 0.9rem;
        color: #666;
        margin-top: 8px;
        font-style: italic;
    }
    
    .user-prompt .response-text {
        color: #ff6600;
    }
    
    .status-box {
        background: #f0f8ff;
        border: 2px dashed #0066cc;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
        text-align: center;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .status-success {
        background: #d4edda;
        border: 1px solid #28a745;
        color: #155724;
    }
    
    .status-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .play-audio-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: background 0.3s;
        z-index: 10;
    }

    .play-audio-btn:hover {
        background: #0052a3;
    }

    .play-audio-btn:active {
        transform: scale(0.95);
    }

    .play-audio-btn.playing {
        background: #ff6600;
    }
</style>

<div class="row">
    <div class="col-12 col-lg-8 offset-lg-2 conversation-container">
        <!-- í—¤ë” -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-comments me-2"></i>ë“œë¼ë§ˆ/ì• ë‹ˆ íšŒí™” ì—°ìŠµ
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>ğŸ“ ì¥ë©´:</strong> {{ scenario }}</p>
                <p class="mb-3"><strong>ğŸ—£ï¸ ê°•ì‚¬:</strong> {{ speaker.name }}</p>
                
                <!-- ì§„í–‰ë„ í‘œì‹œ -->
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <small class="text-muted">í„´ ì§„í–‰ ìƒí™©</small>
                    <small class="text-muted"><span id="turnNumber">{{ turn_number }}</span> / <span id="totalTurns">{{ total_turns }}</span></small>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressBar" style="width: {{ (turn_number / total_turns * 100)|int }}%"></div>
                </div>
            </div>
        </div>

        <!-- í˜„ì¬ í„´ ëŒ€í™” -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- ìƒëŒ€ë°©(AI) ëŒ€ì‚¬ -->
                <div class="row mb-4">
                    <div class="col-12 col-sm-3 text-center mb-3 mb-sm-0">
                        <img src="{{ url_for('static', filename='images/' + speaker.image) }}" alt="{{ speaker.name }}" style="width: 100%; max-width: 120px; border-radius: 10px;">
                        <p class="text-muted mt-2 mb-0"><strong>{{ speaker.name }}</strong></p>
                    </div>
                    <div class="col-12 col-sm-9">
                        <div class="speaker-message">
                            <button class="play-audio-btn" id="playAudioBtnAI" title="ìŒì„± ë“£ê¸°">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <small class="text-muted">ìƒëŒ€ë°© ëŒ€ì‚¬:</small>
                            <div class="response-text" id="aiPromptText">{{ current_turn.ai_prompt }}</div>
                            <div class="meaning-text" id="aiMeaningText">{{ current_turn.ai_meaning }}</div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- ì‚¬ìš©ìê°€ ë§í•´ì•¼ í•  ë¬¸ì¥ -->
                <div class="user-prompt">
                    <button class="play-audio-btn" id="playAudioBtnUser" title="ìŒì„± ë“£ê¸°">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <small class="text-muted">ë‹¹ì‹ ì´ ë§í•´ì•¼ í•  ëŒ€ì‚¬:</small>
                    <div class="response-text" id="userResponseText">{{ current_turn.user_response }}</div>
                    <div class="meaning-text" id="userMeaningText">{{ current_turn.user_meaning }}</div>
                </div>

                <!-- ê²°ê³¼ í”¼ë“œë°± -->
                <div id="resultFeedback" style="display: none;" class="mb-4">
                    <div id="resultMessage" class="alert"></div>
                </div>

                <!-- ë‹¤ìŒ í„´ ë²„íŠ¼ (ì •ë‹µ í›„ ë‚˜íƒ€ë‚¨) -->
                <div id="nextTurnContainer" style="display: none;" class="button-group">
                    <button type="button" id="nextTurnBtn" class="btn btn-success flex-grow-1">
                        <i class="fas fa-arrow-right me-2"></i>ë‹¤ìŒ ëŒ€ì‚¬ë¡œ
                    </button>
                </div>

                <!-- ì™„ë£Œ ë²„íŠ¼ (ë§ˆì§€ë§‰ í„´ í›„ ë‚˜íƒ€ë‚¨) -->
                <div id="completionContainer" style="display: none;" class="button-group">
                    <a href="{{ url_for('index') }}" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-home me-2"></i>í™ˆìœ¼ë¡œ
                    </a>
                    <a href="{{ url_for('conversation_practice') }}" class="btn btn-success flex-grow-1">
                        <i class="fas fa-redo me-2"></i>ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤
                    </a>
                </div>
            </div>
        </div>

        <!-- í•™ìŠµ íŒ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ’¡ í•™ìŠµ íŒ</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>ìƒëŒ€ë°© ëŒ€ì‚¬ì˜ ğŸ”Š ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ ìŒì„±ì„ ë“¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    <li>ë‹¹ì‹ ì˜ ëŒ€ì‚¬ë„ ğŸ”Š ë²„íŠ¼ìœ¼ë¡œ ë°œìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    <li>ìƒëŒ€ë°©ì˜ ë°œìŒì„ ì£¼ì˜ê¹Šê²Œ ë“¤ì–´ë³´ì„¸ìš”</li>
                    <li>ë‹¹ì‹ ì´ ë§í•´ì•¼ í•  ëŒ€ì‚¬ë¥¼ ì½ê³  ë”°ë¼ ë§í•´ë³´ì„¸ìš”</li>
                    <li>ê° í„´ë§ˆë‹¤ ì™„ë£Œ ì‹œ ê²½í—˜ì¹˜ +10ì„ íšë“í•©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Speaker ì •ë³´ë¥¼ JavaScriptì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥ -->
<script>
const speakerData = {
    name: '{{ speaker.name }}',
    gender: '{{ speaker.gender }}'
};

document.addEventListener('DOMContentLoaded', function() {
    const resultFeedback = document.getElementById('resultFeedback');
    const resultMessage = document.getElementById('resultMessage');
    const nextTurnContainer = document.getElementById('nextTurnContainer');
    const nextTurnBtn = document.getElementById('nextTurnBtn');
    const completionContainer = document.getElementById('completionContainer');
    const playAudioBtnAI = document.getElementById('playAudioBtnAI');
    const playAudioBtnUser = document.getElementById('playAudioBtnUser');
    const aiPromptText = document.getElementById('aiPromptText');
    const userResponseText = document.getElementById('userResponseText');
    
    let targetResponse = document.getElementById('userResponseText').textContent.toLowerCase().trim();
    
    // ìŒì„± ì¬ìƒ - ìƒëŒ€ë°© ëŒ€ì‚¬
    playAudioBtnAI.addEventListener('click', function(e) {
        e.stopPropagation();
        const text = aiPromptText.textContent.trim();
        playAudioBtnAI.classList.add('playing');
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        utterance.onend = function() {
            playAudioBtnAI.classList.remove('playing');
        };
        
        const voices = window.speechSynthesis.getVoices();
        if (speakerData.gender === 'female') {
            const femaleVoice = voices.find(voice => 
                voice.name.includes('female') || voice.name.includes('woman') || voice.voiceURI.includes('female')
            ) || voices[0];
            if (femaleVoice) utterance.voice = femaleVoice;
        } else if (speakerData.gender === 'male') {
            const maleVoice = voices.find(voice => 
                voice.name.includes('Google US English Male') || voice.name.includes('Male') || 
                voice.name.includes('male') || voice.name.includes('man') || voice.name.includes('Aaron') ||
                voice.name.includes('Daniel') || voice.name.includes('George') ||
                (voice.voiceURI.includes('male') && !voice.voiceURI.includes('female'))
            );
            if (maleVoice) {
                utterance.voice = maleVoice;
            } else if (voices.length > 1) {
                utterance.voice = voices.find(v => !v.name.includes('female') && !v.name.includes('woman')) || voices[0];
            }
        }
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    });

    // ìŒì„± ì¬ìƒ - ì‚¬ìš©ì ëŒ€ì‚¬
    playAudioBtnUser.addEventListener('click', function(e) {
        e.stopPropagation();
        const text = userResponseText.textContent.trim();
        playAudioBtnUser.classList.add('playing');
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        utterance.onend = function() {
            playAudioBtnUser.classList.remove('playing');
        };
        
        const voices = window.speechSynthesis.getVoices();
        const femaleVoice = voices.find(v => v.name.includes('female') || v.name.includes('woman')) || voices[0];
        if (femaleVoice) utterance.voice = femaleVoice;
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    });
    
    // ë‹¤ìŒ í„´ ë¡œë“œ
    function loadNextTurn() {
        window.speechSynthesis.cancel();
        
        fetch('{{ url_for("next_turn") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (data.is_final && data.turn_number === undefined) {
                    resultFeedback.style.display = 'block';
                    resultMessage.className = 'alert alert-success';
                    resultMessage.innerHTML = '<strong>ğŸ‰ ëŒ€í™” ì—°ìŠµ ì™„ë£Œ!</strong><br>ëª¨ë“  í„´ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
                    nextTurnContainer.style.display = 'none';
                    completionContainer.style.display = 'flex';
                } else {
                    const turn = data.next_turn;
                    aiPromptText.textContent = turn.ai_prompt;
                    document.getElementById('aiMeaningText').textContent = turn.ai_meaning;
                    userResponseText.textContent = turn.user_response;
                    document.getElementById('userMeaningText').textContent = turn.user_meaning;
                    
                    document.getElementById('turnNumber').textContent = data.turn_number;
                    document.getElementById('totalTurns').textContent = data.total_turns;
                    const progress = (data.turn_number / data.total_turns * 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    
                    resultFeedback.style.display = 'none';
                    resultMessage.innerHTML = '';
                    nextTurnContainer.style.display = 'none';
                    playAudioBtnAI.classList.remove('playing');
                    playAudioBtnUser.classList.remove('playing');
                    
                    targetResponse = turn.user_response.toLowerCase().trim();
                }
            }
        });
    }
    
    nextTurnBtn.addEventListener('click', function() {
        loadNextTurn();
    });
    
    // í˜ì´ì§€ ë¡œë“œ í›„ ì•ˆë‚´ ë©”ì‹œì§€
    resultFeedback.style.display = 'block';
    resultMessage.className = 'alert alert-info';
    resultMessage.innerHTML = '<strong>ğŸ“– ëŒ€í™” ì—°ìŠµ ê°€ì´ë“œ</strong><br>ìœ„ì˜ ëŒ€ì‚¬ë¥¼ ì½ê³  ğŸ”Š ë²„íŠ¼ìœ¼ë¡œ ë°œìŒì„ ë“¤ì–´ë³´ì„¸ìš”. ì¤€ë¹„ê°€ ë˜ë©´ "ë‹¤ìŒ ëŒ€ì‚¬ë¡œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.';
    nextTurnContainer.style.display = 'block';
});
</script>
{% endblock %}
