{% extends "base.html" %}

{% block title %}ëŒ€í™” ì—°ìŠµ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<style>
    .conversation-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .speaker-message {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }
    
    .user-message {
        background: #fff8e7;
        border-left: 4px solid #ff9900;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }
    
    .response-prompt {
        background: #f0f8ff;
        border: 2px dashed #0066cc;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
        text-align: center;
    }
    
    .response-text {
        font-size: 1.2rem;
        font-weight: bold;
        color: #0066cc;
        margin: 10px 0;
    }
    
    .meaning-text {
        font-size: 0.9rem;
        color: #666;
        margin-top: 8px;
        font-style: italic;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .status-success {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
    }
    
    .status-error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .status-info {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
</style>

<div class="row">
    <div class="col-12 col-lg-8 offset-lg-2 conversation-container">
        <!-- í—¤ë” -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-microphone me-2"></i>ë“œë¼ë§ˆ/ì• ë‹ˆ íšŒí™” ì—°ìŠµ
                </h4>
            </div>
            <div class="card-body text-center">
                <p class="text-muted mb-2"><strong>ì¥ë©´:</strong> {{ drama_data.scene }}</p>
                <p class="text-muted mb-0">ìŒì„±ìœ¼ë¡œ ëŒ€ì‚¬ë¥¼ ë§í•´ì„œ ì •ë‹µí•˜ì„¸ìš”!</p>
            </div>
        </div>

        <!-- ëŒ€í™” ë°•ìŠ¤ -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- ì™¸êµ­ì¸(AI) ì²« ë²ˆì§¸ ëŒ€ì‚¬ -->
                <div class="row mb-4">
                    <div class="col-12 col-sm-3 text-center mb-3 mb-sm-0">
                        <img src="{{ url_for('static', filename='images/' + speaker.image) }}" alt="{{ speaker.name }}" style="width: 100%; max-width: 120px; border-radius: 10px;">
                        <p class="text-muted mt-2 mb-0"><strong>{{ speaker.name }}</strong></p>
                    </div>
                    <div class="col-12 col-sm-9">
                        <div class="speaker-message">
                            <div class="response-text">{{ drama_data.ai_prompt }}</div>
                            <div class="meaning-text">{{ drama_data.ai_meaning }}</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="playAudio('{{ drama_data.ai_prompt }}')">
                            <i class="fas fa-play me-1"></i>ì¬ìƒ
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                <!-- ì‚¬ìš©ìê°€ ë§í•´ì•¼ í•  ë¬¸ì¥ -->
                <div class="response-prompt" id="responsePromptContainer">
                    <h6 class="mb-3">ğŸ’¬ ë‹¹ì‹ ì´ ë§í•´ì•¼ í•  ëŒ€ì‚¬:</h6>
                    <div class="response-text" id="targetResponse"></div>
                    <div class="meaning-text" id="targetMeaning"></div>
                </div>

                <!-- ìŒì„± ì¸ì‹ ì„¹ì…˜ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label"><strong>ë‹¹ì‹ ì˜ ìŒì„± ì‘ë‹µ:</strong></label>
                            <button type="button" id="micBtn" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-microphone me-2"></i>ìŒì„± ì¸ì‹ ì‹œì‘
                            </button>
                            <button type="button" id="stopBtn" class="btn btn-danger w-100 mb-2" style="display: none;">
                                <i class="fas fa-stop me-2"></i>ìŒì„± ì¸ì‹ ì¤‘ì§€
                            </button>
                            <div id="recognizedText" class="alert alert-info" style="display: none; min-height: 70px;">
                                <p class="text-muted small mb-1">ì¸ì‹ëœ ë‚´ìš©:</p>
                                <p id="textContent" class="mb-0"></p>
                            </div>
                            <div id="statusMessage" class="alert alert-secondary" style="display: none;">
                                <small id="statusText"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê²°ê³¼ í”¼ë“œë°± -->
                <div id="resultFeedback" style="display: none;" class="mb-4">
                    <div id="resultMessage" class="alert"></div>
                </div>

                <!-- AI í›„ì† ëŒ€ì‚¬ (ì •ë‹µ í›„ ë‚˜íƒ€ë‚¨) -->
                <div id="aiFollowupContainer" style="display: none;" class="mt-4 pt-4 border-top">
                    <h6 class="mb-3">âœ… ì •ë‹µì…ë‹ˆë‹¤!</h6>
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="speaker-message">
                                <div class="response-text" id="followupText"></div>
                                <div class="meaning-text" id="followupMeaning"></div>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="playAudio(document.getElementById('followupText').textContent)">
                                <i class="fas fa-play me-1"></i>ì¬ìƒ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ ë²„íŠ¼ -->
                <div class="button-group">
                    <a href="{{ url_for('conversation_practice') }}" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-redo me-2"></i>ìƒˆë¡œìš´ ëŒ€í™” ì‹œì‘
                    </a>
                </div>
            </div>
        </div>

        <!-- í•™ìŠµ íŒ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ’¡ í•™ìŠµ íŒ</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>ìŒì„± ì¸ì‹ ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ì˜ì–´ë¡œ ëŒ€ì‚¬ë¥¼ ë§í•˜ì„¸ìš”</li>
                    <li>ì •í™•í•œ ë¬¸ì¥ê³¼ ìœ ì‚¬í•˜ê²Œ ë§í•´ì•¼ ì •ë‹µì…ë‹ˆë‹¤</li>
                    <li>ë°œìŒê³¼ ì–µì–‘ì— ì‹ ê²½ ì“°ì„¸ìš”</li>
                    <li>ì •ë‹µí•˜ë©´ ì™¸êµ­ì¸ì˜ ë‹¤ìŒ ëŒ€ì‚¬ë¥¼ ë“£ê³  ëŒ€í™”ë¥¼ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// ê¸€ë¡œë²Œ ìŒì„± ìºì‹œ
let cachedFemaleVoice = null;

// ëª¨ë“  ìŒì„± ì‚¬ì „ ë¡œë“œ ë° ë¶„ë¥˜
function loadAllVoices() {
    if ('speechSynthesis' in window) {
        const voices = window.speechSynthesis.getVoices();
        
        // ì—¬ì ìŒì„± ì°¾ê¸° - Zira/Samantha ìš°ì„ 
        for (let voice of voices) {
            if (voice.lang === 'en-US') {
                const name = voice.name;
                if (name.includes('Zira') || name.includes('Samantha') || name.includes('Victoria') || name.includes('Karen') || name.includes('Moira')) {
                    cachedFemaleVoice = voice;
                    break;
                }
            }
        }
        
        // ì—¬ì ìŒì„±ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ en-US ìŒì„±
        if (!cachedFemaleVoice) {
            for (let voice of voices) {
                if (voice.lang === 'en-US') {
                    cachedFemaleVoice = voice;
                    break;
                }
            }
        }
    }
}

// ìŒì„± ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = function() {
        loadAllVoices();
    };
    loadAllVoices();
}

// ìŒì„± ì¬ìƒ
function playAudio(text) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        if (cachedFemaleVoice) {
            utterance.voice = cachedFemaleVoice;
        }
        window.speechSynthesis.speak(utterance);
    }
}

// Web Speech API ìŒì„± ì¸ì‹
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let isListening = false;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = true;
}

// ë“œë¼ë§ˆ ë°ì´í„° (JSONìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬)
const dramaData = {{ drama_data | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    const micBtn = document.getElementById('micBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recognizedText = document.getElementById('recognizedText');
    const textContent = document.getElementById('textContent');
    const statusMessage = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    const resultFeedback = document.getElementById('resultFeedback');
    const resultMessage = document.getElementById('resultMessage');
    const aiFollowupContainer = document.getElementById('aiFollowupContainer');
    const targetResponseDiv = document.getElementById('targetResponse');
    const targetMeaningDiv = document.getElementById('targetMeaning');
    
    // ì‚¬ìš©ì ì •ë‹µ ë¬¸ì¥ í‘œì‹œ
    targetResponseDiv.textContent = dramaData.user_response;
    targetMeaningDiv.textContent = dramaData.user_meaning;
    
    const targetResponse = dramaData.user_response.toLowerCase().trim();
    
    if (!recognition) {
        micBtn.disabled = true;
        statusMessage.style.display = 'block';
        statusText.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        return;
    }
    
    // ìŒì„± ì¸ì‹ ì‹œì‘
    micBtn.addEventListener('click', function() {
        if (!isListening) {
            isListening = true;
            micBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            recognizedText.style.display = 'block';
            resultFeedback.style.display = 'none';
            aiFollowupContainer.style.display = 'none';
            textContent.textContent = 'ìŒì„± ì¸ì‹ ì¤‘...';
            recognition.start();
        }
    });
    
    // ìŒì„± ì¸ì‹ ì¤‘ì§€
    stopBtn.addEventListener('click', function() {
        isListening = false;
        micBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        recognition.stop();
    });
    
    // ìŒì„± ì¸ì‹ ê²°ê³¼
    recognition.addEventListener('result', function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
            } else {
                interimTranscript += transcript;
            }
        }
        
        const currentText = finalTranscript || interimTranscript;
        textContent.textContent = currentText;
        
        // ìµœì¢… ê²°ê³¼ì¸ ê²½ìš° ì •ë‹µ í™•ì¸
        if (finalTranscript) {
            checkAnswer(finalTranscript.toLowerCase().trim(), targetResponse.toLowerCase().trim());
        }
    });
    
    // ì •ë‹µ í™•ì¸
    function checkAnswer(userInput, targetInput) {
        resultFeedback.style.display = 'block';
        resultMessage.className = 'alert';
        
        // ë¶€ë¶„ ì¼ì¹˜ í™•ì¸ (ì£¼ìš” ë‹¨ì–´ë“¤ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸)
        const targetWords = targetInput.split(/\s+/);
        const userWords = userInput.split(/\s+/);
        
        // 3ê°œ ì´ìƒì˜ ì£¼ìš” ë‹¨ì–´ê°€ ì¼ì¹˜í•˜ê±°ë‚˜ 80% ì´ìƒ ì¼ì¹˜í•˜ë©´ ì •ë‹µ
        const matchedWords = targetWords.filter(w => userWords.some(uw => uw.includes(w) || w.includes(uw)));
        const matchPercentage = matchedWords.length / targetWords.length;
        
        if (matchPercentage >= 0.7 || userInput.includes(targetInput) || targetInput.includes(userInput)) {
            resultMessage.className = 'alert status-success';
            resultMessage.innerHTML = '<strong>âœ… ì •ë‹µì…ë‹ˆë‹¤!</strong> ì˜ í•˜ì…¨ì–´ìš”!';
            
            // AI í›„ì† ëŒ€ì‚¬ í‘œì‹œ
            aiFollowupContainer.style.display = 'block';
            document.getElementById('followupText').textContent = dramaData.ai_followup;
            document.getElementById('followupMeaning').textContent = dramaData.ai_followup_meaning;
            
            // ê²½í—˜ì¹˜ +10
            fetch('{{ url_for("add_exp") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({exp: 10})
            });
        } else {
            resultMessage.className = 'alert status-error';
            resultMessage.innerHTML = `<strong>âŒ í‹€ë ¸ìŠµë‹ˆë‹¤</strong><br>ì •ë‹µ: <strong>${dramaData.user_response}</strong>`;
        }
    }
    
    // ìŒì„± ì¸ì‹ ì—ëŸ¬
    recognition.addEventListener('error', function(event) {
        if (event.error !== 'aborted') {
            statusMessage.style.display = 'block';
            const errorMessages = {
                'no-speech': 'ìŒì„±ì„ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                'audio-capture': 'ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                'network': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                'permission-denied': 'ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'
            };
            statusText.textContent = errorMessages[event.error] || 'ì˜¤ë¥˜: ' + event.error;
        }
        isListening = false;
        micBtn.style.display = 'block';
        stopBtn.style.display = 'none';
    });
    
    // ìŒì„± ì¸ì‹ ì¢…ë£Œ
    recognition.addEventListener('end', function() {
        isListening = false;
        micBtn.style.display = 'block';
        stopBtn.style.display = 'none';
    });
});
</script>
{% endblock %}
