{% extends "base.html" %}

{% block title %}ëŒ€í™” ì—°ìŠµ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<style>
    .conversation-container {
        max-width: 850px;
        margin: 0 auto;
    }
    
    .progress-bar-custom {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s;
    }
    
    .speaker-message, .user-prompt {
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s;
        user-select: none;
    }

    .speaker-message {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
    }

    .speaker-message:hover {
        background: #d0e8ff;
    }

    .user-prompt {
        background: #fff8e7;
        border-left: 4px solid #ff9900;
    }

    .user-prompt:hover {
        background: #ffedcc;
    }
    
    .response-text {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 10px 0;
        word-break: break-word;
        transition: opacity 0.3s;
    }

    .speaker-message .response-text {
        color: #0066cc;
    }

    .user-prompt .response-text {
        color: #ff6600;
    }
    
    .meaning-text {
        font-size: 0.9rem;
        color: #666;
        margin-top: 8px;
        font-style: italic;
        transition: opacity 0.3s;
    }

    .hidden-content {
        opacity: 0;
        height: 0;
        overflow: hidden;
    }

    .play-audio-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: background 0.3s;
        z-index: 10;
    }

    .play-audio-btn:hover {
        background: #0052a3;
    }

    .play-audio-btn:active {
        transform: scale(0.95);
    }

    .play-audio-btn.playing {
        background: #ff6600;
    }

    .click-hint {
        position: absolute;
        bottom: 8px;
        right: 15px;
        font-size: 0.75rem;
        color: #999;
        opacity: 0.6;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .status-success {
        background: #d4edda;
        border: 1px solid #28a745;
        color: #155724;
    }

    .status-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
</style>

<div class="row">
    <div class="col-12 col-lg-8 offset-lg-2 conversation-container">
        <!-- í—¤ë” -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-comments me-2"></i>ë“œë¼ë§ˆ/ì• ë‹ˆ íšŒí™” ì—°ìŠµ
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>ğŸ“ ì¥ë©´:</strong> {{ scenario }}</p>
                <p class="mb-3"><strong>ğŸ—£ï¸ ê°•ì‚¬:</strong> {{ speaker.name }}</p>
                
                <!-- ì§„í–‰ë„ í‘œì‹œ -->
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <small class="text-muted">í„´ ì§„í–‰ ìƒí™©</small>
                    <small class="text-muted"><span id="turnNumber">{{ turn_number }}</span> / <span id="totalTurns">{{ total_turns }}</span></small>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressBar" style="width: {{ (turn_number / total_turns * 100)|int }}%"></div>
                </div>
            </div>
        </div>

        <!-- í˜„ì¬ í„´ ëŒ€í™” -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- ìƒëŒ€ë°©(AI) ëŒ€ì‚¬ -->
                <div class="row mb-4">
                    <div class="col-12 col-sm-3 text-center mb-3 mb-sm-0">
                        <img src="{{ url_for('static', filename='images/' + speaker.image) }}" alt="{{ speaker.name }}" style="width: 100%; max-width: 120px; border-radius: 10px;">
                        <p class="text-muted mt-2 mb-0"><strong>{{ speaker.name }}</strong></p>
                    </div>
                    <div class="col-12 col-sm-9">
                        <div class="speaker-message" id="aiMessageBox" data-state="0">
                            <button class="play-audio-btn" id="playAudioBtnAI" title="ìŒì„± ë“£ê¸°">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <small class="text-muted">ìƒëŒ€ë°© ëŒ€ì‚¬:</small>
                            <div class="response-text" id="aiPromptText">{{ current_turn.ai_prompt }}</div>
                            <div class="meaning-text" id="aiMeaningText">{{ current_turn.ai_meaning }}</div>
                            <div class="click-hint">í´ë¦­í•˜ê¸° âœ“âœ“âœ“</div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- ì‚¬ìš©ìê°€ ë§í•´ì•¼ í•  ë¬¸ì¥ -->
                <div class="user-prompt" id="userMessageBox" data-state="0">
                    <button class="play-audio-btn" id="playAudioBtnUser" title="ìŒì„± ë“£ê¸°">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <small class="text-muted">ë‹¹ì‹ ì´ ë§í•´ì•¼ í•  ëŒ€ì‚¬:</small>
                    <div class="response-text" id="userResponseText">{{ current_turn.user_response }}</div>
                    <div class="meaning-text" id="userMeaningText">{{ current_turn.user_meaning }}</div>
                    <div class="click-hint">í´ë¦­í•˜ê¸° âœ“âœ“âœ“</div>
                </div>

                <!-- ê²°ê³¼ í”¼ë“œë°± -->
                <div id="resultFeedback" style="display: none;" class="mb-4">
                    <div id="resultMessage" class="alert"></div>
                </div>

                <!-- ë‹¤ìŒ í„´ ë²„íŠ¼ -->
                <div id="nextTurnContainer" style="display: none;" class="button-group">
                    <button type="button" id="nextTurnBtn" class="btn btn-success flex-grow-1">
                        <i class="fas fa-arrow-right me-2"></i>ë‹¤ìŒ ëŒ€ì‚¬ë¡œ
                    </button>
                </div>

                <!-- ì™„ë£Œ ë²„íŠ¼ -->
                <div id="completionContainer" style="display: none;" class="button-group">
                    <a href="{{ url_for('index') }}" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-home me-2"></i>í™ˆìœ¼ë¡œ
                    </a>
                    <a href="{{ url_for('conversation_practice') }}" class="btn btn-success flex-grow-1">
                        <i class="fas fa-redo me-2"></i>ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤
                    </a>
                </div>
            </div>
        </div>

        <!-- í•™ìŠµ íŒ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ’¡ í•™ìŠµ íŒ</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>í´ë¦­ ìƒíƒœ:</strong> 1íšŒ = ì˜ì–´ë§Œ | 2íšŒ = í•œêµ­ì–´ë§Œ | 3íšŒ = ì˜ì–´+í•œêµ­ì–´</li>
                    <li>ğŸ”Š ë²„íŠ¼ìœ¼ë¡œ ë°œìŒì„ ë°˜ë³µí•´ ë“¤ìœ¼ì„¸ìš”</li>
                    <li>ìƒëŒ€ë°© ë°œìŒì„ ì£¼ì˜ê¹Šê²Œ ë”°ë¼ í•´ë³´ì„¸ìš”</li>
                    <li>ê° í„´ë§ˆë‹¤ ì™„ë£Œ ì‹œ ê²½í—˜ì¹˜ +10ì„ íšë“í•©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Speaker ì •ë³´ -->
<script>
const speakerData = {
    name: '{{ speaker.name }}',
    gender: '{{ speaker.gender }}'
};

// ìŒì„± ì¬ìƒ í•¨ìˆ˜
function playAudio(text, gender) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.95;
    
    const voices = window.speechSynthesis.getVoices();
    if (gender === 'female') {
        const femaleVoice = voices.find(voice => 
            voice.name.includes('female') || voice.name.includes('woman') || voice.voiceURI.includes('female')
        ) || voices[0];
        if (femaleVoice) utterance.voice = femaleVoice;
    } else if (gender === 'male') {
        const maleVoice = voices.find(voice => 
            voice.name.includes('Google US English Male') || voice.name.includes('Male') || 
            voice.name.includes('male') || voice.name.includes('man') ||
            voice.name.includes('Aaron') || voice.name.includes('Daniel') || voice.name.includes('George') ||
            (voice.voiceURI.includes('male') && !voice.voiceURI.includes('female'))
        );
        if (maleVoice) {
            utterance.voice = maleVoice;
        } else if (voices.length > 1) {
            utterance.voice = voices.find(v => !v.name.includes('female') && !v.name.includes('woman')) || voices[0];
        }
    }
    
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

// ë©”ì‹œì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateMessageState(messageBox, state) {
    const responseText = messageBox.querySelector('.response-text');
    const meaningText = messageBox.querySelector('.meaning-text');
    
    responseText.classList.remove('hidden-content');
    meaningText.classList.remove('hidden-content');
    
    if (state === 1) {
        // ì˜ì–´ë§Œ
        meaningText.classList.add('hidden-content');
    } else if (state === 2) {
        // í•œêµ­ì–´ë§Œ
        responseText.classList.add('hidden-content');
    } else if (state === 3) {
        // ë‘˜ ë‹¤ ë³´ì„
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const aiMessageBox = document.getElementById('aiMessageBox');
    const userMessageBox = document.getElementById('userMessageBox');
    const playAudioBtnAI = document.getElementById('playAudioBtnAI');
    const playAudioBtnUser = document.getElementById('playAudioBtnUser');
    const nextTurnBtn = document.getElementById('nextTurnBtn');
    const resultFeedback = document.getElementById('resultFeedback');
    const resultMessage = document.getElementById('resultMessage');
    const nextTurnContainer = document.getElementById('nextTurnContainer');
    const completionContainer = document.getElementById('completionContainer');
    const aiPromptText = document.getElementById('aiPromptText');
    const userResponseText = document.getElementById('userResponseText');
    
    // ë©”ì‹œì§€ í´ë¦­ ì´ë²¤íŠ¸
    aiMessageBox.addEventListener('click', function(e) {
        if (e.target.closest('.play-audio-btn')) return;
        let state = parseInt(aiMessageBox.dataset.state) || 0;
        state = (state + 1) % 4;
        if (state === 0) state = 1;
        aiMessageBox.dataset.state = state;
        updateMessageState(aiMessageBox, state);
    });
    
    userMessageBox.addEventListener('click', function(e) {
        if (e.target.closest('.play-audio-btn')) return;
        let state = parseInt(userMessageBox.dataset.state) || 0;
        state = (state + 1) % 4;
        if (state === 0) state = 1;
        userMessageBox.dataset.state = state;
        updateMessageState(userMessageBox, state);
    });
    
    // ìŒì„± ì¬ìƒ ë²„íŠ¼
    playAudioBtnAI.addEventListener('click', function(e) {
        e.stopPropagation();
        const text = aiPromptText.textContent.trim();
        playAudioBtnAI.classList.add('playing');
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        utterance.onend = function() {
            playAudioBtnAI.classList.remove('playing');
        };
        const voices = window.speechSynthesis.getVoices();
        if (speakerData.gender === 'female') {
            const femaleVoice = voices.find(v => v.name.includes('female') || v.name.includes('woman')) || voices[0];
            if (femaleVoice) utterance.voice = femaleVoice;
        } else if (speakerData.gender === 'male') {
            const maleVoice = voices.find(v => 
                v.name.includes('Google US English Male') || v.name.includes('Male') || v.name.includes('male') ||
                (v.voiceURI.includes('male') && !v.voiceURI.includes('female'))
            );
            if (maleVoice) utterance.voice = maleVoice;
        }
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    });
    
    playAudioBtnUser.addEventListener('click', function(e) {
        e.stopPropagation();
        const text = userResponseText.textContent.trim();
        playAudioBtnUser.classList.add('playing');
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        utterance.onend = function() {
            playAudioBtnUser.classList.remove('playing');
        };
        const voices = window.speechSynthesis.getVoices();
        const femaleVoice = voices.find(v => v.name.includes('female') || v.name.includes('woman')) || voices[0];
        if (femaleVoice) utterance.voice = femaleVoice;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    });
    
    // ë‹¤ìŒ í„´ ë¡œë“œ
    function loadNextTurn() {
        window.speechSynthesis.cancel();
        fetch('{{ url_for("next_turn") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (data.is_final && data.turn_number === undefined) {
                    resultFeedback.style.display = 'block';
                    resultMessage.className = 'alert alert-success';
                    resultMessage.innerHTML = '<strong>ğŸ‰ ëŒ€í™” ì—°ìŠµ ì™„ë£Œ!</strong><br>ëª¨ë“  í„´ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
                    nextTurnContainer.style.display = 'none';
                    completionContainer.style.display = 'flex';
                } else {
                    const turn = data.next_turn;
                    aiPromptText.textContent = turn.ai_prompt;
                    document.getElementById('aiMeaningText').textContent = turn.ai_meaning;
                    userResponseText.textContent = turn.user_response;
                    document.getElementById('userMeaningText').textContent = turn.user_meaning;
                    
                    document.getElementById('turnNumber').textContent = data.turn_number;
                    document.getElementById('totalTurns').textContent = data.total_turns;
                    document.getElementById('progressBar').style.width = (data.turn_number / data.total_turns * 100) + '%';
                    
                    // ìƒíƒœ ì´ˆê¸°í™” (ë‹¤ ê°€ë¦¬ê¸°)
                    aiMessageBox.dataset.state = 0;
                    userMessageBox.dataset.state = 0;
                    updateMessageState(aiMessageBox, 0);
                    updateMessageState(userMessageBox, 0);
                    
                    resultFeedback.style.display = 'none';
                    nextTurnContainer.style.display = 'none';
                    playAudioBtnAI.classList.remove('playing');
                    playAudioBtnUser.classList.remove('playing');
                }
            }
        });
    }
    
    nextTurnBtn.addEventListener('click', loadNextTurn);
    
    // í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸° ìƒíƒœ (ëª¨ë‘ ê°€ë¦¬ê¸°)
    updateMessageState(aiMessageBox, 0);
    updateMessageState(userMessageBox, 0);
    
    resultFeedback.style.display = 'block';
    resultMessage.className = 'alert alert-info';
    resultMessage.innerHTML = '<strong>ğŸ“– ëŒ€í™” ì—°ìŠµ ê°€ì´ë“œ</strong><br>ìƒëŒ€ë°© ëŒ€ì‚¬ì™€ ë‹¹ì‹ ì˜ ëŒ€ì‚¬ë¥¼ í´ë¦­í•´ì„œ ì˜ì–´/í•œêµ­ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”. ğŸ”Š ë²„íŠ¼ìœ¼ë¡œ ìŒì„±ì„ ë“¤ì–´ë³´ì„¸ìš”.';
    nextTurnContainer.style.display = 'block';
});
</script>
{% endblock %}
