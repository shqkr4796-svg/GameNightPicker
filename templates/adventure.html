{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">

<div class="adventure-container">
    <!-- í—¤ë” -->
    <div class="adventure-header" style="background-image: url('{{ url_for('static', filename='images/fantasy_rpg_adventure_header.png') }}');">
        <div class="header-overlay">
            <h1>âš”ï¸ ëª¨í—˜ ì‹œìŠ¤í…œ âš”ï¸</h1>
            <div class="header-stats">
                <div class="stat-box">
                    <span class="stat-label">í˜„ì¬ ìŠ¤í…Œì´ì§€</span>
                    <span class="stat-value">{{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }} / 200</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">ìµœê³  ê¸°ë¡</span>
                    <span class="stat-value">{{ cleared_stage }}</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">ë³´ìœ  ê¸°ìˆ </span>
                    <span class="stat-value">{{ player.get('ëª¨í—˜_ê¸°ìˆ ', [])|length }} / 4</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="adventure-content">
        <div class="content-wrapper">
            <!-- ì™¼ìª½: ìŠ¤í…Œì´ì§€ ì„ íƒ -->
            <div class="stage-section">
                <h2 class="section-title">ğŸ“ ìŠ¤í…Œì´ì§€ ì„ íƒ</h2>
                <div class="stages-grid">
                    {% for stage in stages %}
                    {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
                    <div class="stage-card-wrapper {% if is_unlocked %}unlocked{% else %}locked{% endif %}"
                         onclick="{% if is_unlocked %}selectStage({{ stage.stage_id }}, '{{ stage.ì´ë¦„ }}', {{ stage.enemy_hp_multiplier }}, {{ stage.enemy_attack_multiplier }}, {{ stage.skill_reward_rate }}, '{{ stage.ë‚œì´ë„ }}'){% endif %}">
                        <div class="stage-card" style="background-image: url('{{ url_for('static', filename='images/fantasy_rpg_stage_card_-_golden.png') }}');">
                            <div class="stage-number">{{ stage.stage_id }}</div>
                            {% if stage.stage_id <= cleared_stage %}
                            <div class="stage-cleared">âœ“</div>
                            {% endif %}
                        </div>
                        <div class="stage-label">{{ stage.ì´ë¦„ }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ìƒì„¸ ì •ë³´ + ëª¬ìŠ¤í„° ì„ íƒ -->
            <div class="detail-section" style="background-image: url('{{ url_for('static', filename='images/fantasy_rpg_panel_background.png') }}');">
                <div class="panel-content">
                    <!-- ìŠ¤í…Œì´ì§€ ìƒì„¸ ì •ë³´ -->
                    <div id="stageDetailBox" class="stage-detail-box hidden">
                        <h3 id="stageName"></h3>
                        <div class="stage-info-row">
                            <span class="info-label">ë‚œì´ë„:</span>
                            <span id="stageDiff" class="difficulty-tag"></span>
                        </div>
                        <div class="stage-info-row">
                            <span class="info-label">ì  ì²´ë ¥:</span>
                            <span id="stageHp" class="info-value">x1.0</span>
                        </div>
                        <div class="stage-info-row">
                            <span class="info-label">ì  ê³µê²©:</span>
                            <span id="stageAtk" class="info-value">x1.0</span>
                        </div>
                        <div class="stage-info-row">
                            <span class="info-label">ê¸°ìˆ  ë“œë¡­:</span>
                            <span id="stageReward" class="info-value">0%</span>
                        </div>
                    </div>

                    <!-- ëª¬ìŠ¤í„° ì„ íƒ -->
                    {% if available_monsters %}
                    <div class="monster-select-box">
                        <h3>ğŸ‰ íŒŒí‹° ë¦¬ë” ì„ íƒ</h3>
                        <div class="monsters-container">
                            {% for monster in available_monsters %}
                            <div class="monster-card-item" 
                                 onclick="selectMonster('{{ monster.id }}', this)"
                                 style="background-image: url('{{ url_for('static', filename='images/fantasy_monster_card_background.png') }}');">
                                <div class="monster-card-inner">
                                    <div class="monster-pic">
                                        <img src="{{ monster.image }}" alt="{{ monster.name }}">
                                    </div>
                                    <div class="monster-info">
                                        <div class="monster-name">{{ monster.name }}</div>
                                        <div class="monster-rarity" style="background: 
                                            {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                                            {% elif monster.rarity == 'ì—í”½' %}#9932CC
                                            {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                                            {% else %}#FF1493{% endif %}">
                                            {{ monster.rarity }}
                                        </div>
                                        <div class="monster-stat">âš”ï¸ {{ monster.attack }}</div>
                                        <div class="monster-stat">â¤ï¸ {{ monster.hp }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ë„ì „ ë²„íŠ¼ -->
                    <button id="challengeBtn" class="btn-challenge" disabled onclick="startChallenge()">
                        ğŸ® ë„ì „í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedStageData = null;
let selectedMonster = null;

function selectStage(id, name, hp, atk, reward, difficulty) {
    selectedStageData = { id, name, hp, atk, reward, difficulty };
    
    document.querySelectorAll('.stage-card-wrapper').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.getElementById('stageName').textContent = name;
    document.getElementById('stageDiff').textContent = difficulty;
    document.getElementById('stageDiff').style.backgroundColor = getDifficultyColor(difficulty);
    document.getElementById('stageHp').textContent = 'x' + hp.toFixed(1);
    document.getElementById('stageAtk').textContent = 'x' + atk.toFixed(1);
    document.getElementById('stageReward').textContent = Math.round(reward * 100) + '%';
    document.getElementById('stageDetailBox').classList.remove('hidden');
    
    updateChallengeButton();
}

function selectMonster(monsterId, element) {
    selectedMonster = monsterId;
    document.querySelectorAll('.monster-card-item').forEach(m => m.classList.remove('selected'));
    element.classList.add('selected');
    updateChallengeButton();
}

function updateChallengeButton() {
    document.getElementById('challengeBtn').disabled = !selectedStageData || !selectedMonster;
}

function startChallenge() {
    if (selectedStageData && selectedMonster) {
        window.location.href = `/adventure_battle/${selectedStageData.id}/${selectedMonster}`;
    }
}

function getDifficultyColor(difficulty) {
    const colors = {
        'ì‰¬ì›€': '#4CAF50',
        'ë³´í†µ': '#FFC107',
        'ì–´ë ¤ì›€': '#FF9800',
        'ë§¤ìš° ì–´ë ¤ì›€': '#F44336',
        'ê·¹ì•…': '#9C27B0'
    };
    return colors[difficulty] || '#999';
}
</script>
{% endblock %}
