{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">

<div class="adventure-page">
    <!-- ìƒë‹¨ -->
    <div class="adventure-top">
        <h1>âš”ï¸ ëª¨í—˜</h1>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ ((player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) - 1) / 200 * 100)|int }}%"></div>
            <div class="progress-text">{{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }} / 200</div>
        </div>
    </div>

    <!-- ìŠ¤í…Œì´ì§€ ì¹´ë“œë“¤ -->
    <div class="stages-container">
        <div class="stage-cards">
            {% for stage in stages %}
            {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
            <div class="stage-card {% if not is_unlocked %}disabled{% endif %}"
                 onclick="{% if is_unlocked %}selectStage({{ stage.stage_id }}, '{{ stage.ì´ë¦„ }}', {{ stage.enemy_hp_multiplier }}, {{ stage.enemy_attack_multiplier }}, {{ stage.skill_reward_rate }}, '{{ stage.ë‚œì´ë„ }}'){% endif %}">
                
                <div class="card-content">
                    {% if stage.stage_id <= cleared_stage %}
                    <div class="cleared-badge">í´ë¦¬ì–´</div>
                    {% endif %}
                    <div class="stage-num-large">{{ stage.stage_id }}</div>
                    <h3>{{ stage.ì´ë¦„ }}</h3>
                    <div class="difficulty" style="color:
                        {% if stage.ë‚œì´ë„ == 'ì‰¬ì›€' %}#4CAF50
                        {% elif stage.ë‚œì´ë„ == 'ë³´í†µ' %}#FFC107
                        {% elif stage.ë‚œì´ë„ == 'ì–´ë ¤ì›€' %}#FF9800
                        {% elif stage.ë‚œì´ë„ == 'ë§¤ìš° ì–´ë ¤ì›€' %}#F44336
                        {% else %}#9C27B0{% endif %}">
                        {{ stage.ë‚œì´ë„ }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ì•¡ì…˜ ì˜ì—­ -->
    <div class="action-section">
        <!-- ì„ íƒí•œ ìŠ¤í…Œì´ì§€ ì •ë³´ -->
        <div id="stageInfo" class="current-selection" style="display: none;">
            <h2 id="selectedName"></h2>
            <div class="stage-stats">
                <div class="stat">ì²´ë ¥: <span id="selectedHp"></span></div>
                <div class="stat">ê³µê²©: <span id="selectedAtk"></span></div>
                <div class="stat">ê¸°ìˆ ë“œë¡­: <span id="selectedDrop"></span></div>
            </div>
        </div>

        <!-- ëª¬ìŠ¤í„° ì„ íƒ -->
        {% if available_monsters %}
        <div class="monster-picker">
            <h2>íŒŒí‹° ë¦¬ë” ì„ íƒ</h2>
            <div class="monster-options">
                {% for monster in available_monsters %}
                <div class="mon-option" onclick="selectMonster('{{ monster.id }}', this)" data-monster="{{ monster.id }}">
                    <img src="{{ monster.image }}" alt="{{ monster.name }}">
                    <div class="mon-name">{{ monster.name }}</div>
                    <div class="mon-rarity" style="background:
                        {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                        {% elif monster.rarity == 'ì—í”½' %}#9932CC
                        {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                        {% else %}#FF1493{% endif %}">
                        {{ monster.rarity }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- ë„ì „ ë²„íŠ¼ -->
        <button id="startBtn" class="start-btn" disabled onclick="startAdventure()">
            ğŸ® ë„ì „í•˜ê¸°
        </button>
    </div>
</div>

<script>
let selectedStage = null;
let selectedMonster = null;

function selectStage(id, name, hp, atk, reward, difficulty) {
    selectedStage = { id, name, hp, atk, reward, difficulty };
    
    document.querySelectorAll('.stage-card').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.getElementById('selectedName').textContent = name + ' - ' + difficulty;
    document.getElementById('selectedHp').textContent = 'x' + hp.toFixed(1);
    document.getElementById('selectedAtk').textContent = 'x' + atk.toFixed(1);
    document.getElementById('selectedDrop').textContent = Math.round(reward * 100) + '%';
    document.getElementById('stageInfo').style.display = 'block';
    
    updateBtn();
}

function selectMonster(id, el) {
    selectedMonster = id;
    document.querySelectorAll('.mon-option').forEach(m => m.classList.remove('active'));
    el.classList.add('active');
    updateBtn();
}

function updateBtn() {
    document.getElementById('startBtn').disabled = !selectedStage || !selectedMonster;
}

function startAdventure() {
    if (selectedStage && selectedMonster) {
        window.location.href = `/adventure_battle/${selectedStage.id}/${selectedMonster}`;
    }
}
</script>
{% endblock %}
