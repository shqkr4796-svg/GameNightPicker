{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure_rpg.css') }}">

<div class="adventure-rpg-container">
    <!-- í—¤ë” ë°°ë„ˆ -->
    <div class="adventure-header" style="background-image: url('{{ url_for('static', filename='images/header_bg.png') }}');">
        <div class="header-content">
            <h1 class="adventure-title">âš”ï¸ ADVENTURE âš”ï¸</h1>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">Stage</span>
                    <span class="stat-value">{{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Best</span>
                    <span class="stat-value">{{ cleared_stage }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Skills</span>
                    <span class="stat-value">{{ player.get('ëª¨í—˜_ê¸°ìˆ ', [])|length }}/4</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Gold</span>
                    <span class="stat-value">{{ "{:,}".format(player['ëˆ']) }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="adventure-content">
        <!-- ë§µ ë°°ê²½ -->
        <div class="adventure-map" style="background-image: url('{{ url_for('static', filename='images/adventure_bg.png') }}');">
            <div class="map-overlay">
                <!-- ìŠ¤í…Œì´ì§€ ë…¸ë“œë“¤ -->
                <div class="stages-container">
                    {% for stage in stages %}
                    {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
                    <div class="stage-node-wrapper stage-{{ stage.stage_id }}" 
                         data-stage-id="{{ stage.stage_id }}"
                         data-stage-name="{{ stage.ì´ë¦„ }}"
                         data-difficulty="{{ stage.ë‚œì´ë„ }}"
                         data-hp="{{ stage.enemy_hp_multiplier }}"
                         data-attack="{{ stage.enemy_attack_multiplier }}"
                         data-reward="{{ "%.0f"|format(stage.skill_reward_rate * 100) }}">
                        
                        <div class="stage-flag {% if is_unlocked %}unlocked{% else %}locked{% endif %}" 
                             onclick="{% if is_unlocked %}showStageInfo({{ stage.stage_id }}){% endif %}"
                             style="background-image: url('{{ url_for('static', filename='images/stage_flags.png') }}'); background-position: {{ (stage.stage_id - 1) * 12.5 }}% center;">
                            <span class="flag-text">{{ stage.stage_id }}</span>
                            {% if stage.stage_id <= cleared_stage %}
                            <span class="flag-badge">âœ“</span>
                            {% endif %}
                        </div>
                        
                        <div class="stage-name">{{ stage.ì´ë¦„ }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ì •ë³´ íŒ¨ë„ -->
        <div class="adventure-bottom-panel">
            <!-- ëª¬ìŠ¤í„° ì„ íƒ -->
            {% if available_monsters %}
            <div class="monster-selection-panel">
                <div class="panel-title">ğŸ‰ íŒŒí‹° ë¦¬ë” ì„ íƒ</div>
                <div class="monsters-grid">
                    {% for monster in available_monsters %}
                    <div class="monster-card" 
                         onclick="selectMonster('{{ monster.id }}')"
                         data-monster-id="{{ monster.id }}">
                        <div class="monster-image">
                            <img src="{{ monster.image }}" alt="{{ monster.name }}">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">{{ monster.name }}</div>
                            <div class="monster-stats-row">
                                <span class="stat">âš”ï¸ {{ monster.attack }}</span>
                                <span class="stat">â¤ï¸ {{ monster.hp }}</span>
                            </div>
                            <div class="monster-rarity" style="background-color: 
                                {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                                {% elif monster.rarity == 'ì—í”½' %}#9932CC
                                {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                                {% else %}#FF1493{% endif %}">
                                {{ monster.rarity }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ìŠ¤í…Œì´ì§€ ì •ë³´ ëª¨ë‹¬ -->
    <div id="stageModal" class="stage-modal hidden">
        <div class="modal-overlay" onclick="closeStageInfo()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeStageInfo()">âœ•</button>
            
            <div class="modal-header">
                <h2 id="stageTitle"></h2>
                <p id="stageDifficulty" class="difficulty-badge"></p>
            </div>

            <div class="modal-body">
                <div class="stage-details">
                    <div class="detail-row">
                        <span class="label">ì  ì²´ë ¥:</span>
                        <span class="value" id="stageHP">x1.0</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">ì  ê³µê²©ë ¥:</span>
                        <span class="value" id="stageAttack">x1.0</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">ê¸°ìˆ  ë“œë¡­:</span>
                        <span class="value" id="stageReward">0%</span>
                    </div>
                </div>

                <div class="monster-selection">
                    <p class="selection-prompt">íŒŒí‹° ë¦¬ë”ë¥¼ ì„ íƒí•˜ê³  ë„ì „í•˜ì„¸ìš”!</p>
                    <div class="selected-info" id="selectedMonsterInfo" style="display: none;">
                        <div class="selected-monster">
                            <img id="selectedMonsterImage" src="" alt="">
                            <div class="selected-stats">
                                <div id="selectedMonsterName"></div>
                                <div id="selectedMonsterStats"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeStageInfo()">ì·¨ì†Œ</button>
                <button class="btn-challenge" id="challengeBtn" onclick="challengeStage()" disabled>
                    ë„ì „í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedMonster = null;
let currentStageId = null;

function selectMonster(monsterId) {
    selectedMonster = monsterId;
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('.monster-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-monster-id="${monsterId}"]`).classList.add('selected');
    
    // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
    if (currentStageId && !document.getElementById('stageModal').classList.contains('hidden')) {
        updateSelectedMonsterDisplay();
    }
}

function showStageInfo(stageId) {
    currentStageId = stageId;
    const stageNode = document.querySelector(`[data-stage-id="${stageId}"]`);
    
    // ëª¨ë‹¬ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('stageTitle').textContent = stageNode.dataset.stageName;
    document.getElementById('stageDifficulty').textContent = stageNode.dataset.difficulty;
    document.getElementById('stageHP').textContent = 'x' + stageNode.dataset.hp;
    document.getElementById('stageAttack').textContent = 'x' + stageNode.dataset.attack;
    document.getElementById('stageReward').textContent = stageNode.dataset.reward + '%';
    
    // ì„ íƒëœ ëª¬ìŠ¤í„° í‘œì‹œ
    updateSelectedMonsterDisplay();
    
    // ëª¨ë‹¬ ì—´ê¸°
    document.getElementById('stageModal').classList.remove('hidden');
}

function updateSelectedMonsterDisplay() {
    const challengeBtn = document.getElementById('challengeBtn');
    const selectedInfo = document.getElementById('selectedMonsterInfo');
    
    if (selectedMonster) {
        const monsterCard = document.querySelector(`[data-monster-id="${selectedMonster}"]`);
        const monsterName = monsterCard.querySelector('.monster-name').textContent;
        const attack = monsterCard.querySelector('.stat:first-child').textContent;
        const hp = monsterCard.querySelector('.stat:last-child').textContent;
        
        document.getElementById('selectedMonsterImage').src = monsterCard.querySelector('img').src;
        document.getElementById('selectedMonsterName').textContent = monsterName;
        document.getElementById('selectedMonsterStats').textContent = `${attack} | ${hp}`;
        
        selectedInfo.style.display = 'block';
        challengeBtn.disabled = false;
    } else {
        selectedInfo.style.display = 'none';
        challengeBtn.disabled = true;
    }
}

function challengeStage() {
    if (!selectedMonster || !currentStageId) {
        alert('ëª¬ìŠ¤í„°ì™€ ìŠ¤í…Œì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }
    
    // URLì„ ë¨¼ì € ë§Œë“¤ê¸° (currentStageId ì‚¬ìš©í•˜ê¸° ì „ì—)
    const url = `/adventure_battle/${currentStageId}/${selectedMonster}`;
    console.log('Navigating to:', url);
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeStageInfo();
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ë™ (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
    setTimeout(() => {
        window.location.href = url;
    }, 300);
}

function closeStageInfo() {
    document.getElementById('stageModal').classList.add('hidden');
    currentStageId = null;
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    const modal = document.getElementById('stageModal');
    const overlay = modal.querySelector('.modal-overlay');
    if (e.target === overlay) {
        closeStageInfo();
    }
});
</script>
{% endblock %}
