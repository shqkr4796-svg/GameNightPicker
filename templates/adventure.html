{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">

<div class="adventure-container">
    <!-- ìƒë‹¨ ì¡°ì‘ ë°” -->
    <div class="action-bar">
        <button id="challengeBtn" class="challenge-button" disabled onclick="startChallenge()">
            ğŸ® ë„ì „í•˜ê¸°
        </button>
        <div class="status-info">
            <span>í˜„ì¬: <strong>{{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }}</strong> | ìµœê³ : <strong>{{ cleared_stage }}</strong></span>
        </div>
    </div>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <div class="game-area">
        <!-- ì™¼ìª½: ìŠ¤í…Œì´ì§€ ì„ íƒ -->
        <div class="stage-selector">
            <div class="panel-title">âš”ï¸ ìŠ¤í…Œì´ì§€</div>
            <div class="stage-grid">
                {% for stage in stages %}
                {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
                <button class="stage-tile {% if not is_unlocked %}locked{% endif %}" 
                        onclick="{% if is_unlocked %}selectStage({{ stage.stage_id }}, '{{ stage.ì´ë¦„ }}', {{ stage.enemy_hp_multiplier }}, {{ stage.enemy_attack_multiplier }}, {{ stage.skill_reward_rate }}, '{{ stage.ë‚œì´ë„ }}'){% endif %}"
                        title="{% if is_unlocked %}{{ stage.ì´ë¦„ }}{% else %}ì ê¸ˆ{% endif %}">
                    {{ stage.stage_id }}
                    {% if stage.stage_id <= cleared_stage %}<span class="cleared">âœ“</span>{% endif %}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- ì¤‘ì•™: ìŠ¤í…Œì´ì§€ ì •ë³´ -->
        <div class="stage-info-panel">
            <div class="info-box" id="stageInfoBox" style="display: none;">
                <div class="info-header">
                    <div class="info-title" id="infoTitle"></div>
                    <div class="info-difficulty" id="infoDifficulty"></div>
                </div>
                <div class="info-stats">
                    <div class="info-stat">
                        <span class="label">ì  ì²´ë ¥:</span>
                        <span class="value" id="infoHp"></span>
                    </div>
                    <div class="info-stat">
                        <span class="label">ì  ê³µê²©:</span>
                        <span class="value" id="infoAtk"></span>
                    </div>
                    <div class="info-stat">
                        <span class="label">ê¸°ìˆ  ë“œë¡­:</span>
                        <span class="value" id="infoDrop"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ëª¬ìŠ¤í„° ì„ íƒ -->
        <div class="monster-selector">
            <div class="panel-title">ğŸ‰ ëª¬ìŠ¤í„°</div>
            <div class="monster-grid">
                {% for monster in available_monsters %}
                <button class="monster-tile" onclick="selectMonster('{{ monster.id }}', this)" data-monster="{{ monster.id }}">
                    <div class="monster-thumb">
                        <img src="{{ monster.image }}" alt="{{ monster.name }}">
                    </div>
                    <div class="monster-label">
                        <div class="mon-name">{{ monster.name }}</div>
                        <div class="mon-rarity" style="background: 
                            {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ monster.rarity }}
                        </div>
                    </div>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let selectedStage = null;
let selectedMonster = null;

function selectStage(id, name, hp, atk, reward, difficulty) {
    selectedStage = { id, name, hp, atk, reward, difficulty };
    
    document.querySelectorAll('.stage-tile').forEach(t => t.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    document.getElementById('infoTitle').textContent = name;
    document.getElementById('infoDifficulty').textContent = difficulty;
    document.getElementById('infoDifficulty').style.color = getDifficultyColor(difficulty);
    document.getElementById('infoHp').textContent = 'x' + hp.toFixed(1);
    document.getElementById('infoAtk').textContent = 'x' + atk.toFixed(1);
    document.getElementById('infoDrop').textContent = Math.round(reward * 100) + '%';
    document.getElementById('stageInfoBox').style.display = 'block';
    
    updateBtn();
}

function selectMonster(id, el) {
    selectedMonster = id;
    document.querySelectorAll('.monster-tile').forEach(t => t.classList.remove('selected'));
    el.classList.add('selected');
    updateBtn();
}

function updateBtn() {
    document.getElementById('challengeBtn').disabled = !selectedStage || !selectedMonster;
}

function startChallenge() {
    if (selectedStage && selectedMonster) {
        window.location.href = `/adventure_battle/${selectedStage.id}/${selectedMonster}`;
    }
}

function getDifficultyColor(difficulty) {
    const colors = {
        'ì‰¬ì›€': '#4CAF50', 'ë³´í†µ': '#FFC107', 'ì–´ë ¤ì›€': '#FF9800',
        'ë§¤ìš° ì–´ë ¤ì›€': '#F44336', 'ê·¹ì•…': '#9C27B0'
    };
    return colors[difficulty] || '#999';
}
</script>
{% endblock %}
