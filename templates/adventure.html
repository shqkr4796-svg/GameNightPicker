{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">

<div class="adventure-wrapper">
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="adventure-header">
        <div class="header-content">
            <h1>âš”ï¸ ëª¨í—˜ ì‹œìŠ¤í…œ</h1>
            <div class="header-info">
                <div class="info-item">
                    <span class="info-label">í˜„ì¬ ìŠ¤í…Œì´ì§€</span>
                    <span class="info-number">{{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ìµœê³  ê¸°ë¡</span>
                    <span class="info-number">{{ cleared_stage }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ë³´ìœ  ê¸°ìˆ </span>
                    <span class="info-number">{{ player.get('ëª¨í—˜_ê¸°ìˆ ', [])|length }}/4</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="adventure-main">
        <!-- ì¢Œì¸¡: ìŠ¤í…Œì´ì§€ ëª©ë¡ -->
        <div class="stage-list-section">
            <h2 class="section-title">ğŸ“ ìŠ¤í…Œì´ì§€ ì„ íƒ</h2>
            <div class="stages-grid">
                {% for stage in stages %}
                {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
                <div class="stage-item {% if not is_unlocked %}disabled{% endif %}" 
                     data-stage="{{ stage.stage_id }}"
                     onclick="{% if is_unlocked %}selectStage({{ stage.stage_id }}, '{{ stage.ì´ë¦„ }}', {{ stage.enemy_hp_multiplier }}, {{ stage.enemy_attack_multiplier }}, {{ stage.skill_reward_rate }}, '{{ stage.ë‚œì´ë„ }}'){% endif %}">
                    
                    <div class="stage-icon">
                        <img src="{{ url_for('static', filename='images/fantasy_golden_stage_icon_transparent.png') }}" alt="stage">
                        <span class="stage-num">{{ stage.stage_id }}</span>
                        {% if stage.stage_id <= cleared_stage %}
                        <div class="stage-check">âœ“</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ìš°ì¸¡: ìŠ¤í…Œì´ì§€ ìƒì„¸ ì •ë³´ + ëª¬ìŠ¤í„° ì„ íƒ -->
        <div class="detail-panel">
            <!-- ìŠ¤í…Œì´ì§€ ì •ë³´ -->
            <div id="stageInfo" class="stage-info-box hidden">
                <h3 id="stageTitleInfo"></h3>
                <div class="info-grid">
                    <div class="info-box">
                        <span class="label">ë‚œì´ë„</span>
                        <span id="stageDiffInfo" class="value difficulty-badge"></span>
                    </div>
                    <div class="info-box">
                        <span class="label">ì  ì²´ë ¥</span>
                        <span id="stageHpInfo" class="value">x1.0</span>
                    </div>
                    <div class="info-box">
                        <span class="label">ì  ê³µê²©</span>
                        <span id="stageAtkInfo" class="value">x1.0</span>
                    </div>
                    <div class="info-box">
                        <span class="label">ê¸°ìˆ  ë“œë¡­</span>
                        <span id="stageDropInfo" class="value">0%</span>
                    </div>
                </div>
            </div>

            <!-- ëª¬ìŠ¤í„° ì„ íƒ -->
            {% if available_monsters %}
            <div class="monster-select-section">
                <h3>ğŸ‰ íŒŒí‹° ë¦¬ë” ì„ íƒ</h3>
                <div class="monster-grid">
                    {% for monster in available_monsters %}
                    <div class="monster-card" onclick="selectMonster('{{ monster.id }}', this)" data-monster="{{ monster.id }}">
                        <div class="monster-frame" style="background-image: url('{{ url_for('static', filename='images/monster_card_frame_transparent.png') }}');">
                            <div class="monster-image">
                                <img src="{{ monster.image }}" alt="{{ monster.name }}">
                            </div>
                            <div class="monster-details">
                                <div class="mon-name">{{ monster.name }}</div>
                                <div class="mon-rarity" style="background: 
                                    {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                                    {% elif monster.rarity == 'ì—í”½' %}#9932CC
                                    {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                                    {% else %}#FF1493{% endif %}">
                                    {{ monster.rarity }}
                                </div>
                                <div class="mon-stats">
                                    <span>âš”ï¸ {{ monster.attack }}</span>
                                    <span>â¤ï¸ {{ monster.hp }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ë„ì „ ë²„íŠ¼ -->
            <button id="challengeBtn" class="btn-challenge" disabled onclick="startChallenge()">
                ğŸ® ë„ì „í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<script>
let selectedStage = null;
let selectedMonster = null;

function selectStage(id, name, hp, atk, reward, difficulty) {
    selectedStage = { id, name, hp, atk, reward, difficulty };
    
    document.querySelectorAll('.stage-item').forEach(s => s.classList.remove('active'));
    document.querySelector(`[data-stage="${id}"]`).classList.add('active');
    
    document.getElementById('stageTitleInfo').textContent = name;
    document.getElementById('stageDiffInfo').textContent = difficulty;
    document.getElementById('stageDiffInfo').style.backgroundColor = getDifficultyColor(difficulty);
    document.getElementById('stageHpInfo').textContent = 'x' + hp.toFixed(1);
    document.getElementById('stageAtkInfo').textContent = 'x' + atk.toFixed(1);
    document.getElementById('stageDropInfo').textContent = Math.round(reward * 100) + '%';
    document.getElementById('stageInfo').classList.remove('hidden');
    
    updateBtn();
}

function selectMonster(id, element) {
    selectedMonster = id;
    document.querySelectorAll('.monster-card').forEach(m => m.classList.remove('selected'));
    element.classList.add('selected');
    updateBtn();
}

function updateBtn() {
    document.getElementById('challengeBtn').disabled = !selectedStage || !selectedMonster;
}

function startChallenge() {
    if (selectedStage && selectedMonster) {
        window.location.href = `/adventure_battle/${selectedStage.id}/${selectedMonster}`;
    }
}

function getDifficultyColor(difficulty) {
    const colors = {
        'ì‰¬ì›€': '#4CAF50', 'ë³´í†µ': '#FFC107', 'ì–´ë ¤ì›€': '#FF9800',
        'ë§¤ìš° ì–´ë ¤ì›€': '#F44336', 'ê·¹ì•…': '#9C27B0'
    };
    return colors[difficulty] || '#999';
}
</script>
{% endblock %}
