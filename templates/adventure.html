{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">

<div class="adventure-container">
    <!-- ìƒë‹¨: ë„ì „ ë²„íŠ¼ + ì§„í–‰ìƒí™© -->
    <div class="top-bar">
        <button id="startBtn" class="btn-start" disabled onclick="startBattle()">
            ğŸ® ë„ì „í•˜ê¸°
        </button>
        <div class="progress-info">
            <span>ìŠ¤í…Œì´ì§€: <strong id="currentStage">{{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }}</strong> | ìµœê³ : <strong>{{ cleared_stage }}</strong></span>
        </div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="main-content">
        <!-- ì¢Œì¸¡: ìŠ¤í…Œì´ì§€ ì„ íƒ -->
        <div class="left-panel">
            <div class="panel-header">âš”ï¸ ìŠ¤í…Œì´ì§€</div>
            <div class="stage-list">
                {% for stage in stages %}
                {% set unlocked = stage.stage_id <= cleared_stage + 1 %}
                <div class="stage-item {% if not unlocked %}locked{% endif %}"
                     onclick="{% if unlocked %}selectStage({{ stage.stage_id }}, '{{ stage.ì´ë¦„ }}', {{ stage.enemy_hp_multiplier }}, {{ stage.enemy_attack_multiplier }}, {{ stage.skill_reward_rate }}, '{{ stage.ë‚œì´ë„ }}'){% endif %}"
                     data-stage="{{ stage.stage_id }}">
                    <div class="stage-no">{{ stage.stage_id }}</div>
                    {% if stage.stage_id <= cleared_stage %}<div class="cleared-mark">âœ“</div>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ì¤‘ì•™: ìŠ¤í…Œì´ì§€ ì •ë³´ -->
        <div class="center-panel">
            <div id="infoBox" class="info-box" style="display: none;">
                <div class="info-header">
                    <div class="info-name" id="infoName"></div>
                    <div class="info-diff" id="infoDiff"></div>
                </div>
                <div class="info-details">
                    <div class="detail-line">
                        <span>ì  ì²´ë ¥:</span>
                        <span id="infoHp"></span>
                    </div>
                    <div class="detail-line">
                        <span>ì  ê³µê²©:</span>
                        <span id="infoAtk"></span>
                    </div>
                    <div class="detail-line">
                        <span>ê¸°ìˆ  ë“œë¡­:</span>
                        <span id="infoDrop"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: ëª¬ìŠ¤í„° ì„ íƒ -->
        <div class="right-panel">
            <div class="panel-header">ğŸ‰ ëª¬ìŠ¤í„°</div>
            <div class="monster-list">
                {% for monster in available_monsters %}
                <div class="monster-item" 
                     onclick="selectMonster('{{ monster.id }}', this)"
                     data-id="{{ monster.id }}">
                    <div class="mon-pic">
                        <img src="{{ monster.image }}" alt="{{ monster.name }}">
                    </div>
                    <div class="mon-info">
                        <div class="mon-nm">{{ monster.name }}</div>
                        <div class="mon-rarity" style="background:
                            {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                            {% elif monster.rarity == 'ì—í”½' %}#9932CC
                            {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                            {% else %}#FF1493{% endif %}">
                            {{ monster.rarity }}
                        </div>
                        <div class="mon-st">âš”ï¸{{ monster.attack }} â¤ï¸{{ monster.hp }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let selectedStageId = null;
let selectedMonsterId = null;

function selectStage(id, name, hp, atk, reward, diff) {
    selectedStageId = id;
    
    document.querySelectorAll('.stage-item').forEach(s => s.classList.remove('active'));
    document.querySelector(`[data-stage="${id}"]`).classList.add('active');
    
    document.getElementById('infoName').textContent = name;
    document.getElementById('infoDiff').textContent = diff;
    document.getElementById('infoDiff').style.color = getDiffColor(diff);
    document.getElementById('infoHp').textContent = 'x' + hp.toFixed(1);
    document.getElementById('infoAtk').textContent = 'x' + atk.toFixed(1);
    document.getElementById('infoDrop').textContent = Math.round(reward * 100) + '%';
    document.getElementById('infoBox').style.display = 'block';
    
    updateBtn();
}

function selectMonster(id, el) {
    selectedMonsterId = id;
    document.querySelectorAll('.monster-item').forEach(m => m.classList.remove('active'));
    el.classList.add('active');
    updateBtn();
}

function updateBtn() {
    document.getElementById('startBtn').disabled = !selectedStageId || !selectedMonsterId;
}

function startBattle() {
    if (selectedStageId && selectedMonsterId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("adventure_start_battle") }}';
        
        const stageInput = document.createElement('input');
        stageInput.name = 'stage_id';
        stageInput.value = selectedStageId;
        stageInput.type = 'hidden';
        
        const monsterInput = document.createElement('input');
        monsterInput.name = 'monster_id';
        monsterInput.value = selectedMonsterId;
        monsterInput.type = 'hidden';
        
        form.appendChild(stageInput);
        form.appendChild(monsterInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function getDiffColor(diff) {
    const colors = {
        'ì‰¬ì›€': '#4CAF50', 'ë³´í†µ': '#FFC107', 'ì–´ë ¤ì›€': '#FF9800',
        'ë§¤ìš° ì–´ë ¤ì›€': '#F44336', 'ê·¹ì•…': '#9C27B0'
    };
    return colors[diff] || '#999';
}
</script>
{% endblock %}
