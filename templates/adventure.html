{% extends "base.html" %}

{% block title %}ëª¨í—˜ - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure_map.css') }}">

<div class="adventure-container">
    <!-- ìƒë‹¨ ì •ë³´ ë°” -->
    <div class="adventure-top-bar">
        <div class="info-section">
            <span class="info-item">
                <i class="fas fa-star"></i> {{ player.get('ëª¨í—˜_í˜„ì¬ìŠ¤í…Œì´ì§€', 1) }}
            </span>
            <span class="info-item">
                <i class="fas fa-trophy"></i> ìµœê³ : {{ cleared_stage }}
            </span>
            <span class="info-item">
                <i class="fas fa-book"></i> ê¸°ìˆ : {{ player.get('ëª¨í—˜_ê¸°ìˆ ', [])|length }}/4
            </span>
        </div>

        <!-- ëŒ€í‘œ ëª¬ìŠ¤í„° ì„ íƒ -->
        {% if available_monsters %}
        <div class="monster-selector">
            <select id="selectedMonster" class="form-select form-select-sm">
                <option value="">ëŒ€í‘œ ëª¬ìŠ¤í„° ì„ íƒ...</option>
                {% for monster in available_monsters %}
                <option value="{{ monster.id }}">
                    ğŸ‰ {{ monster.name }} (âš”ï¸ {{ monster.attack }} | â¤ï¸ {{ monster.hp }}) - {{ monster.rarity }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="info-section">
            <span class="info-item">
                <i class="fas fa-coins"></i> {{ "{:,}".format(player['ëˆ']) }}
            </span>
        </div>
    </div>

    <!-- ë§µ ì˜ì—­ -->
    <div class="adventure-map-wrapper">
        <div class="adventure-map">
            <!-- ë°°ê²½ -->
            <div class="map-background">
                <!-- ìŠ¤í…Œì´ì§€ ë…¸ë“œë“¤ -->
                {% for stage in stages %}
                {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
                {% set position = stages|length %}
                <!-- ìŠ¤í…Œì´ì§€ë³„ ìœ„ì¹˜ ê³„ì‚° -->
                <div class="stage-node" 
                     style="left: calc({{ (stage.stage_id - 1) * (100 / (stages|length)) }}% + 50px); top: {{ (stage.stage_id % 2) * 150 + 100 }}px;"
                     data-stage-id="{{ stage.stage_id }}"
                     data-unlocked="{{ is_unlocked|lower }}">
                    
                    <div class="stage-badge {% if not is_unlocked %}locked{% endif %}">
                        <div class="stage-number">{{ stage.stage_id }}</div>
                    </div>

                    <div class="stage-tooltip">
                        <div class="tooltip-title">{{ stage.ì´ë¦„ }}</div>
                        <div class="tooltip-difficulty">{{ stage.ë‚œì´ë„ }}</div>
                        <div class="tooltip-stats">
                            ğŸ’ª ì²´ë ¥x{{ stage.enemy_hp_multiplier }} âš”ï¸ ê³µê²©x{{ stage.enemy_attack_multiplier }}
                        </div>
                        <div class="tooltip-reward">
                            ğŸ ê¸°ìˆ ë“œë¡­: {{ "%.0f"|format(stage.skill_reward_rate * 100) }}%
                        </div>
                        
                        {% if is_unlocked %}
                        <button class="btn btn-sm btn-success mt-2 w-100 challenge-btn" 
                                onclick="selectStage({{ stage.stage_id }})"
                                {% if not available_monsters %}disabled{% endif %}>
                            ë„ì „í•˜ê¸°
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-secondary mt-2 w-100" disabled>
                            ë¯¸ê°œë°©
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- ê²½ë¡œì„  -->
                {% for i in range(stages|length - 1) %}
                <svg class="path-line" style="left: 0; top: {{ (i % 2) * 150 + 150 }}px;">
                    <line x1="calc({{ (i * 100 / (stages|length)) }}% + 90px)" y1="0" 
                          x2="calc({{ ((i+1) * 100 / (stages|length)) }}% + 90px)" y2="0" 
                          stroke="#ffd700" stroke-width="3" stroke-dasharray="5,5"/>
                </svg>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="adventure-legend">
        <div class="legend-item">
            <div class="legend-badge">âœ“</div>
            <span>í´ë¦¬ì–´ë¨</span>
        </div>
        <div class="legend-item">
            <div class="legend-badge current">1</div>
            <span>í˜„ì¬ ì§„í–‰</span>
        </div>
        <div class="legend-item">
            <div class="legend-badge locked">ğŸ”’</div>
            <span>ë¯¸ê°œë°©</span>
        </div>
    </div>

    <!-- ì •ë³´ íŒ¨ë„ -->
    {% if available_monsters %}
    <div class="adventure-info-panel">
        <div class="panel-title">ğŸ‰ ëŒ€í‘œ ëª¬ìŠ¤í„° ì •ë³´</div>
        <div class="monster-info-grid">
            {% for monster in available_monsters %}
            <div class="monster-info-card" data-monster-id="{{ monster.id }}">
                <img src="{{ monster.image }}" alt="{{ monster.name }}" class="monster-thumb">
                <div class="monster-name">{{ monster.name }}</div>
                <div class="monster-stats">
                    <span>âš”ï¸ {{ monster.attack }}</span>
                    <span>â¤ï¸ {{ monster.hp }}</span>
                </div>
                <span class="badge monster-rarity" style="background-color: 
                    {% if monster.rarity == 'ë ˆì–´' %}#4169E1
                    {% elif monster.rarity == 'ì—í”½' %}#9932CC
                    {% elif monster.rarity == 'ìœ ë‹ˆí¬' %}#FFD700
                    {% else %}#FF1493{% endif %}">
                    {{ monster.rarity }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <strong>âš ï¸ ë„ê°ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!</strong><br>
        ë¨¼ì € ë˜ì „ì— ê°€ì„œ ëª¬ìŠ¤í„°ë¥¼ í¬íší•´ì£¼ì„¸ìš”.
    </div>
    <a href="{{ url_for('dungeons') }}" class="btn btn-primary">ë˜ì „ìœ¼ë¡œ ì´ë™</a>
    {% endif %}
</div>

<script>
    let selectedMonsterId = null;

    // ëª¬ìŠ¤í„° ì„ íƒ
    document.getElementById('selectedMonster')?.addEventListener('change', function(e) {
        selectedMonsterId = e.target.value;
        if (selectedMonsterId) {
            // ì„ íƒëœ ëª¬ìŠ¤í„° ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
            document.querySelectorAll('.monster-info-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-monster-id="${selectedMonsterId}"]`)?.classList.add('selected');
        }
    });

    // ìŠ¤í…Œì´ì§€ ì„ íƒ
    function selectStage(stageId) {
        if (!selectedMonsterId) {
            alert('ë¨¼ì € ëŒ€í‘œ ëª¬ìŠ¤í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }
        
        // ì „íˆ¬ ì‹œì‘ - ë™ì ìœ¼ë¡œ URL ìƒì„±
        const url = `/adventure_battle/${stageId}/${selectedMonsterId}`;
        window.location.href = url;
    }
</script>
{% endblock %}
