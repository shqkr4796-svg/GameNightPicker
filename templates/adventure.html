{% extends "base.html" %}

{% block title %}모험 - 라이프 시뮬레이션{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/adventure.css') }}">

<div class="adventure-container">
    <!-- 헤더 -->
    <div class="adventure-header">
        <h1>⚔️ 모험</h1>
        <div class="header-stats">
            <div class="stat">
                <span class="label">현재</span>
                <span class="value">{{ player.get('모험_현재스테이지', 1) }}</span>
            </div>
            <div class="stat">
                <span class="label">최고</span>
                <span class="value">{{ cleared_stage }}</span>
            </div>
            <div class="stat">
                <span class="label">기술</span>
                <span class="value">{{ player.get('모험_기술', [])|length }}/4</span>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="adventure-main">
        <!-- 왼쪽: 스테이지 맵 -->
        <div class="stage-map">
            <div class="stages-scroll">
                {% for stage in stages %}
                {% set is_unlocked = stage.stage_id <= cleared_stage + 1 %}
                <div class="stage-card {% if is_unlocked %}unlocked{% else %}locked{% endif %}" 
                     onclick="{% if is_unlocked %}selectStage({{ stage.stage_id }}){% endif %}"
                     data-stage="{{ stage.stage_id }}">
                    <div class="stage-number">{{ stage.stage_id }}</div>
                    <div class="stage-check">{% if stage.stage_id <= cleared_stage %}✓{% endif %}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 오른쪽: 상세 정보 + 몬스터 선택 -->
        <div class="stage-panel">
            <div id="stageInfo" class="stage-info hidden">
                <div class="info-header">
                    <h2 id="infoTitle"></h2>
                    <span id="infoDifficulty" class="difficulty-badge"></span>
                </div>
                <div class="info-details">
                    <div class="detail-item">
                        <span class="detail-label">체력</span>
                        <span class="detail-value" id="infoHP"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">공격력</span>
                        <span class="detail-value" id="infoAttack"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">기술 드롭</span>
                        <span class="detail-value" id="infoReward"></span>
                    </div>
                </div>
            </div>

            {% if available_monsters %}
            <div class="monster-select">
                <h3>파티 리더 선택</h3>
                <div class="monsters-list">
                    {% for monster in available_monsters %}
                    <div class="monster-item" onclick="selectMonster('{{ monster.id }}')">
                        <div class="monster-image">
                            <img src="{{ monster.image }}" alt="{{ monster.name }}">
                        </div>
                        <div class="monster-details">
                            <div class="monster-name">{{ monster.name }}</div>
                            <div class="monster-stats">
                                <span>⚔️ {{ monster.attack }}</span>
                                <span>❤️ {{ monster.hp }}</span>
                            </div>
                            <div class="monster-rarity" style="background: 
                                {% if monster.rarity == '레어' %}#4169E1
                                {% elif monster.rarity == '에픽' %}#9932CC
                                {% elif monster.rarity == '유니크' %}#FFD700
                                {% else %}#FF1493{% endif %}">
                                {{ monster.rarity }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="action-area">
                <button id="challengeBtn" class="btn-challenge" disabled onclick="startBattle()">
                    도전하기
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedStage = null;
let selectedMonster = null;

function selectStage(stageId) {
    selectedStage = stageId;
    document.querySelectorAll('.stage-card').forEach(c => c.classList.remove('active'));
    document.querySelector(`[data-stage="${stageId}"]`).classList.add('active');
    
    const stageNode = document.querySelector(`[data-stage-id="${stageId}"]`);
    if (!stageNode) {
        const stages = {{ stages|tojson }};
        const stage = stages.find(s => s.stage_id === stageId);
        if (stage) {
            document.getElementById('infoTitle').textContent = stage.이름;
            document.getElementById('infoDifficulty').textContent = stage.난이도;
            document.getElementById('infoDifficulty').style.backgroundColor = getDifficultyColor(stage.난이도);
            document.getElementById('infoHP').textContent = 'x' + stage.enemy_hp_multiplier.toFixed(1);
            document.getElementById('infoAttack').textContent = 'x' + stage.enemy_attack_multiplier.toFixed(1);
            document.getElementById('infoReward').textContent = Math.round(stage.skill_reward_rate * 100) + '%';
            document.getElementById('stageInfo').classList.remove('hidden');
            updateChallengeBtn();
        }
    }
}

function selectMonster(monsterId) {
    selectedMonster = monsterId;
    document.querySelectorAll('.monster-item').forEach(m => m.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateChallengeBtn();
}

function updateChallengeBtn() {
    document.getElementById('challengeBtn').disabled = !selectedStage || !selectedMonster;
}

function startBattle() {
    if (selectedStage && selectedMonster) {
        window.location.href = `/adventure_battle/${selectedStage}/${selectedMonster}`;
    }
}

function getDifficultyColor(difficulty) {
    const colors = {
        '쉬움': '#4CAF50',
        '보통': '#FFC107',
        '어려움': '#FF9800',
        '매우 어려움': '#F44336',
        '극악': '#9C27B0'
    };
    return colors[difficulty] || '#999';
}
</script>
{% endblock %}
