{% extends "base.html" %}

{% block title %}ÏÉÅÏ†ê - ÎùºÏù¥ÌîÑ ÏãúÎÆ¨Î†àÏù¥ÏÖò{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-all" data-bs-toggle="tab" data-bs-target="#panel-all" 
                                type="button" role="tab" aria-controls="panel-all" aria-selected="true">
                            Ï†ÑÏ≤¥
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-weapon" data-bs-toggle="tab" data-bs-target="#panel-weapon" 
                                type="button" role="tab" aria-controls="panel-weapon" aria-selected="false">
                            ÎçòÏ†Ñ Î¨¥Í∏∞
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-dungeon" data-bs-toggle="tab" data-bs-target="#panel-dungeon" 
                                type="button" role="tab" aria-controls="panel-dungeon" aria-selected="false">
                            ÎçòÏ†Ñ ÏïÑÏù¥ÌÖú
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-other" data-bs-toggle="tab" data-bs-target="#panel-other" 
                                type="button" role="tab" aria-controls="panel-other" aria-selected="false">
                            Í∏∞ÌÉÄ
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content">
                <!-- Ï†ÑÏ≤¥ ÌÉ≠ -->
                <div class="tab-pane fade show active" id="panel-all" role="tabpanel" aria-labelledby="tab-all">
                    <div class="card-body">
                        <div class="row">
                            {% for item in items %}
                            {% set can_afford = player['Îèà'] >= item['Í∞ÄÍ≤©'] %}
                            {% set level_ok = not item.get('Î†àÎ≤®_Ï†úÌïú') or player['Î†àÎ≤®'] >= item.get('Î†àÎ≤®_Ï†úÌïú', 0) %}
                            {% set can_buy = can_afford and level_ok %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 {% if not can_buy %}opacity-50{% endif %} 
                                     border-{% if item.get('ÌÉÄÏûÖ') == 'Î¨¥Í∏∞' %}danger{% elif item.get('ÌÉÄÏûÖ') == 'ÎçòÏ†Ñ' %}warning{% elif item.get('ÌÉÄÏûÖ') == 'Ïä§ÌÉØ' %}info{% else %}secondary{% endif %}">
                                    <div class="card-header p-2">
                                        <h6 class="card-title mb-0">{{ item['Ïù¥Î¶Ñ'] }}</h6>
                                        <span class="badge bg-{% if item.get('ÌÉÄÏûÖ') == 'Î¨¥Í∏∞' %}danger{% elif item.get('ÌÉÄÏûÖ') == 'ÎçòÏ†Ñ' %}warning{% elif item.get('ÌÉÄÏûÖ') == 'Ïä§ÌÉØ' %}info{% else %}secondary{% endif %} fs-7">
                                            {% if item.get('ÌÉÄÏûÖ') == 'Î¨¥Í∏∞' %}ÎçòÏ†Ñ Î¨¥Í∏∞{% elif item.get('ÌÉÄÏûÖ') == 'ÎçòÏ†Ñ' %}ÎçòÏ†Ñ Ï†ÑÏö©{% elif item.get('ÌÉÄÏûÖ') == 'Ïä§ÌÉØ' %}Ïä§ÌÉØ Ï¶ùÍ∞Ä{% else %}ÏùºÎ∞ò{% endif %}
                                        </span>
                                    </div>
                                    <div class="card-body d-flex" style="gap: 12px;">
                                        <!-- ÏôºÏ™Ω: Ï†ïÎ≥¥ -->
                                        <div style="flex: 1;">
                                            <p class="text-muted small">{{ item['ÏÑ§Î™Ö'] }}</p>
                                            
                                            <!-- ÏïÑÏù¥ÌÖú Ìö®Í≥º -->
                                            <div class="mb-3">
                                                <small class="text-info">Ìö®Í≥º:</small><br>
                                                {% for effect, value in item['Ìö®Í≥º'].items() %}
                                                    <small class="badge bg-{% if item.get('ÌÉÄÏûÖ') == 'ÎçòÏ†Ñ' %}warning{% else %}secondary{% endif %} me-1">
                                                        {{ effect }} {% if value > 0 %}+{% endif %}{{ value }}
                                                    </small>
                                                {% endfor %}
                                                {% if item.get('Î†àÎ≤®_Ï†úÌïú') %}
                                                    <br><small class="text-warning">ÌïÑÏöî Î†àÎ≤®: {{ item['Î†àÎ≤®_Ï†úÌïú'] }}</small>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong class="text-primary">{{ "{:,}".format(item['Í∞ÄÍ≤©']) }}Ïõê</strong>
                                                <form method="POST" action="{{ url_for('buy_item') }}">
                                                    <input type="hidden" name="item_id" value="{{ loop.index0 }}">
                                                    <button type="submit" class="btn btn-sm {% if can_buy %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                                            {% if not can_buy %}disabled{% endif %}>
                                                        {% if not level_ok %}Î†àÎ≤®Î∂ÄÏ°±{% elif not can_afford %}ÏûêÍ∏àÎ∂ÄÏ°±{% else %}Íµ¨Îß§{% endif %}
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        
                                        <!-- Ïò§Î•∏Ï™Ω: Ïù¥ÎØ∏ÏßÄ -->
                                        {% if item.get('Ïù¥ÎØ∏ÏßÄ') %}
                                        <div style="width: 100px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                                            <img src="{{ item['Ïù¥ÎØ∏ÏßÄ'] }}" alt="{{ item['Ïù¥Î¶Ñ'] }}" style="max-height: 100px; max-width: 100%; object-fit: contain; padding: 8px;">
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- ÎçòÏ†Ñ Î¨¥Í∏∞ ÌÉ≠ -->
                <div class="tab-pane fade" id="panel-weapon" role="tabpanel" aria-labelledby="tab-weapon">
                    <div class="card-body">
                        <div class="row">
                            {% set weapon_items = items|selectattr('ÌÉÄÏûÖ', 'equalto', 'Î¨¥Í∏∞')|list %}
                            {% if weapon_items|length > 0 %}
                                {% for item in weapon_items %}
                                {% set can_afford = player['Îèà'] >= item['Í∞ÄÍ≤©'] %}
                                {% set level_ok = not item.get('Î†àÎ≤®_Ï†úÌïú') or player['Î†àÎ≤®'] >= item.get('Î†àÎ≤®_Ï†úÌïú', 0) %}
                                {% set can_buy = can_afford and level_ok %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 {% if not can_buy %}opacity-50{% endif %} border-danger">
                                        <div class="card-header p-2">
                                            <h6 class="card-title mb-0">{{ item['Ïù¥Î¶Ñ'] }}</h6>
                                            <span class="badge bg-danger fs-7">ÎçòÏ†Ñ Î¨¥Í∏∞</span>
                                        </div>
                                        <div class="card-body d-flex" style="gap: 12px;">
                                            <div style="flex: 1;">
                                                <p class="text-muted small">{{ item['ÏÑ§Î™Ö'] }}</p>
                                                <div class="mb-3">
                                                    <small class="text-info">Ìö®Í≥º:</small><br>
                                                    {% for effect, value in item['Ìö®Í≥º'].items() %}
                                                        <small class="badge bg-secondary me-1">{{ effect }} {% if value > 0 %}+{% endif %}{{ value }}</small>
                                                    {% endfor %}
                                                    {% if item.get('Î†àÎ≤®_Ï†úÌïú') %}
                                                        <br><small class="text-warning">ÌïÑÏöî Î†àÎ≤®: {{ item['Î†àÎ≤®_Ï†úÌïú'] }}</small>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong class="text-primary">{{ "{:,}".format(item['Í∞ÄÍ≤©']) }}Ïõê</strong>
                                                    <form method="POST" action="{{ url_for('buy_item') }}">
                                                        <input type="hidden" name="item_id" value="{{ items.index(item) }}">
                                                        <button type="submit" class="btn btn-sm {% if can_buy %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                                                {% if not can_buy %}disabled{% endif %}>
                                                            {% if not level_ok %}Î†àÎ≤®Î∂ÄÏ°±{% elif not can_afford %}ÏûêÍ∏àÎ∂ÄÏ°±{% else %}Íµ¨Îß§{% endif %}
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if item.get('Ïù¥ÎØ∏ÏßÄ') %}
                                            <div style="width: 100px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                                                <img src="{{ item['Ïù¥ÎØ∏ÏßÄ'] }}" alt="{{ item['Ïù¥Î¶Ñ'] }}" style="max-height: 100px; max-width: 100%; object-fit: contain; padding: 8px;">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="col-12">
                                <p class="text-muted text-center">ÎçòÏ†Ñ Î¨¥Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- ÎçòÏ†Ñ ÏïÑÏù¥ÌÖú ÌÉ≠ -->
                <div class="tab-pane fade" id="panel-dungeon" role="tabpanel" aria-labelledby="tab-dungeon">
                    <div class="card-body">
                        <div class="row">
                            {% set dungeon_items = items|selectattr('ÌÉÄÏûÖ', 'equalto', 'ÎçòÏ†Ñ')|list %}
                            {% if dungeon_items|length > 0 %}
                                {% for item in dungeon_items %}
                                {% set can_afford = player['Îèà'] >= item['Í∞ÄÍ≤©'] %}
                                {% set level_ok = not item.get('Î†àÎ≤®_Ï†úÌïú') or player['Î†àÎ≤®'] >= item.get('Î†àÎ≤®_Ï†úÌïú', 0) %}
                                {% set can_buy = can_afford and level_ok %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 {% if not can_buy %}opacity-50{% endif %} border-warning">
                                        <div class="card-header p-2">
                                            <h6 class="card-title mb-0">{{ item['Ïù¥Î¶Ñ'] }}</h6>
                                            <span class="badge bg-warning fs-7">ÎçòÏ†Ñ Ï†ÑÏö©</span>
                                        </div>
                                        <div class="card-body d-flex" style="gap: 12px;">
                                            <div style="flex: 1;">
                                                <p class="text-muted small">{{ item['ÏÑ§Î™Ö'] }}</p>
                                                <div class="mb-3">
                                                    <small class="text-info">Ìö®Í≥º:</small><br>
                                                    {% for effect, value in item['Ìö®Í≥º'].items() %}
                                                        <small class="badge bg-warning me-1">{{ effect }} {% if value > 0 %}+{% endif %}{{ value }}</small>
                                                    {% endfor %}
                                                    {% if item.get('Î†àÎ≤®_Ï†úÌïú') %}
                                                        <br><small class="text-warning">ÌïÑÏöî Î†àÎ≤®: {{ item['Î†àÎ≤®_Ï†úÌïú'] }}</small>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong class="text-primary">{{ "{:,}".format(item['Í∞ÄÍ≤©']) }}Ïõê</strong>
                                                    <form method="POST" action="{{ url_for('buy_item') }}">
                                                        <input type="hidden" name="item_id" value="{{ items.index(item) }}">
                                                        <button type="submit" class="btn btn-sm {% if can_buy %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                                                {% if not can_buy %}disabled{% endif %}>
                                                            {% if not level_ok %}Î†àÎ≤®Î∂ÄÏ°±{% elif not can_afford %}ÏûêÍ∏àÎ∂ÄÏ°±{% else %}Íµ¨Îß§{% endif %}
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if item.get('Ïù¥ÎØ∏ÏßÄ') %}
                                            <div style="width: 100px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                                                <img src="{{ item['Ïù¥ÎØ∏ÏßÄ'] }}" alt="{{ item['Ïù¥Î¶Ñ'] }}" style="max-height: 100px; max-width: 100%; object-fit: contain; padding: 8px;">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="col-12">
                                <p class="text-muted text-center">ÎçòÏ†Ñ ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Í∏∞ÌÉÄ ÌÉ≠ -->
                <div class="tab-pane fade" id="panel-other" role="tabpanel" aria-labelledby="tab-other">
                    <div class="card-body">
                        <div class="row">
                            {% set other_items = items|rejectattr('ÌÉÄÏûÖ', 'in', ['Î¨¥Í∏∞', 'ÎçòÏ†Ñ'])|list %}
                            {% if other_items|length > 0 %}
                                {% for item in other_items %}
                                {% set can_afford = player['Îèà'] >= item['Í∞ÄÍ≤©'] %}
                                {% set level_ok = not item.get('Î†àÎ≤®_Ï†úÌïú') or player['Î†àÎ≤®'] >= item.get('Î†àÎ≤®_Ï†úÌïú', 0) %}
                                {% set can_buy = can_afford and level_ok %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 {% if not can_buy %}opacity-50{% endif %} border-secondary">
                                        <div class="card-header p-2">
                                            <h6 class="card-title mb-0">{{ item['Ïù¥Î¶Ñ'] }}</h6>
                                            <span class="badge bg-secondary fs-7">ÏùºÎ∞ò</span>
                                        </div>
                                        <div class="card-body d-flex" style="gap: 12px;">
                                            <div style="flex: 1;">
                                                <p class="text-muted small">{{ item['ÏÑ§Î™Ö'] }}</p>
                                                <div class="mb-3">
                                                    <small class="text-info">Ìö®Í≥º:</small><br>
                                                    {% for effect, value in item['Ìö®Í≥º'].items() %}
                                                        <small class="badge bg-secondary me-1">{{ effect }} {% if value > 0 %}+{% endif %}{{ value }}</small>
                                                    {% endfor %}
                                                    {% if item.get('Î†àÎ≤®_Ï†úÌïú') %}
                                                        <br><small class="text-warning">ÌïÑÏöî Î†àÎ≤®: {{ item['Î†àÎ≤®_Ï†úÌïú'] }}</small>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong class="text-primary">{{ "{:,}".format(item['Í∞ÄÍ≤©']) }}Ïõê</strong>
                                                    <form method="POST" action="{{ url_for('buy_item') }}">
                                                        <input type="hidden" name="item_id" value="{{ items.index(item) }}">
                                                        <button type="submit" class="btn btn-sm {% if can_buy %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                                                {% if not can_buy %}disabled{% endif %}>
                                                            {% if not level_ok %}Î†àÎ≤®Î∂ÄÏ°±{% elif not can_afford %}ÏûêÍ∏àÎ∂ÄÏ°±{% else %}Íµ¨Îß§{% endif %}
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if item.get('Ïù¥ÎØ∏ÏßÄ') %}
                                            <div style="width: 100px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                                                <img src="{{ item['Ïù¥ÎØ∏ÏßÄ'] }}" alt="{{ item['Ïù¥Î¶Ñ'] }}" style="max-height: 100px; max-width: 100%; object-fit: contain; padding: 8px;">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="col-12">
                                <p class="text-muted text-center">Í∏∞ÌÉÄ ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Î≥¥Ïú† ÌòÑÍ∏à -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="dollar-sign" class="me-2"></i>Î≥¥Ïú† ÌòÑÍ∏à
                </h5>
            </div>
            <div class="card-body text-center">
                <h3 class="text-success">{{ "{:,}".format(player['Îèà']) }}Ïõê</h3>
            </div>
        </div>

        <!-- ÎçòÏ†Ñ Ïù∏Î≤§ÌÜ†Î¶¨ -->
        {% if player.get('ÎçòÏ†Ñ_Ïù∏Î≤§ÌÜ†Î¶¨') and player['ÎçòÏ†Ñ_Ïù∏Î≤§ÌÜ†Î¶¨']|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield me-2"></i>ÎçòÏ†Ñ Ïù∏Î≤§ÌÜ†Î¶¨
                </h5>
            </div>
            <div class="card-body">
                {% for item_name, count in player['ÎçòÏ†Ñ_Ïù∏Î≤§ÌÜ†Î¶¨'].items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ item_name }}</span>
                    <span class="badge bg-warning">{{ count }}Í∞ú</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- ÏùºÎ∞ò Ïù∏Î≤§ÌÜ†Î¶¨ -->
        {% if player.get('Ïù∏Î≤§ÌÜ†Î¶¨') and player['Ïù∏Î≤§ÌÜ†Î¶¨']|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i>ÏùºÎ∞ò Ïù∏Î≤§ÌÜ†Î¶¨
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h3 class="text-info">{{ player['Ïù∏Î≤§ÌÜ†Î¶¨']|length }}</h3>
                    <small class="text-muted">Î≥¥Ïú† ÏïÑÏù¥ÌÖú Ïàò</small>
                </div>
                
                <div class="list-group list-group-flush">
                    {% for item in player['Ïù∏Î≤§ÌÜ†Î¶¨'] %}
                    <div class="list-group-item d-flex align-items-center px-0">
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>{{ item }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ÏÉÅÏ†ê ÏïàÎÇ¥ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="info" class="me-2"></i>ÏÉÅÏ†ê ÏïàÎÇ¥
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>ÏïÑÏù¥ÌÖúÏùÑ Íµ¨Îß§ÌïòÎ©¥ Ï¶âÏãú Ìö®Í≥ºÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§.</small>
                    </li>
                    <li class="mb-2">
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>Ï≤¥Î†•Í≥º Í∏∞Î†•ÏùÄ ÏµúÎåÄ 10ÍπåÏßÄÎßå Ï¶ùÍ∞ÄÌï©ÎãàÎã§.</small>
                    </li>
                    <li>
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>ÎèàÏùÑ Î≤åÏñ¥ÏÑú Îçî Ï¢ãÏùÄ ÏïÑÏù¥ÌÖúÏùÑ Íµ¨Îß§Ìï¥Î≥¥ÏÑ∏Ïöî!</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    /* ÌôúÏÑ± ÌÉ≠Ïùò Í∏ÄÏî® ÏÉâÏÉÅ */
    .nav-link.active {
        color: #212529 !important;
    }
</style>

<script>
// ÏÉÅÏ†ê Î∞∞Í≤ΩÏùåÏïÖ Ï†ÑÏó≠ Î≥ÄÏàò
window.shopAudioContext = null;
window.shopBgmOscillators = [];
window.shopBgmGains = [];

function initShopAudioContext() {
    if (!window.shopAudioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
            window.shopAudioContext = new AudioContext();
            console.log('üéµ ÏÉÅÏ†ê Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî');
        }
    }
    return window.shopAudioContext;
}

function startShopBackgroundMusic() {
    try {
        if (!window.shopAudioContext) {
            initShopAudioContext();
        }
        
        if (!window.shopAudioContext) {
            console.log('Ïò§ÎîîÏò§ ÏßÄÏõê ÏïàÎê®');
            return;
        }
        
        const shopAudioContext = window.shopAudioContext;
        
        // Í∏∞Ï°¥ oscillators Ï†ïÎ¶¨
        window.shopBgmOscillators.forEach(osc => {
            try { osc.stop(); } catch(e) {}
        });
        window.shopBgmOscillators = [];
        window.shopBgmGains = [];
        
        const now = shopAudioContext.currentTime;
        const masterGain = shopAudioContext.createGain();
        masterGain.gain.setValueAtTime(0.28, now);
        masterGain.connect(shopAudioContext.destination);
        
        // ÏÉÅÏ†êÏö© Î∞úÎûÑÌïòÍ≥† ÏÉÅÌÅºÌïú Î©úÎ°úÎîî - Î∞ùÍ≥† Îπ†Î•∏ ÎäêÎÇå
        const melodyFreqs = [
            // Ï≤´Î≤àÏß∏ ÎùºÏù∏ - G Î©îÏù¥Ï†Ä, Î∞ùÍ≥† ÌôúÎ∞úÌï®
            392.00, 523.25, 587.33, 523.25,  // G5, C6, D6, C6
            392.00, 523.25, 659.25, 587.33,  // G5, C6, E6, D6
            523.25, 587.33, 659.25, 783.99,  // C6, D6, E6, G6
            659.25, 587.33, 523.25, 392.00,  // E6, D6, C6, G5
            // ÎëêÎ≤àÏß∏ ÎùºÏù∏ - Î∞ùÏùÄ ÏïÑÎ•¥ÌéòÏßÄÏò§
            587.33, 659.25, 783.99, 659.25,  // D6, E6, G6, E6
            523.25, 587.33, 659.25, 523.25,  // C6, D6, E6, C6
            392.00, 523.25, 587.33, 659.25,  // G5, C6, D6, E6
            523.25, 392.00, 659.25, 523.25   // C6, G5, E6, C6
        ];
        
        const chordFreqs = [
            [392.00, 523.25, 659.25],   // G Î©îÏù¥Ï†Ä (G, C, E)
            [523.25, 659.25, 783.99]    // C Î©îÏù¥Ï†Ä (C, E, G)
        ];
        
        const loopDuration = 12;
        
        function playMelody(loopStartTime) {
            melodyFreqs.forEach((freq, i) => {
                const noteStart = loopStartTime + i * 0.25;  // Îçî Îπ†Î•∏ ÏÜçÎèÑ (0.25Ï¥à)
                const noteDuration = 0.22;
                
                const osc = shopAudioContext.createOscillator();
                const gain = shopAudioContext.createGain();
                
                osc.type = 'triangle';  // Î∞ùÏùÄ ÏÇºÍ∞ÅÌåå ÏùåÏÉâ
                osc.frequency.setValueAtTime(freq, noteStart);
                
                gain.gain.setValueAtTime(0, noteStart);
                gain.gain.linearRampToValueAtTime(0.25, noteStart + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, noteStart + noteDuration);
                
                osc.connect(gain);
                gain.connect(masterGain);
                
                osc.start(noteStart);
                osc.stop(noteStart + noteDuration + 0.1);
                
                window.shopBgmOscillators.push(osc);
                window.shopBgmGains.push(gain);
            });
        }
        
        function playChords(loopStartTime) {
            chordFreqs.forEach((freqs, chordIdx) => {
                const chordStart = loopStartTime + chordIdx * 3;
                const chordDuration = 2.8;
                
                freqs.forEach(freq => {
                    const osc = shopAudioContext.createOscillator();
                    const gain = shopAudioContext.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, chordStart);
                    
                    gain.gain.setValueAtTime(0, chordStart);
                    gain.gain.linearRampToValueAtTime(0.1, chordStart + 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, chordStart + chordDuration);
                    
                    osc.connect(gain);
                    gain.connect(masterGain);
                    
                    osc.start(chordStart);
                    osc.stop(chordStart + chordDuration + 0.1);
                    
                    window.shopBgmOscillators.push(osc);
                    window.shopBgmGains.push(gain);
                });
            });
        }
        
        playMelody(now);
        playChords(now);
        
        const loopTimer = setInterval(() => {
            if (shopAudioContext.state === 'running') {
                playMelody(shopAudioContext.currentTime);
                playChords(shopAudioContext.currentTime);
            }
        }, loopDuration * 1000);
        
        window.shopBgmLoopTimer = loopTimer;
        console.log('üéµ ÏÉÅÏ†ê Î∞∞Í≤ΩÏùåÏïÖ Ïû¨ÏÉù Ï§ë');
    } catch(e) {
        console.log('ÏÉÅÏ†ê Î∞∞Í≤ΩÏùåÏïÖ Ïò§Î•ò:', e.message || e);
    }
}

function stopShopBackgroundMusic() {
    try {
        if (window.shopBgmLoopTimer) {
            clearInterval(window.shopBgmLoopTimer);
            window.shopBgmLoopTimer = null;
        }
        
        window.shopBgmOscillators.forEach(osc => {
            try { osc.stop(); } catch(e) {}
        });
        window.shopBgmOscillators = [];
        window.shopBgmGains = [];
        
        console.log('üéµ ÏÉÅÏ†ê Î∞∞Í≤ΩÏùåÏïÖ Ï¢ÖÎ£å');
    } catch(e) {
        console.log('ÏÉÅÏ†ê Î∞∞Í≤ΩÏùåÏïÖ Ï§ëÏßÄ Ïò§Î•ò:', e.message || e);
    }
}

// Ï¶âÏãú Ïã§Ìñâ
(function() {
    startShopBackgroundMusic();
    window.addEventListener('beforeunload', stopShopBackgroundMusic);
    window.addEventListener('pagehide', stopShopBackgroundMusic);
})();
</script>
{% endblock %}
