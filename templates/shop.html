{% extends "base.html" %}

{% block title %}ìƒì  - ë¼ì´í”„ ì‹œë®¬ë ˆì´ì…˜{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="shopping-cart" class="me-2"></i>ìƒì  ì•„ì´í…œ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for item in items %}
                    {% set can_afford = player['ëˆ'] >= item['ê°€ê²©'] %}
                    {% set level_ok = not item.get('ë ˆë²¨_ì œí•œ') or player['ë ˆë²¨'] >= item.get('ë ˆë²¨_ì œí•œ', 0) %}
                    {% set can_buy = can_afford and level_ok %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 {% if not can_buy %}opacity-50{% endif %} 
                             border-{% if item.get('íƒ€ì…') == 'ë¬´ê¸°' %}danger{% elif item.get('íƒ€ì…') == 'ë˜ì „' %}warning{% elif item.get('íƒ€ì…') == 'ìŠ¤íƒ¯' %}info{% else %}secondary{% endif %}">
                            <div class="card-header p-2">
                                <h6 class="card-title mb-0">{{ item['ì´ë¦„'] }}</h6>
                                <span class="badge bg-{% if item.get('íƒ€ì…') == 'ë¬´ê¸°' %}danger{% elif item.get('íƒ€ì…') == 'ë˜ì „' %}warning{% elif item.get('íƒ€ì…') == 'ìŠ¤íƒ¯' %}info{% else %}secondary{% endif %} fs-7">
                                    {% if item.get('íƒ€ì…') == 'ë¬´ê¸°' %}ë˜ì „ ë¬´ê¸°{% elif item.get('íƒ€ì…') == 'ë˜ì „' %}ë˜ì „ ì „ìš©{% elif item.get('íƒ€ì…') == 'ìŠ¤íƒ¯' %}ìŠ¤íƒ¯ ì¦ê°€{% else %}ì¼ë°˜{% endif %}
                                </span>
                            </div>
                            <div class="card-body d-flex" style="gap: 12px;">
                                <!-- ì™¼ìª½: ì •ë³´ -->
                                <div style="flex: 1;">
                                    <p class="text-muted small">{{ item['ì„¤ëª…'] }}</p>
                                    
                                    <!-- ì•„ì´í…œ íš¨ê³¼ -->
                                    <div class="mb-3">
                                        <small class="text-info">íš¨ê³¼:</small><br>
                                        {% for effect, value in item['íš¨ê³¼'].items() %}
                                            <small class="badge bg-{% if item.get('íƒ€ì…') == 'ë˜ì „' %}warning{% else %}secondary{% endif %} me-1">
                                                {{ effect }} {% if value > 0 %}+{% endif %}{{ value }}
                                            </small>
                                        {% endfor %}
                                        {% if item.get('ë ˆë²¨_ì œí•œ') %}
                                            <br><small class="text-warning">í•„ìš” ë ˆë²¨: {{ item['ë ˆë²¨_ì œí•œ'] }}</small>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="text-primary">{{ "{:,}".format(item['ê°€ê²©']) }}ì›</strong>
                                        <form method="POST" action="{{ url_for('buy_item') }}">
                                            <input type="hidden" name="item_id" value="{{ loop.index0 }}">
                                            <button type="submit" class="btn btn-sm {% if can_buy %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                                    {% if not can_buy %}disabled{% endif %}>
                                                {% if not level_ok %}ë ˆë²¨ë¶€ì¡±{% elif not can_afford %}ìê¸ˆë¶€ì¡±{% else %}êµ¬ë§¤{% endif %}
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ -->
                                {% if item.get('ì´ë¯¸ì§€') %}
                                <div style="width: 100px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                                    <img src="{{ item['ì´ë¯¸ì§€'] }}" alt="{{ item['ì´ë¦„'] }}" style="max-height: 100px; max-width: 100%; object-fit: contain; padding: 8px;">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- ë³´ìœ  í˜„ê¸ˆ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="dollar-sign" class="me-2"></i>ë³´ìœ  í˜„ê¸ˆ
                </h5>
            </div>
            <div class="card-body text-center">
                <h3 class="text-success">{{ "{:,}".format(player['ëˆ']) }}ì›</h3>
            </div>
        </div>

        <!-- ë˜ì „ ì¸ë²¤í† ë¦¬ -->
        {% if player.get('ë˜ì „_ì¸ë²¤í† ë¦¬') and player['ë˜ì „_ì¸ë²¤í† ë¦¬']|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield me-2"></i>ë˜ì „ ì¸ë²¤í† ë¦¬
                </h5>
            </div>
            <div class="card-body">
                {% for item_name, count in player['ë˜ì „_ì¸ë²¤í† ë¦¬'].items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ item_name }}</span>
                    <span class="badge bg-warning">{{ count }}ê°œ</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- ì¼ë°˜ ì¸ë²¤í† ë¦¬ -->
        {% if player.get('ì¸ë²¤í† ë¦¬') and player['ì¸ë²¤í† ë¦¬']|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i>ì¼ë°˜ ì¸ë²¤í† ë¦¬
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h3 class="text-info">{{ player['ì¸ë²¤í† ë¦¬']|length }}</h3>
                    <small class="text-muted">ë³´ìœ  ì•„ì´í…œ ìˆ˜</small>
                </div>
                
                <div class="list-group list-group-flush">
                    {% for item in player['ì¸ë²¤í† ë¦¬'] %}
                    <div class="list-group-item d-flex align-items-center px-0">
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>{{ item }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ìƒì  ì•ˆë‚´ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="info" class="me-2"></i>ìƒì  ì•ˆë‚´
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>ì•„ì´í…œì„ êµ¬ë§¤í•˜ë©´ ì¦‰ì‹œ íš¨ê³¼ê°€ ì ìš©ë©ë‹ˆë‹¤.</small>
                    </li>
                    <li class="mb-2">
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>ì²´ë ¥ê³¼ ê¸°ë ¥ì€ ìµœëŒ€ 10ê¹Œì§€ë§Œ ì¦ê°€í•©ë‹ˆë‹¤.</small>
                    </li>
                    <li>
                        <i data-feather="check-circle" class="text-success me-2" size="16"></i>
                        <small>ëˆì„ ë²Œì–´ì„œ ë” ì¢‹ì€ ì•„ì´í…œì„ êµ¬ë§¤í•´ë³´ì„¸ìš”!</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// ìƒì  ë°°ê²½ìŒì•… ì „ì—­ ë³€ìˆ˜
window.shopAudioContext = null;
window.shopBgmOscillators = [];
window.shopBgmGains = [];

function initShopAudioContext() {
    if (!window.shopAudioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
            window.shopAudioContext = new AudioContext();
            console.log('ğŸµ ìƒì  ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”');
        }
    }
    return window.shopAudioContext;
}

function startShopBackgroundMusic() {
    try {
        if (!window.shopAudioContext) {
            initShopAudioContext();
        }
        
        if (!window.shopAudioContext) {
            console.log('ì˜¤ë””ì˜¤ ì§€ì› ì•ˆë¨');
            return;
        }
        
        const shopAudioContext = window.shopAudioContext;
        
        // ê¸°ì¡´ oscillators ì •ë¦¬
        window.shopBgmOscillators.forEach(osc => {
            try { osc.stop(); } catch(e) {}
        });
        window.shopBgmOscillators = [];
        window.shopBgmGains = [];
        
        const now = shopAudioContext.currentTime;
        const masterGain = shopAudioContext.createGain();
        masterGain.gain.setValueAtTime(0.28, now);
        masterGain.connect(shopAudioContext.destination);
        
        // ìƒì ìš© ë¶€ë“œëŸ¬ìš´ ë©œë¡œë””
        const melodyFreqs = [
            261.63, 261.63, 329.63, 392.00,
            392.00, 392.00, 329.63, 261.63,
            293.66, 293.66, 349.23, 440.00,
            440.00, 440.00, 349.23, 293.66,
            329.63, 329.63, 392.00, 523.25,
            523.25, 523.25, 392.00, 329.63,
            261.63, 261.63, 329.63, 392.00,
            392.00, 329.63, 293.66, 261.63
        ];
        
        const chordFreqs = [
            [261.63, 329.63, 392.00],
            [293.66, 349.23, 440.00]
        ];
        
        const loopDuration = 16;
        
        function playMelody(loopStartTime) {
            melodyFreqs.forEach((freq, i) => {
                const noteStart = loopStartTime + i * 0.5;
                const noteDuration = 0.45;
                
                const osc = shopAudioContext.createOscillator();
                const gain = shopAudioContext.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, noteStart);
                
                gain.gain.setValueAtTime(0, noteStart);
                gain.gain.linearRampToValueAtTime(0.2, noteStart + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, noteStart + noteDuration);
                
                osc.connect(gain);
                gain.connect(masterGain);
                
                osc.start(noteStart);
                osc.stop(noteStart + noteDuration + 0.1);
                
                window.shopBgmOscillators.push(osc);
                window.shopBgmGains.push(gain);
            });
        }
        
        function playChords(loopStartTime) {
            chordFreqs.forEach((freqs, chordIdx) => {
                const chordStart = loopStartTime + chordIdx * 4;
                const chordDuration = 3.8;
                
                freqs.forEach(freq => {
                    const osc = shopAudioContext.createOscillator();
                    const gain = shopAudioContext.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, chordStart);
                    
                    gain.gain.setValueAtTime(0, chordStart);
                    gain.gain.linearRampToValueAtTime(0.12, chordStart + 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, chordStart + chordDuration);
                    
                    osc.connect(gain);
                    gain.connect(masterGain);
                    
                    osc.start(chordStart);
                    osc.stop(chordStart + chordDuration + 0.1);
                    
                    window.shopBgmOscillators.push(osc);
                    window.shopBgmGains.push(gain);
                });
            });
        }
        
        playMelody(now);
        playChords(now);
        
        const loopTimer = setInterval(() => {
            if (shopAudioContext.state === 'running') {
                playMelody(shopAudioContext.currentTime);
                playChords(shopAudioContext.currentTime);
            }
        }, loopDuration * 1000);
        
        window.shopBgmLoopTimer = loopTimer;
        console.log('ğŸµ ìƒì  ë°°ê²½ìŒì•… ì¬ìƒ ì¤‘');
    } catch(e) {
        console.log('ìƒì  ë°°ê²½ìŒì•… ì˜¤ë¥˜:', e.message || e);
    }
}

function stopShopBackgroundMusic() {
    try {
        if (window.shopBgmLoopTimer) {
            clearInterval(window.shopBgmLoopTimer);
            window.shopBgmLoopTimer = null;
        }
        
        window.shopBgmOscillators.forEach(osc => {
            try { osc.stop(); } catch(e) {}
        });
        window.shopBgmOscillators = [];
        window.shopBgmGains = [];
        
        console.log('ğŸµ ìƒì  ë°°ê²½ìŒì•… ì¢…ë£Œ');
    } catch(e) {
        console.log('ìƒì  ë°°ê²½ìŒì•… ì¤‘ì§€ ì˜¤ë¥˜:', e.message || e);
    }
}

// ì¦‰ì‹œ ì‹¤í–‰
(function() {
    startShopBackgroundMusic();
    window.addEventListener('beforeunload', stopShopBackgroundMusic);
    window.addEventListener('pagehide', stopShopBackgroundMusic);
})();
</script>
{% endblock %}
